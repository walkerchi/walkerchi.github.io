{"pageProps":{"frontmatter":{"title":"Markov Random Field","description":"Example of MRF","date":"2022-5-1","image":"https://s2.loli.net/2022/05/21/bGN47Mv6tlUy1PK.jpg"},"content":{"cells":[{"cell_type":"markdown","metadata":{},"source":"<h1>Markov Random Field for Image Segmentation</h1>"},{"cell_type":"code","execution_count":46,"metadata":{},"outputs":[],"source":"import numpy as np\nimport cv2\nimport requests \nfrom PIL import Image\nfrom io import BytesIO\nfrom tqdm import tqdm\nimport matplotlib.pyplot as plt\nIMAGE_URL = \"https://s2.loli.net/2022/05/02/5XQJM9UbFETlCtc.jpg\"\nN_CLASSES = 3\n"},{"cell_type":"code","execution_count":47,"metadata":{},"outputs":[{"data":"https://s2.loli.net/2022/05/23/JDtkN94ZisR8HP2.png","metadata":{},"type":"image/png","imageProps":{"width":515,"height":268,"blurDataURL":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAACCAYAAACQahZdAAAACXBIWXMAAA9hAAAPYQGoP6dpAAAANUlEQVQImQEqANX/AISRqv9yhqD/doaX/26WvP9fgqn/AJaGjP9ZUFX/UFRb/218kv+Oma//EesZIUpAbMMAAAAASUVORK5CYII="}}],"source":"def remote_image(url):\n    return Image.open(BytesIO(requests.get(url).content))\nimage = remote_image(IMAGE_URL)\nplt.imshow(image)\nplt.axis('off')\nplt.show()"},{"cell_type":"code","execution_count":48,"metadata":{},"outputs":[{"data":"\nx.shape:(1024, 2048, 3)\ny.shape:(1024, 2048)\n\n","type":"stream"},{"data":"https://s2.loli.net/2022/05/24/YfeKQ7VnF6IATCU.png","metadata":{},"type":"image/png","imageProps":{"width":1569,"height":372,"blurDataURL":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAADCAYAAABMFFUxAAAACXBIWXMAAA9hAAAPYQGoP6dpAAAAq0lEQVQImSXMTQvBAACA4f07STk4aOEkkmQ2B/NRDr6KDTNlyVFs2CiXUTj4WzavcHjqPb1Ca+oizS40TY/2cElpcSPTPyIbZ15BwNNycSoanmri1mY/Xv3bBsKko9FWe8QTadK5Cg3LJ9uxUY0TQRhyN23W+e5vsC0NsaURdvlPsEZTlGyBaCSGmEwhZgp0tRVX/8n7HfKYO2yKAw7VMY6ss5N19orOThnzAXrTeRSuBYHEAAAAAElFTkSuQmCC"}}],"source":"# random init label\nx = np.array(image)\ny = np.random.randint(0,N_CLASSES,size=x.shape[:-1])\n\ndef plot(x,y):\n    fig,ax = plt.subplots(1,2,figsize=(20,5))\n    ax[0].imshow(x)\n    ax[0].axis('off')\n    ax[1].matshow(y.astype(np.float32),cmap=plt.cm.Spectral)\n    ax[1].axis('off')\n    plt.show()\n\nprint(f\"\"\"\nx.shape:{x.shape}\ny.shape:{y.shape}\n\"\"\")\nplot(x,y)"},{"cell_type":"code","execution_count":49,"metadata":{},"outputs":[{"data":"https://s2.loli.net/2022/05/24/p3wHsoCk9xNFAzG.png","metadata":{},"type":"image/png","imageProps":{"width":1569,"height":372,"blurDataURL":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAADCAYAAABMFFUxAAAACXBIWXMAAA9hAAAPYQGoP6dpAAAAuklEQVQImQXBTUvCcADA4X07icBDhxD1NMZGhqUnl9aE5Rr+J+2NmtKhLGwEafhCzthhdPE7hduv55F67icXfkI3mGMMJ5w/ptStOS1vxd8hZz/+YKMLfu4eWF/7pHZI0vdYNm2ke9PB6Awon9SoKZdcRVtkM6bjfXHIc7LgnVnD4vVM8KbafN+MSPojli0LKRIubVnjqHRM5bRKpa5x6zyx2/5SFDlZGDPTLF5Uh2dFMNUEC91lZYb8A8GfeaZakXtyAAAAAElFTkSuQmCC"}}],"source":"def mrf_once(x,y,kernel_size=3):\n    '''\n        Parameters\n        ----------\n            x:[H,W,C]\n            y:[H,W]\n        Returns\n        -------\n            [H,W]\n    '''\n    EPS   = 1e-7\n    H,W,C = x.shape\n    GAMMA = 1/np.sqrt(2*np.pi)\n    x = Image.fromarray(x).convert('L').__array__()\n    y = y.astype(np.uint8)\n    kernel_shape = [kernel_size,kernel_size]\n    full_len = kernel_size ** 2\n    half_len = full_len // 2\n\n    P_y = np.zeros((N_CLASSES,H,W),dtype=np.float32)\n    P_yx= np.zeros((N_CLASSES,H,W),dtype=np.float32)\n\n    # calcuate P(y)\n    for i in range(full_len):\n        # for each neighbor\n        if i == half_len:\n            # only consider neighbor, not the node itself\n            continue\n        filter2D = np.zeros(full_len,dtype=np.float32)\n        filter2D[i] = 1\n        filter2D = filter2D.reshape(kernel_shape)\n        t = cv2.filter2D(y,-1,filter2D)\n        for j in range(N_CLASSES):\n            P_y[j] += (t==j).astype(np.float32)/(half_len*2)\n    # set where 0 to small number in case of log operation\n    P_y[P_y==0] = EPS\n\n    # calculate P(y|x)\n    for i in range(N_CLASSES):\n        mask = y == i \n        elem = x[mask]\n        mean = elem.mean()\n        var  = elem.var()\n        std  = np.sqrt(var)\n        P_yx[i] = GAMMA * np.exp(-(x-mean)**2/(2*var)) / std\n\n    P = np.log(P_y) + np.log(P_yx)\n    y = P.argmax(0)\n    return y\n\n# do  markov random field for once\nplot(x,mrf_once(x,y))"},{"cell_type":"code","execution_count":52,"metadata":{},"outputs":[{"data":"100%|\u001b[34m██████████\u001b[0m| 20/20 [00:13<00:00,  1.54it/s]\n","type":"stream"},{"data":"https://s2.loli.net/2022/05/24/LOif1YxG2yreEsQ.png","metadata":{},"type":"image/png","imageProps":{"width":1569,"height":372,"blurDataURL":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAADCAYAAABMFFUxAAAACXBIWXMAAA9hAAAPYQGoP6dpAAAAuUlEQVQImQXBS4sBAQDA8flyktSGg3cpKQdl2IN3Dl7lkcGWsclhlVcNSlNDWa+yOfoUeyc3Zv5+PyErKUTbazKdOfnqN5HuFn95Tqy14mkYbAMVrp0Gt/uRP2UKnPnfDxkIJoRmoU4+WeLD4cMXEknLGsHChGRryUvX2dV+6IltyokxUnbI7fELHLjEUghyTSIeDGMxW3E7vbj9YYr1PhvthG6AWhnx5Soh2vt82mRyHpnlYMZCUXkDJw19DZWDO50AAAAASUVORK5CYII="}}],"source":"def mrf(x,y,times=1,kernel_size=3):\n    for _ in tqdm(range(times),colour='blue'):\n        y = mrf_once(x,y,kernel_size)\n    plot(x,y)\nmrf(x,y,20)"}],"metadata":{"interpreter":{"hash":"d46bb6a1d0e60fd95c8b450a1be9fd3d29a8bdd7f09a3a7e970ffea16d669fbd"},"kernelspec":{"display_name":"Python 3.8.5 ('base')","language":"python","name":"python3"},"language_info":{"codemirror_mode":{"name":"ipython","version":3},"file_extension":".py","mimetype":"text/x-python","name":"python","nbconvert_exporter":"python","pygments_lexer":"ipython3","version":"3.8.5"},"orig_nbformat":4},"nbformat":4,"nbformat_minor":2},"renderType":"ipy","imageProps":{"src":"https://s2.loli.net/2022/05/21/bGN47Mv6tlUy1PK.jpg","width":1300,"height":873,"type":"jpg","blurDataURL":"data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAACAAQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAX/xAAfEAABAwMFAAAAAAAAAAAAAAABAAMEAgURBgcSITH/xAAUAQEAAAAAAAAAAAAAAAAAAAAF/8QAGBEAAgMAAAAAAAAAAAAAAAAAAAECMTL/2gAMAwEAAhEDEQA/AKm49itEXWM9uNa4DLeRVxbj0UjJAJOAPSe0REgqB5aZ/9k="},"language":"cn"},"__N_SSG":true}