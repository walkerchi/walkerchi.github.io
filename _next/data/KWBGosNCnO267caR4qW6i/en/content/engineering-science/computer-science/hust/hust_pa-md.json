{"pageProps":{"frontmatter":{"title":"[华科]计算机学院系统训练","description":"华中科技大学计算机学院系统训练","date":"2022-1-9","image":"https://s2.loli.net/2022/05/21/irBOsuSDxvUzG6X.png"},"content":"<h1><span style=\"text-decoration:line-through;display:inline-box\">ICS PA 2019</span> <span>HUST PA</span></h1><div class=\"math math-display\"></div><div class=\"math math-display\">f_y = \\frac{x}{y}</div><div class=\"math math-display\">\\begin{cases} f_x = x+1\\\\ f_y = \\frac{x}{y} \\end{cases}</div><hr><p><span class=\"math math-inline\">walkerchi\\cdot 2022-1-9</span></p><hr><p>照着NJU-PA做就好，<a href=\"https://zhuanlan.zhihu.com/p/413911195\">感谢汪先奇奆佬手把手入门教程</a>，整个过程非常折磨，有的时候为了实现一个简单的功能可以反汇编跟踪到了13层函数调用(没错，就是printf)。 有些库函数注释都是上个世纪70年代的，实现过程复杂繁琐，非常多无用功，源代码改进空间还是很大的。这个项目主要还是告诉我们整个计算机系统如何运行，所以过分纠结代码风格会给人带来无穷的痛苦💔。跟我一同过来交换的其他学院同学都在德国法国荷兰玩，而我把自己关在家里写PA 💩。这个Project教导我最多的不是计算机，而是如何心平气和处事🙏。定乎内外之分，辩护荣辱之境，如空无象，湛然圆满。</p><img src=\"https://s2.loli.net/2022/01/10/ohAz19NgHxL7nTQ.jpg\" style=\"zoom:30%;\" width=\"800\" height=\"800\" type=\"jpg\" blurdataurl=\"data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAEAAQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAX/xAAiEAABAwMDBQAAAAAAAAAAAAABAAMRBAUTAgYhBxIUIkH/xAAVAQEBAAAAAAAAAAAAAAAAAAACA//EABcRAQEBAQAAAAAAAAAAAAAAAAECACH/2gAMAwEAAhEDEQA/AJG1+rt/on78PHoHw7dX3RmzHHMDt0w4PUR9k8nlERSiZDhmrv/Z\"><hr><h2>0.PA0 环境配置</h2><p>这个项目在 WSL2 Ubuntu20.04 上完成，会遇到很多坑，毕竟WSL不是真正的虚拟机。</p><h3>0.0克隆仓库</h3><p>这一步在校外的同学需要通过学校VPN链接。 在做PA时我人在德国，幸好之前为了做科研办过VPN，现在就方便一些。</p><pre><code>git clone https://course.cunok.cn/pa/ics2019_1.git/\n</code></pre><p>在阅读Makefile源代码后我们可以发现在每次make后都会自动更新到git仓库，十分方便。但同时这也意味着Makefile错综复杂，牵一发而动全身。</p><h3>0.1配置环境变量</h3><pre><code class=\"language-bash\">export STUID=UXXXXXXXXX              #学号，用于提交\nexport STUNAME=XXX                   #姓名，用于提交\nexport ICS_HOME=./ics2019            #ics2019 根目录位置，方便修改目录位置\nexport NANO_HOME=ICS_HOME/nanos-lite #nanos-lite 简易操作系统 文件夹位置\nexport NAVY_HOME=ICS_HOME/navy-apps  #navy-apps 运行软件 文件夹爱位置\nexport NEMU_HOME=ICS_HOME/nemu       #nemu 简易指令集 文件夹位置\nexport AM_HOME=ICS_HOME/nexus-am     #nexus-am 简易裸机 文件夹位置 \n</code></pre><p>建议写在<strong>~/.bashrc</strong>中</p><h2>1.PA1 NEMU入门</h2><h3>1.1.简易调试器</h3><p>这里只用简单阅读一下 <code>nemu/src/monitor/debug/*</code> 的代码并补全就好。</p><p>不过在<code>info r</code>指令中需要用到 <code>nemu/src/isa/riscv32/reg.c</code>中的<code>isa_reg_display</code>函数，这个函数得自己补全。</p><p>这个后面好像没怎么用到，可能是我打开的方式不对😅</p><p>最难的莫过于p的实现，考验一些编译原理，简单的表达式可以使用逆波兰式的求解方法，但是这个需要支持寄存器与指针访问，所以不同，必须按照文档上使用递归求解。</p><table><thead><tr><th align=\"center\">命令</th><th align=\"center\">说明</th></tr></thead><tbody><tr><td align=\"center\">help</td><td align=\"center\">帮助</td></tr><tr><td align=\"center\">c</td><td align=\"center\">继续运行</td></tr><tr><td align=\"center\">q</td><td align=\"center\">退出</td></tr><tr><td align=\"center\">si [N]</td><td align=\"center\">单步执行N步，默认为1</td></tr><tr><td align=\"center\">info r/w</td><td align=\"center\">打印寄存器/监视点信息</td></tr><tr><td align=\"center\">p EXPR</td><td align=\"center\">求出表达式EXPR值</td></tr><tr><td align=\"center\">x N EXPR</td><td align=\"center\">从EXPR开始打印内存N个字长值</td></tr><tr><td align=\"center\">d N</td><td align=\"center\">删除序号为N的监视点</td></tr><tr><td align=\"center\">w EXPR</td><td align=\"center\">当EXPR为true时程序暂停</td></tr></tbody></table><h3>1.2.测试</h3><p><code>nemu/</code>目录下 <code>make ISA=$ISA run</code></p><h3>1.3.注意事项</h3><ol start=\"0\"><li>学会阅读Makefile，在做PA1、PA2的时候后，我遇到的大部分是Makefile报错，由于之前没有注意在意语言，所以花了很多功夫来学习Makefile.(😅论一个有包管理器和项目管理器语言的重要性，这里推荐RUST、GO、JS，Python就算了，比同为动态语言的JS效率低到不知道哪里去了，除非你numba或者cython很溜，希望华科以后出一个更friendly一点的完爆南大)</li><li>第一次make会遇到包未安装的情况，按照google上一项一项解决就好了</li><li>RTFM <strong>R</strong>ead <strong>T</strong>he <strong>F</strong>ucking <strong>M</strong>anual 很多关键问题文档上一带而过，然后放一句RTFM让人读手册，给我TM整无语了😅，多说两句话又不是少几年寿命。</li></ol><hr><h2>2.PA2 NEMU+NEXUS-AM</h2><p>这个就是实打实的实现RISCV32了，逐渐开始硬核。因为C没有接口（虚类、虚函数），所以需要通过一系列让我我开眼的宏定义来达到类似的效果。</p><p>这里说一下主要的运行流程。<code>nemu/src/monitor/monitor.c</code>中的<code>cpu_exec</code>调用了<code>nemu/src/cpu/cpu.c</code>中的<code>exec_once</code>，这个函数又调用了<code>nemu/src/isa/riscv32/exec/exec.c</code>中的<code>void isa_exec(vaddr_t *pc)</code>, 该函数中的主要执行函数<code>static inline void idex(vaddr_t *pc, OpcodeEntry *e)</code>和宏<code>IDEX</code>都定义在<code>nemu/include/cpu/exec.h</code>中。</p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"724.75\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:1134.203125px\" viewBox=\"0 0 1134.203 724.75\"><defs><path id=\"b\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(567.102 362.375)\"><rect width=\"1118.203\" height=\"708.75\" x=\"-559.102\" y=\"-354.375\" fill=\"#a9a9a9\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"39.5\" height=\"19\" transform=\"translate(0 -340.375) translate(-19.75 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nemu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(126.68 294.25)\"><rect width=\"187.359\" height=\"149\" x=\"-93.68\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"56.328\" height=\"19\" transform=\"translate(0 -60.5) translate(-28.164 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">monitor</div></foreignObject></g><g opacity=\"1\" transform=\"translate(685.781 233.375)\"><rect width=\"830.844\" height=\"410.75\" x=\"-415.422\" y=\"-205.375\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"20.625\" height=\"19\" transform=\"translate(0 -191.375) translate(-10.313 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(949.281 577.75)\"><rect width=\"303.844\" height=\"238\" x=\"-151.922\" y=\"-119\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"86.297\" height=\"19\" transform=\"translate(0 -105) translate(-43.148 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">include/cpu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(949.281 577.75)\"><rect width=\"253.844\" height=\"198\" x=\"-126.922\" y=\"-99\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"48.016\" height=\"19\" transform=\"translate(0 -85) translate(-24.008 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">exec.h</div></foreignObject></g><g opacity=\"1\" transform=\"translate(393.242 294.25)\"><rect width=\"195.766\" height=\"149\" x=\"-97.883\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"25.578\" height=\"19\" transform=\"translate(0 -60.5) translate(-12.79 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cpu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(808.664 233.375)\"><rect width=\"535.078\" height=\"370.75\" x=\"-267.539\" y=\"-185.375\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"77.641\" height=\"19\" transform=\"translate(0 -171.375) translate(-38.82 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">isa/riscv32</div></foreignObject></g><g opacity=\"1\" transform=\"translate(656.742 233.375)\"><rect width=\"181.234\" height=\"330.75\" x=\"-90.617\" y=\"-165.375\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"33.391\" height=\"19\" transform=\"translate(0 -151.375) translate(-16.695 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">exec</div></foreignObject></g><g opacity=\"1\" transform=\"translate(949.281 128)\"><rect width=\"203.844\" height=\"109\" x=\"-101.922\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"56.859\" height=\"19\" transform=\"translate(0 -40.5) translate(-28.43 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">docde.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(949.281 257)\"><rect width=\"203.844\" height=\"109\" x=\"-101.922\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"68.547\" height=\"19\" transform=\"translate(0 -40.5) translate(-34.273 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">all-instr.h</div></foreignObject></g><g opacity=\"1\" transform=\"translate(656.742 233.375)\"><rect width=\"131.234\" height=\"290.75\" x=\"-65.617\" y=\"-145.375\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"47.188\" height=\"19\" transform=\"translate(0 -131.375) translate(-23.594 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">exec.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(393.242 294.25)\"><rect width=\"145.766\" height=\"109\" x=\"-72.883\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"39.375\" height=\"19\" transform=\"translate(0 -40.5) translate(-19.688 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cpu.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(126.68 294.25)\"><rect width=\"137.359\" height=\"109\" x=\"-68.68\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"67.984\" height=\"19\" transform=\"translate(0 -40.5) translate(-33.992 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">monitor.c</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M170.36 294.25h174.999\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"M441.125 294.25h175\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#d)\" d=\"m664.439 274.75 9.653-24.458c9.654-24.459 28.96-73.375 42.78-97.834C730.693 128 739.027 128 747.36 128h125\"/><defs><marker id=\"d\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#e)\" d=\"m691.092 274.75 5.211-2.958c5.212-2.959 15.634-8.875 25.012-11.834C730.693 257 739.026 257 747.359 257h125.625\"/><defs><marker id=\"e\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#f)\" d=\"m691.092 313.75 5.211 2.958c5.212 2.959 15.634 8.875 25.012 11.834 9.378 2.958 17.711 2.958 26.044 2.958h75c8.334 0 16.667 0 36.179 30.375s50.202 91.125 65.547 121.5l15.345 30.375\"/><defs><marker id=\"f\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#g)\" d=\"m679.092 313.75 7.211 6.292c7.212 6.291 21.634 18.875 33.012 25.166 11.378 6.292 19.711 6.292 28.044 6.292h75c8.334 0 16.667 0 36.597 41.875s51.458 125.625 67.221 167.5l15.764 41.875\"/><defs><marker id=\"g\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(949.281 533.25)\"><rect width=\"50.219\" height=\"39\" x=\"-25.109\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"30.219\" height=\"19\" transform=\"translate(-15.11 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">idex</div></foreignObject></g><g opacity=\"1\" transform=\"translate(949.281 622.25)\"><rect width=\"51.75\" height=\"39\" x=\"-25.875\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"31.75\" height=\"19\" transform=\"translate(-15.875 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">IDEX</div></foreignObject></g><g opacity=\"1\" transform=\"translate(949.281 257)\"><rect width=\"152.594\" height=\"39\" x=\"-76.297\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"132.594\" height=\"19\" transform=\"translate(-66.297 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">make_EHelper(...)</div></foreignObject></g><g opacity=\"1\" transform=\"translate(949.281 128)\"><rect width=\"153.844\" height=\"39\" x=\"-76.922\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"133.844\" height=\"19\" transform=\"translate(-66.922 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">make_DHelper(...)</div></foreignObject></g><g opacity=\"1\" transform=\"translate(656.742 294.25)\"><rect width=\"81.234\" height=\"39\" x=\"-40.617\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"61.234\" height=\"19\" transform=\"translate(-30.617 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">isa_exec</div></foreignObject></g><g opacity=\"1\" transform=\"translate(393.242 294.25)\"><rect width=\"95.766\" height=\"39\" x=\"-47.883\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"75.766\" height=\"19\" transform=\"translate(-37.883 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">exec_once</div></foreignObject></g><g opacity=\"1\" transform=\"translate(126.68 294.25)\"><rect width=\"87.359\" height=\"39\" x=\"-43.68\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"67.359\" height=\"19\" transform=\"translate(-33.68 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cpu_exec</div></foreignObject></g></svg></p><p>取址阶段已经在<code>void isa_exec(vaddr_t *pc)</code>中帮我们实现好了，我们只需要实现所有指令的译码和执行就可以了。为了使用我们在译码和执行定义的函数，我们也需要对<code>nemu/src/isa/riscv32/exec/exec.c</code>中的分发也就是<code>static OpcodeEntry opcode_table</code>进行修改</p><p>这里放上所有需要实现的指令以供参考。</p><p><img src=\"https://s2.loli.net/2022/01/09/5VrksKp3RI4MedH.png\" alt=\"\" width=\"659\" height=\"875\" type=\"png\" blurdataurl=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAAECAIAAADETxJQAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAJElEQVQImSXIQQ0AQBCDQOygsH5qtJfc8ppAWzUJJxUgP7bdeBF/DOUBCQ23AAAAAElFTkSuQmCC\"></p><p><img src=\"https://s2.loli.net/2022/01/09/R7MOlTpjz1unV2I.png\" alt=\"\" width=\"1127\" height=\"342\" type=\"png\" blurdataurl=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAABCAIAAAB2XpiaAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAFUlEQVQImWOwtrH5////3r17GRgYACq4BegA1rRlAAAAAElFTkSuQmCC\"></p><h3>2.1.ID译码</h3><p><strong>NEMU</strong>的译码主要通过<code>nemu/src/isa/riscv32/decode.c</code>来实现。</p><p>在<code>enmu/src/isa/riscv32/exec/exec.c</code>中<code>opcode_table</code>数组的每一个<code>IDEX</code>（不为<code>EMPTY</code>）都调用了译码函数（第一个参数）和执行函数（第二个参数）</p><p>其中比较费解的是<code>make_DHelper</code>，这个宏是为了保证函数接口的一致，在<code>nemu/include/cpu/decode.h</code>中定义的，函数输入接口为<code>(vaddr *pc)</code></p><p><img src=\"https://s2.loli.net/2022/01/09/gjC64M837ZRzywB.png\" alt=\"RISCV32-TPYE\" width=\"1164\" height=\"388\" type=\"png\" blurdataurl=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAABCAIAAAB2XpiaAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAEklEQVQImWNYBAYMDAz///8HACoZBsr6y/UfAAAAAElFTkSuQmCC\"></p><p>RISCV32 指令可以大致分为<span class=\"math math-inline\">R,I,S,B,U,J</span>五种指令，但是这些指令有些变体，所以在<code>nemu/src/isa/riscv32/decode.c</code>中追加实现时需要更多的函数</p><h3>2.2.EX执行</h3><p><strong>NEMU</strong>的执行分散到了<code>nemu/src/isa/riscv32/exec</code>文件夹下的所有文件里，在<code>all-instr.h</code>里进行声明，剩下的<code>*.c</code>文件里看个人喜好填写函数实现，可以全部写在一个文件里，也可以按照功能进行分类。与<code>make_DHelper</code>类似，<code>make_EHelper</code>被定义在<code>nemu/include/cpu/exec.h</code>中</p><p>在这里我认为需要解释一下<code>rtl_lr</code>和<code>rtl_sr</code>两个函数，他们分别定义在<code>nemu/src/isa/riscv32/include/isa/rtl.h</code>文件中，主要作用是对对应序号的寄存器做<span class=\"math math-inline\">load</span>或者<span class=\"math math-inline\">save</span>操作，这样可以保证寄存器内数据的安全。</p><p>有的结果不能一次得到，因此往往通过中间寄存器<code>s0</code>来暂存。</p><p>在实现CSR寄存器时，由于没有看RISCV32手册，都是通过反汇编来观察的，总结出来了一下规律：</p><table><thead><tr><th align=\"center\">CSR寄存器</th><th align=\"center\">CSR寄存器序号</th></tr></thead><tbody><tr><td align=\"center\">SSTATUS</td><td align=\"center\">0x100</td></tr><tr><td align=\"center\">STVEC</td><td align=\"center\">0x105</td></tr><tr><td align=\"center\">SEPC</td><td align=\"center\">0x141</td></tr><tr><td align=\"center\">SCAUSE</td><td align=\"center\">0x142</td></tr><tr><td align=\"center\">SATP</td><td align=\"center\">0x180</td></tr></tbody></table><p>关于CSR指令，网上资料少而散，而且有的有误导，这里我统一整理一下。</p><p>首先，CSR指令都是I型指令，这里的对CSRR的索引是找CSR寄存器序号对应的CSR寄存器，因此还需要自己实现序号和寄存器之间映射的函数。</p><ol><li><p><code>csrrw imm rd rs1</code></p><p><code>CSRR[imm]->rd, rs1->CSRR[imm]</code></p></li><li><p><code>csrrs imm rd rs1</code></p><p><code>CSRR[imm]->rd, rs1|CSRR[imm]->CSRR[imm]</code></p></li><li><p><code>csrrc</code></p><p><code>CSRR[imm]->rd, (~rs1)&#x26;CSRR[imm]->CSRR[imm]</code></p></li><li><p><code>csrrwi imm1 rd imm2</code></p><p><code>CSRR[imm1]->rd, imm2->CSRR[imm1]</code></p></li><li><p><code>csrrsi imm1 rd imm2</code></p><p><code>CSRR[imm1]->rd, imm2|CSRR[imm1]->CSRR[imm1]</code></p></li><li><p><code>csrrci imm1 rd imm2</code></p><p><code>CSRR[imm1]->rd, (~imm2)&#x26;CSRR[imm1]->CSRR[imm1]</code></p></li><li><p><code>ecall</code></p><p><code>pc+4->CSRR[SEPC], a7->CSRR[SCAUSE], CSRR[STVEC]->pc</code></p></li><li><p><code>sret</code></p><p><code>CSRR[SEPC]->pc</code></p></li></ol><p>注意，<code>nemu/src/isa/riscv32/include/isa/reg.h</code>和<code>nemu/src/isa/riscv32/reg.c</code>都没有实现<code>CSR</code>寄存器，需要自己补上去</p><h3>2.3.输入输出</h3><p>这里需要分别实现键盘、计时器和视频的IO，他们在文件夹<code>nexus-am/am/src/nemu-common</code>文件夹下，分别为<code>nemu-input.c</code>，<code>nemu-timer.c</code>和<code>nemu-video.c</code></p><p><code>nexus-am/am/src/nemu-common/ioe.c</code>中的<code>_io_read</code>和<code>_io_write</code>函数会转发信息到以上的三个函数。</p><p>值得注意的是，因为我是用的Vscode--RemoteWSL--WSL2的开发模式，所以SDL库是无法检测到键盘信息的，我还特意写了一段代码进行测试。如果你同样使用的WSL2，请下载远程桌面，通过桌面进行调试，我是用的是vnc+xrdp.</p><ol><li><strong><code>size_t __am_input_read(uintptr_t reg, void *buf, size_t size)</code></strong></li></ol><p>​ 在<code>nemu-input.c</code>中我们不需要考虑键盘的掩码，只需要从<code>0xa1000060</code>读出值，判断是否为空和赋 值就好了。</p><ol start=\"2\"><li><strong><code>size_t __am_timer_read(uintptr_t reg, void *buf, size_t size)</code></strong></li></ol><p>​ 在<code>nemu-timer.c</code>中只需要实现<code>_DEVERG_TIMER_UPTIME</code>的情况，从<code>0xa1000048</code>读出时间，减去开机 时间赋值给<code>uptime->lo</code>就可以了。</p><ol start=\"3\"><li><strong><code>size_t __am_video_read(uintptr_t reg, void *buf, size_t size)</code></strong></li></ol><p>​ 在<code>nemu-video.c</code>中是个画矩形函数，将矩形对应位置的图像信息写入 <code>0xa0000000</code>。这个个人感觉 非常低效，使得后面PA3的接口调用效率大大降低。</p><h3>2.4 klib</h3><p>​\t为了保证测试的顺利，还需要实现<code>nexus-am/libs/klib/src</code>下的一些函数</p><p><strong><code>nexus-am/libs/klib/src/stdio.c</code></strong></p><ol><li><p><code>int my_printf(const char *fmt, ...)</code></p><p>我就直接调用<code>my_vsprintf</code>了</p></li><li><p><code>int my_vsprintf(char *out, const char *fmt, va_list ap)</code></p><p>直接上代码</p><pre><code class=\"language-c\">int itoa_helper(char *out, int ptr, uint32_t valint, int base){\n  assert(valint>=0);\n  int stack[128],sptr=0;\n  if(valint==0)out[ptr++]='0';\n  else{\n    for(;valint;stack[sptr++]=valint%base,valint=valint/base);\n    for(--sptr;sptr>=0;--sptr){\n      if(stack[sptr]&#x3C;10)out[ptr++]=stack[sptr]+'0';\n      else if(stack[sptr]&#x3C;16)out[ptr++]=stack[sptr]-10+'a';\n      else{\n        assert(0);\n      }\n    }\n  }\n  return ptr;\n}\nint my_vsprintf(char *out, const char *fmt, va_list ap) {\n  int ptr=0;\n  for(;*fmt;++fmt){\n    if(*fmt!='%')out[ptr++]=*fmt;\n    else{\n      switch(*(++fmt)){\n        case 'c':{\n          char c = va_arg(ap,int);\n          out[ptr++]=c;\n          break;\n        }\n        case 'd':{\n          int valint=va_arg(ap,int);\n          if(valint&#x3C;0){\n            out[ptr++]='-';\n            valint=-valint;\n          }\n          ptr = itoa_helper(out,ptr,valint,10);\n          break;\n        }\n        case 'x':{\n          uint32_t valint=va_arg(ap,uint32_t);\n          ptr = itoa_helper(out,ptr,valint,16);\n          break;\n        }\n        case 's':{\n          const char* valstr=va_arg(ap,char*);\n          for(;*valstr;out[ptr++]=*valstr++);\n          break;\n        }\n        case 'f':{\n          float valflt=va_arg(ap,float);\n          if(valflt&#x3C;0){\n            out[ptr++]='-';\n            valflt=-valflt;\n          }\n          int tmpint=(int)valflt;\n          int tmpflt=(int)(10000*(valflt-tmpint));\n          ptr=itoa_helper(out,ptr,tmpint,10);\n          out[ptr++]='.';\n          ptr=itoa_helper(out,ptr,tmpflt,10);\n          break;\n        }\n        default:{\n          out[ptr++]='%';\n          out[ptr++]=*fmt;\n          break;\n        }\n      }\n    }\n  }\n  out[ptr]=0;\n  return ptr;\n}\n</code></pre></li><li><p><code>int my_sprintf(char *out, const char *fmt, ...)</code></p></li><li><p><code>int my_snprintf(char *out, size_t n, const char *fmt, ...)</code></p></li></ol><p><strong><code>nexus-am/libs/klib/src/string.c</code></strong></p><ol><li><p><code>size_t my_strlen(const char *s)</code></p></li><li><p><code>char *my_strcpy(char* dst,const char* src)</code></p></li><li><p><code>char* my_strncpy(char* dst, const char* src, size_t n)</code></p></li><li><p><code>char* my_strcat(char* dst, const char* src)</code></p></li><li><p><code>int my_strcmp(const char* s1, const char* s2)</code></p></li><li><p><code>int my_strncmp(const char* s1, const char* s2, size_t n)</code></p></li><li><p><code>void* my_memset(void* v,int c,size_t n)</code></p><p>可以循环展开，也可以把一个字节变成四字节，太慢了这个函数，网上有超越原版c语言<code>memset</code>的写法</p></li><li><p><code>void* my_memcpy(void* out, const void* in, size_t n)</code></p><p>同上</p></li><li><p><code>void* my_memcpy(void* out, const void* in, size_t n)</code></p></li><li><p><code>int my_memcmp(const void* s1, const void* s2, size_t n)</code></p></li></ol><h3>2.5.测试</h3><ol><li><p>在<code>nexus-am/tests/cputest</code> 中执行<code>make ALL=xxx run</code>来测试cpu的运行的正确性,这里的<code>xxx</code>可以使<code>nexus-am/tests/cputest/tests</code>目录下的任何一个名字。</p></li><li><p>在<code>nexus-am/tests/amtest/</code>中执行<code>make ARCH=native mainargs=H run</code>来测试输入输出的正确性，其中<code>mainargs</code>的参数可以根据测试的项目相应修改，也可以在<code>nemu/</code>目录下运行<code>bash runall.sh ISA=riscv32</code>来进行批测试。</p></li><li><p>在<code>nexus-am/apps/*</code>文件夹下有各种测试可以进入文件夹运行<code>make run</code>来测试程序</p></li></ol><h3>2.5.注意事项</h3><ol><li>使用WSL2的同学需要安装远程桌面来解决SDL转发的问题，目前不知道如何通过Vscode 的RemoteWSL转发</li><li><code>nemu/src/isa/riscv32/include/isa/reg.h</code>和<code>nemu/src/isa/riscv32/reg.c</code>都没有实现<code>CSR</code>寄存器，需要自己补上去</li></ol><hr><h2>3.PA3 Nanos-Lite</h2><h3>3.1.系统调用</h3><p>首先在<code>nanos-lite/</code>目录下运行<code>make ARCH=riscv32 run</code>试一下（注意开<code>nemu/include/common.h</code>中的<code>DEBUG</code>，这样我们就可以打印日志来debug了）。通过观察<code>nanos-lite/nemu-log.txt</code>和<code>nanos-lite-riscv32-nemu.txt</code>以及<code>ramdisk.asm</code>来进行debug。</p><p><strong>编译过程</strong>这里说一下主要的编译流程<code>nanos-lite/build/nano-lite-riscv32-nemu.txt</code>作为操作系统会运行<code>nanos-lite/build/ramdisk.asm</code>中的程序，通过观察<code>nanos-lite/Makefile</code>可以发现，每次<code>make ARCH=riscv32 run</code>会编译<code>navy-apps/tests/*</code>和<code>navy-apps/apps/*</code>并放入<code>navy-apps/fsimg</code>，然后全部copy过来作为<code>nanos-lite/build/ramdisk.img</code>，我们可以使用这个riscv工具链来反汇编<code>nanos-lite/build/ramdisk.img</code>来查看内容</p><pre><code class=\"language-bash\">riscv64-unknown-elf-objdump -d nanos-lite/build/ramdisk.img > nanos-lite/build/ramdisk.asm\n</code></pre><p><strong>运行过程</strong>再来说一下运行流程，首先<code>nexus-am/am/src/riscv32/nemu/boot/start.S</code>会运行<code>_start</code>函数，这个函数会跳转到<code>nexus-am/am/src/riscv32/nemu-common/trm.c</code>的<code>void _trm_init()</code>，这个函数会调用<code>nanos-lite/src/main.c</code>中的<code>int main(const char *args)</code>，也就是<strong>NANOS</strong>的入口。在完成一些列初始化时，在<code>nanos-lite/src/proc.c</code>中的<code>void init_proc()</code>开始从<code>ramdisk.img</code>装载程序，并跳转该程序进行执行。</p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"245\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:1134.71875px\" viewBox=\"0 0 1134.719 245\"><defs><path id=\"b\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(1063.781 122.5)\"><rect width=\"125.875\" height=\"149\" x=\"-62.938\" y=\"-74.5\" fill=\"#7fffd4\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.469\" height=\"19\" transform=\"translate(0 -60.5) translate(-35.734 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">navy-apps</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1063.781 122.5)\"><rect width=\"75.875\" height=\"109\" x=\"-37.938\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"34.375\" height=\"19\" transform=\"translate(0 -40.5) translate(-17.188 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">tests</div></foreignObject></g><g opacity=\"1\" transform=\"translate(756.219 122.5)\"><rect width=\"389.25\" height=\"189\" x=\"-194.625\" y=\"-94.5\" fill=\"coral\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.188\" height=\"19\" transform=\"translate(0 -80.5) translate(-35.594 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nanos-lite</div></foreignObject></g><g opacity=\"1\" transform=\"translate(756.219 122.5)\"><rect width=\"339.25\" height=\"149\" x=\"-169.625\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"20.625\" height=\"19\" transform=\"translate(0 -60.5) translate(-10.313 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(664.094 122.5)\"><rect width=\"105\" height=\"109\" x=\"-52.5\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"48.797\" height=\"19\" transform=\"translate(0 -40.5) translate(-24.398 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">main.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(833.719 122.5)\"><rect width=\"134.25\" height=\"109\" x=\"-67.125\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"45.438\" height=\"19\" transform=\"translate(0 -40.5) translate(-22.719 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">proc.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(259.797 122.5)\"><rect width=\"503.594\" height=\"229\" x=\"-251.797\" y=\"-114.5\" fill=\"#6495ed\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"68.266\" height=\"19\" transform=\"translate(0 -100.5) translate(-34.133 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nexus-am</div></foreignObject></g><g opacity=\"1\" transform=\"translate(259.797 122.5)\"><rect width=\"453.594\" height=\"189\" x=\"-226.797\" y=\"-94.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"50.703\" height=\"19\" transform=\"translate(0 -80.5) translate(-25.352 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">am/src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(139.094 122.5)\"><rect width=\"162.188\" height=\"149\" x=\"-81.094\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"138.5\" height=\"19\" transform=\"translate(0 -60.5) translate(-69.25 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">riscv32/nemu/boot</div></foreignObject></g><g opacity=\"1\" transform=\"translate(365.89 122.5)\"><rect width=\"191.406\" height=\"149\" x=\"-95.703\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"105.766\" height=\"19\" transform=\"translate(0 -60.5) translate(-52.883 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nemu-common</div></foreignObject></g><g opacity=\"1\" transform=\"translate(365.89 122.5)\"><rect width=\"141.406\" height=\"109\" x=\"-70.703\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"39.641\" height=\"19\" transform=\"translate(0 -40.5) translate(-19.82 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">trm.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(139.094 122.5)\"><rect width=\"112.188\" height=\"109\" x=\"-56.094\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"47.359\" height=\"19\" transform=\"translate(0 -40.5) translate(-23.68 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">start.S</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M170.188 122.5h149.999\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"M411.594 122.5h225\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#d)\" d=\"M691.594 122.5h100\"/><defs><marker id=\"d\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#e)\" d=\"M875.844 122.5h175\"/><defs><marker id=\"e\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(1063.781 122.5)\"><rect width=\"25.875\" height=\"39\" x=\"-12.938\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"5.875\" height=\"19\" transform=\"translate(-2.938 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">*</div></foreignObject></g><g opacity=\"1\" transform=\"translate(833.719 122.5)\"><rect width=\"84.25\" height=\"39\" x=\"-42.125\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"64.25\" height=\"19\" transform=\"translate(-32.125 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">init_proc</div></foreignObject></g><g opacity=\"1\" transform=\"translate(664.094 122.5)\"><rect width=\"55\" height=\"39\" x=\"-27.5\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"35\" height=\"19\" transform=\"translate(-17.5 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">main</div></foreignObject></g><g opacity=\"1\" transform=\"translate(365.89 122.5)\"><rect width=\"91.406\" height=\"39\" x=\"-45.703\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"71.406\" height=\"19\" transform=\"translate(-35.703 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_trim_init</div></foreignObject></g><g opacity=\"1\" transform=\"translate(139.094 122.5)\"><rect width=\"62.188\" height=\"39\" x=\"-31.094\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"42.188\" height=\"19\" transform=\"translate(-21.094 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_start</div></foreignObject></g></svg></p><p><strong>系统调用过程</strong>在<code>ramdisk.img</code>中的程序使用系统调用时，一般是<code>navy-apps/libs/libc</code>中的库函数，这些函数会经过层层绕绕后调用<code>navy-apps/libs/libos/src/nanos.c</code>中的一些函数，这些函数都会调用<code>intptr_t _syscall_(intptr_t type, intptr_t a0, intptr_t a1, intptr_t a2)</code>，这个函数会对寄存器进行赋值并执行<code>ecall</code>。然后会进入<code>nexus-am/am/src/riscv32/nemu/trap.S</code>的<code>__am_asm_trap</code>函数，这个函数会将所有寄存器压栈，并将栈顶作为参数调用<code>nexus-am/am/src/riscv32/nemu/cte.c</code>中的<code>__am_irq_handle</code>，这个函数会调用在<strong>NANOS</strong>中定义的<code>user_handler</code>也就是<code>nanos-lite/src/irq.c</code>中的<code>static _Context* do_event(_Event e, _Context* c)</code>函数，这个函数又会调用<code>nanos-lite/src/syscall.c</code>中的<code>_Context* do_syscall(_Context* c)</code>函数来在操作系统层面处理。</p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"917\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:1670.703125px\" viewBox=\"0 0 1670.703 917\"><defs><path id=\"b\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(1448.32 458.5)\"><rect width=\"428.766\" height=\"189\" x=\"-214.383\" y=\"-94.5\" fill=\"coral\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.188\" height=\"19\" transform=\"translate(0 -80.5) translate(-35.594 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nanos-lite</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1448.32 458.5)\"><rect width=\"378.766\" height=\"149\" x=\"-189.383\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"20.625\" height=\"19\" transform=\"translate(0 -60.5) translate(-10.313 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1352.07 458.5)\"><rect width=\"136.266\" height=\"109\" x=\"-68.133\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"33.5\" height=\"19\" transform=\"translate(0 -40.5) translate(-16.75 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">irq.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1541.453 458.5)\"><rect width=\"142.5\" height=\"109\" x=\"-71.25\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"60.406\" height=\"19\" transform=\"translate(0 -40.5) translate(-30.203 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">syscall.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(920.688 458.5)\"><rect width=\"526.5\" height=\"189\" x=\"-263.25\" y=\"-94.5\" fill=\"#6495ed\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"68.266\" height=\"19\" transform=\"translate(0 -80.5) translate(-34.133 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nexus-am</div></foreignObject></g><g opacity=\"1\" transform=\"translate(920.688 458.5)\"><rect width=\"476.5\" height=\"149\" x=\"-238.25\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"156.766\" height=\"19\" transform=\"translate(0 -60.5) translate(-78.383 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">am/src/riscv32/nemu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(799.086 458.5)\"><rect width=\"183.297\" height=\"109\" x=\"-91.648\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"43.453\" height=\"19\" transform=\"translate(0 -40.5) translate(-21.727 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">trap.S</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1037.336 458.5)\"><rect width=\"193.203\" height=\"109\" x=\"-96.602\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"36.797\" height=\"19\" transform=\"translate(0 -40.5) translate(-18.398 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cte.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(307.719 458.5)\"><rect width=\"599.438\" height=\"901\" x=\"-299.719\" y=\"-450.5\" fill=\"#7fffd4\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.469\" height=\"19\" transform=\"translate(0 -436.5) translate(-35.734 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">navy-apps</div></foreignObject></g><g opacity=\"1\" transform=\"translate(307.719 458.5)\"><rect width=\"549.438\" height=\"861\" x=\"-274.719\" y=\"-430.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"24.672\" height=\"19\" transform=\"translate(0 -416.5) translate(-12.336 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">libs</div></foreignObject></g><g opacity=\"1\" transform=\"translate(151.852 444.875)\"><rect width=\"187.703\" height=\"779.25\" x=\"-93.852\" y=\"-389.625\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"26.125\" height=\"19\" transform=\"translate(0 -375.625) translate(-13.063 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">libc</div></foreignObject></g><g opacity=\"1\" transform=\"translate(426.57 458.5)\"><rect width=\"261.734\" height=\"821\" x=\"-130.867\" y=\"-410.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"33.266\" height=\"19\" transform=\"translate(0 -396.5) translate(-16.633 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">libos</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"m157.14 429 14.761-54.417c14.76-54.416 44.281-163.25 63.208-217.666 18.927-54.417 27.26-54.417 35.594-54.417H331.852\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"m158.973 429 14.455-39.583c14.455-39.584 43.365-118.75 61.987-158.334C254.036 191.5 262.37 191.5 270.703 191.5h57.492\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#d)\" d=\"m162.745 429 13.826-24.75c13.827-24.75 41.48-74.25 59.472-99 17.993-24.75 26.327-24.75 34.66-24.75h56.094\"/><defs><marker id=\"d\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#e)\" d=\"m175.017 429 11.781-9.917c11.781-9.916 35.343-29.75 51.29-39.666 15.948-9.917 24.282-9.917 32.615-9.917h60.133\"/><defs><marker id=\"e\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#f)\" d=\"m220.703 455.836 4.167.444c4.166.444 12.5 1.332 20.833 1.776 8.333.444 16.667.444 25 .444h58.844\"/><defs><marker id=\"f\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#g)\" d=\"m170.337 468 12.561 13.25c12.561 13.25 37.683 39.75 54.41 53 16.728 13.25 25.062 13.25 33.395 13.25h56.758\"/><defs><marker id=\"g\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#h)\" d=\"m161.586 468 14.02 28.083c14.02 28.084 42.058 84.25 60.244 112.334 18.186 28.083 26.52 28.083 34.853 28.083H327.321\"/><defs><marker id=\"h\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#i)\" d=\"M158.458 468 173 510.917c14.541 42.916 43.623 128.75 62.33 171.666 18.707 42.917 27.04 42.917 35.374 42.917h50\"/><defs><marker id=\"i\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#j)\" d=\"m156.852 468 14.808 57.75c14.809 57.75 44.426 173.25 63.401 231s27.309 57.75 35.642 57.75h66.164\"/><defs><marker id=\"j\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#k)\" d=\"M387.898 102.5h6.025c6.025 0 18.074 0 34.606 56.083 16.532 56.084 37.546 168.25 48.053 224.334L487.089 439\"/><defs><marker id=\"k\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#l)\" d=\"M391.555 191.5h5.415c5.415 0 16.246 0 31.966 41.25 15.719 41.25 36.327 123.75 46.631 165L485.871 439\"/><defs><marker id=\"l\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#m)\" d=\"M392.953 280.5h5.182c5.183 0 15.547 0 30.628 26.417 15.08 26.416 34.876 79.25 44.775 105.666L483.436 439\"/><defs><marker id=\"m\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#n)\" d=\"M388.914 369.5h5.856c5.855 0 17.566 0 32.102 11.583 14.536 11.584 31.896 34.75 40.577 46.334l8.68 11.583\"/><defs><marker id=\"n\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#o)\" d=\"M390.203 458.5H449.047\"/><defs><marker id=\"o\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#p)\" d=\"M392.29 547.5h5.292c5.293 0 15.879 0 29.852-11.583 13.974-11.584 31.334-34.75 40.015-46.334l8.68-11.583\"/><defs><marker id=\"p\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#q)\" d=\"M392.43 636.5h5.27c5.269 0 15.808 0 30.975-26.417 15.168-26.416 34.964-79.25 44.863-105.666L483.436 478\"/><defs><marker id=\"q\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#r)\" d=\"M399.047 725.5h4.167c4.166 0 12.5 0 26.97-41.25 14.471-41.25 35.08-123.75 45.383-165L485.871 478\"/><defs><marker id=\"r\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#s)\" d=\"M382.883 814.5h6.86c6.861 0 20.583 0 37.95-56.083 17.368-56.084 38.382-168.25 48.889-224.334L487.089 478\"/><defs><marker id=\"s\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#t)\" d=\"M532.438 458.5h200\"/><defs><marker id=\"t\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#u)\" d=\"M865.734 458.5h100\"/><defs><marker id=\"u\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#v)\" d=\"M1108.938 458.5h200\"/><defs><marker id=\"v\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#w)\" d=\"M1395.203 458.5h100\"/><defs><marker id=\"w\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(1541.453 458.5)\"><rect width=\"92.5\" height=\"39\" x=\"-46.25\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"72.5\" height=\"19\" transform=\"translate(-36.25 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">do_syscall</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1352.07 458.5)\"><rect width=\"86.266\" height=\"39\" x=\"-43.133\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"66.266\" height=\"19\" transform=\"translate(-33.133 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">do_event</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1037.336 458.5)\"><rect width=\"143.203\" height=\"39\" x=\"-71.602\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"123.203\" height=\"19\" transform=\"translate(-61.602 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_irq_handle</div></foreignObject></g><g opacity=\"1\" transform=\"translate(799.086 458.5)\"><rect width=\"133.297\" height=\"39\" x=\"-66.648\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"113.297\" height=\"19\" transform=\"translate(-56.648 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_asm_trap</div></foreignObject></g><g opacity=\"1\" transform=\"translate(359.875 102.5)\"><rect width=\"56.047\" height=\"39\" x=\"-28.023\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"36.047\" height=\"19\" transform=\"translate(-18.023 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_exit</div></foreignObject></g><g opacity=\"1\" transform=\"translate(359.875 191.5)\"><rect width=\"63.359\" height=\"39\" x=\"-31.68\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"43.359\" height=\"19\" transform=\"translate(-21.68 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_open</div></foreignObject></g><g opacity=\"1\" transform=\"translate(359.875 280.5)\"><rect width=\"66.156\" height=\"39\" x=\"-33.078\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"46.156\" height=\"19\" transform=\"translate(-23.078 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_write</div></foreignObject></g><g opacity=\"1\" transform=\"translate(359.875 369.5)\"><rect width=\"58.078\" height=\"39\" x=\"-29.039\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"38.078\" height=\"19\" transform=\"translate(-19.04 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_sbrk</div></foreignObject></g><g opacity=\"1\" transform=\"translate(359.875 458.5)\"><rect width=\"60.656\" height=\"39\" x=\"-30.328\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"40.656\" height=\"19\" transform=\"translate(-20.328 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_read</div></foreignObject></g><g opacity=\"1\" transform=\"translate(359.875 547.5)\"><rect width=\"64.828\" height=\"39\" x=\"-32.414\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"44.828\" height=\"19\" transform=\"translate(-22.414 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_close</div></foreignObject></g><g opacity=\"1\" transform=\"translate(359.875 636.5)\"><rect width=\"65.109\" height=\"39\" x=\"-32.555\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"45.109\" height=\"19\" transform=\"translate(-22.555 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_lseek</div></foreignObject></g><g opacity=\"1\" transform=\"translate(359.875 725.5)\"><rect width=\"78.344\" height=\"39\" x=\"-39.172\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"58.344\" height=\"19\" transform=\"translate(-29.172 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_execve</div></foreignObject></g><g opacity=\"1\" transform=\"translate(359.875 814.5)\"><rect width=\"46.016\" height=\"39\" x=\"-23.008\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"26.016\" height=\"19\" transform=\"translate(-13.008 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_...</div></foreignObject></g><g opacity=\"1\" transform=\"translate(490.742 458.5)\"><rect width=\"83.391\" height=\"39\" x=\"-41.695\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"63.391\" height=\"19\" transform=\"translate(-31.695 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_syscall_</div></foreignObject></g><g opacity=\"1\" transform=\"translate(151.852 448.5)\"><rect width=\"137.703\" height=\"39\" x=\"-68.852\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"117.703\" height=\"19\" transform=\"translate(-58.852 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">printf,malloc,...</div></foreignObject></g></svg></p><p>这一阶段，需要实现<code>nanos-lite/src/irq.c</code>中的事件分发,以及<code>nanos-lite/src/syscall.c</code>中的系统调用，为了使得<code>navy-apps/tests/hello</code>能正确输出。需要实现<code>SYS_exit</code>，<code>SYS_yield</code>，<code>SYS_write</code>，<code>SYS_brk</code>，<code>SYS_execve</code>。这里通过<code>libc</code>中源代码我们对<code>libc</code>中的<code>printf</code>做一个简单的分析，在进入操作系统层面前<code>printf</code>一共使用了13层调用😨 WTF!</p><p><svg height=\"120\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:2321.8125px\" viewBox=\"0 0 2321.813 120\"><marker id=\"a\" fill=\"#333\" stroke=\"#333\" markerHeight=\"12\" markerUnits=\"userSpaceOnUse\" markerWidth=\"12\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><path stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></marker><marker fill=\"#333\" stroke=\"#333\" markerHeight=\"12\" markerUnits=\"userSpaceOnUse\" markerWidth=\"12\" orient=\"auto\" refX=\"0\" refY=\"5\" viewBox=\"0 0 10 10\"><path stroke-dasharray=\"1 0\" d=\"m0 5 10 5V0z\"/></marker><marker fill=\"#333\" stroke=\"#333\" markerHeight=\"11\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" orient=\"auto\" refX=\"11\" refY=\"5\" viewBox=\"0 0 10 10\"><circle cx=\"5\" cy=\"5\" r=\"5\" stroke-dasharray=\"1 0\"/></marker><marker fill=\"#333\" stroke=\"#333\" markerHeight=\"11\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" orient=\"auto\" refX=\"-1\" refY=\"5\" viewBox=\"0 0 10 10\"><circle cx=\"5\" cy=\"5\" r=\"5\" stroke-dasharray=\"1 0\"/></marker><marker fill=\"#333\" stroke=\"#333\" markerHeight=\"11\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" orient=\"auto\" refX=\"12\" refY=\"5.2\" viewBox=\"0 0 11 11\"/><marker fill=\"#333\" stroke=\"#333\" markerHeight=\"11\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" orient=\"auto\" refX=\"-1\" refY=\"5.2\" viewBox=\"0 0 11 11\"/><rect width=\"137.5\" height=\"104\" x=\"2176.313\" y=\"8\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"60.406\" height=\"19\" transform=\"translate(2214.86 13)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">syscall.c</span></div></foreignObject><rect width=\"131.266\" height=\"104\" x=\"1995.047\" y=\"8\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"33.5\" height=\"19\" transform=\"translate(2043.93 13)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">irq.c</span></div></foreignObject><rect width=\"188.203\" height=\"104\" x=\"1756.844\" y=\"8\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"36.797\" height=\"19\" transform=\"translate(1832.547 13)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">cte.c</span></div></foreignObject><rect width=\"198.391\" height=\"104\" x=\"1508.453\" y=\"8\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"43.453\" height=\"19\" transform=\"translate(1585.922 13)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">trap.S</span></div></foreignObject><rect width=\"111.156\" height=\"104\" x=\"1347.297\" y=\"8\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"33.266\" height=\"19\" transform=\"translate(1386.242 13)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">libos</span></div></foreignObject><rect width=\"1289.297\" height=\"104\" x=\"8\" y=\"8\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"26.125\" height=\"19\" transform=\"translate(639.586 13)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">libc</span></div></foreignObject><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M88.703 60h50\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M231.156 60h50\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M370.422 60h50\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M496.266 60h50\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M616.188 60h50\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M754.531 60h50\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M883.047 60h50\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M1020.516 60h50\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M1146.531 60h50\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M1272.297 60h100\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M1433.453 60h100\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M1681.844 60h100\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M1920.047 60h100\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M2101.313 60h99.999\"/><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g transform=\"translate(2245.063 60)\"><rect width=\"87.5\" height=\"34\" x=\"-43.75\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"72.5\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-36.25 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">do_syscall</span></div></foreignObject></g><g transform=\"translate(2060.68 60)\"><rect width=\"81.266\" height=\"34\" x=\"-40.633\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"66.266\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-33.133 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">do_event</span></div></foreignObject></g><g transform=\"translate(1850.945 60)\"><rect width=\"138.203\" height=\"34\" x=\"-69.102\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"123.203\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-61.602 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">__am_irq_handle</span></div></foreignObject></g><g transform=\"translate(1607.648 60)\"><rect width=\"148.391\" height=\"34\" x=\"-74.195\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"133.391\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-66.695 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">__am_trap_handle</span></div></foreignObject></g><g transform=\"translate(1402.875 60)\"><rect width=\"61.156\" height=\"34\" x=\"-30.578\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"46.156\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-23.078 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">_write</span></div></foreignObject></g><g transform=\"translate(184.93 60)\"><rect width=\"92.453\" height=\"34\" x=\"-46.227\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"77.453\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-38.727 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">_vfprintf_r</span></div></foreignObject></g><g transform=\"translate(60.852 60)\"><rect width=\"55.703\" height=\"34\" x=\"-27.852\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"40.703\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-20.352 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">printf</span></div></foreignObject></g><g transform=\"translate(325.79 60)\"><rect width=\"89.266\" height=\"34\" x=\"-44.633\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"74.266\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-37.133 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">__sfputs_r</span></div></foreignObject></g><g transform=\"translate(458.344 60)\"><rect width=\"75.844\" height=\"34\" x=\"-37.922\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"60.844\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-30.422 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">_fputc_r</span></div></foreignObject></g><g transform=\"translate(581.227 60)\"><rect width=\"69.922\" height=\"34\" x=\"-34.961\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"54.922\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-27.46 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">_putc_r</span></div></foreignObject></g><g transform=\"translate(710.36 60)\"><rect width=\"88.344\" height=\"34\" x=\"-44.172\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"73.344\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-36.672 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">__swbuf_r</span></div></foreignObject></g><g transform=\"translate(843.79 60)\"><rect width=\"78.516\" height=\"34\" x=\"-39.258\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"63.516\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-31.758 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">_fflush_r</span></div></foreignObject></g><g transform=\"translate(976.781 60)\"><rect width=\"87.469\" height=\"34\" x=\"-43.734\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"72.469\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-36.234 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">__sflush_r</span></div></foreignObject></g><g transform=\"translate(1108.523 60)\"><rect width=\"76.016\" height=\"34\" x=\"-38.008\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"61.016\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-30.508 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">__swrite</span></div></foreignObject></g><g transform=\"translate(1234.414 60)\"><rect width=\"75.766\" height=\"34\" x=\"-37.883\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"60.766\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-30.383 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">_write_r</span></div></foreignObject></g></svg></p><ol><li><code>SYS_exit</code></li></ol><p>​\t直接调用<code>_halt()</code>就行</p><ol start=\"2\"><li><p><code>SYS_yield</code></p><p>直接调用<code>_yield()</code>就行</p></li><li><p><code>SYS_write</code></p><p>对于<code>fd</code>为1或者2，则直接输出到<code>stdout</code>就行，当<code>fd</code>为其它时调用<code>fd_write</code>写入到文件</p></li><li><p><code>SYS_brk</code></p><p>这里没有太看懂Gitbook上的内容，我的理解是将<code>_heap.start</code>增加<code>GPR2</code>个大小，返回之前的<code>_heap.start</code></p><p>后来通过阅读<code>nexus-am/am/src/riscv32/nemu/boot/loader.ld</code>以及伟哥的帮助，终于弄懂了一些</p><p>这里放上<code>loader.ld</code>的代码</p><pre><code class=\"language-c\">SECTIONS {\n  . = 0x80100000;\n  .text : {\n    *(entry)\n    *(.text)\n  }\n  etext = .;\n  _etext = .;\n  .rodata : {\n    *(.rodata*)\n  }\n  .data : {\n    *(.data)\n  }\n  edata = .;\n  _data = .;\n  .bss : {\n\t_bss_start = .;\n    *(.bss*)\n    *(.sbss*)\n    *(.scommon)\n  }\n  _stack_top = ALIGN(4096);\n  . = _stack_top + 0x8000;\n  _stack_pointer = .;\n  end = .;\n  _end = .;\n  _heap_start = ALIGN(4096);\n  _heap_end = 0x88000000;\n}\n</code></pre><p>可以看到程序一共分为几大段<code>.text</code>，<code>.roddata</code>，<code>.data</code>，<code>.bss</code>，<code>.stack</code>，<code>.heap</code>，前面四段在编译完后大小就可以确定了，因此整个程序空间剩下的作为运行时变化的<code>.stack</code>和<code>.heap</code>段使用。整个程序运行空间大小为<code>0x880000000-0x80100000</code>，其中栈和堆从两边分别向对侧生长，界限由<code>_end</code>控制。为了确认我们的想法，可以观察一下<code>nexus-am/am/src/nemu-common/trm.c</code>中对<code>_heap</code>的定义</p><pre><code class=\"language-c\">/*\nnexus-am/am/src/nemu-common/trm.c\n*/\n#include &#x3C;am.h>\n#include &#x3C;nemu.h>\n\nextern char _heap_start;\nextern char _heap_end;\nint main(const char *args);\n\n_Area _heap = {\n  .start = &#x26;_heap_start,\n  .end = &#x26;_heap_end,\n};\n</code></pre><p>可以发现堆的定义就是从<code>loader.ld</code>中读取<code>_heap_start</code>和<code>_heap_end</code>。因此在<code>nanos.c</code>中进行修改</p><pre><code class=\"language-c\">/*\nnavy-apps/libs/libos/src/nanos.c\n*/\nextern char end;\nvoid *_sbrk(intptr_t increment) {\n  static void* program_break = (uintptr_t)&#x26;end;\n  void* old = program_break;\n  if(_syscall_(SYS_brk,program_break+increment,0,0)==0){\n    program_break += increment;\n    return old;\n  }\n  return (void*)-1;\n}\n</code></pre><p><code>syscall.c</code>中相应的实现为</p><pre><code class=\"language-c\">case SYS_brk:{\n      printf(\"sys brk\\n\");\n      if(c->GPR2&#x3C;=_heap.start||c->GPR2>=_heap.end){\n        c->GPRx = -1;\n      }\n      break;\n    }\n</code></pre></li><li><p><code>SYS_execve</code></p><p>这个是直接调用<code>naive_loader</code>就好了，但是在实现<code>naive_loader</code>（调用了<code>loader</code>）的时候需要对elf文件格式很了解（这个文件格式有很多不合理的地方，历史遗留问题，老屎山了💩），可以看看<a href=\"https://b23.tv/afki9uB\">B站上对这个文件格式的讲解</a>，我这里就直接提供源代码</p><pre><code class=\"language-c\">static uintptr_t loader(PCB *pcb, const char *filename) {\n  if(filename == NULL){\n    Elf_Ehdr ehdr;\n    ramdisk_read(&#x26;ehdr,0,sizeof(Elf_Ehdr));\n    Elf_Phdr phdr[ehdr.e_phnum];\n    ramdisk_read(phdr,ehdr.e_ehsize,sizeof(Elf_Phdr)*ehdr.e_phnum);\n    for(size_t i=0;i&#x3C;ehdr.e_phnum;++i){\n      if(phdr[i].p_type==PT_LOAD){\n        ramdisk_read((void*)phdr[i].p_vaddr,phdr[i].p_offset,phdr[i].p_memsz);\n        memset((void*)(phdr[i].p_vaddr+phdr[i].p_filesz),0,phdr[i].p_memsz-phdr[i].p_filesz);\n      }\n    }\n    return ehdr.e_entry;\n  }else{\n    int fd = fs_open(filename, 0,0);\n    Elf_Ehdr ehdr;\n    int ret = fs_read(fd, &#x26;ehdr,sizeof(Elf_Ehdr));\n    assert(ret!=-1);\n    ret = fs_lseek(fd,ehdr.e_ehsize,SEEK_SET);\n    assert(ret!=-1);\n    Elf_Phdr phdr[ehdr.e_phnum];\n    ret = fs_read(fd,phdr,sizeof(Elf_Phdr)*ehdr.e_phnum);\n    assert(ret!=-1);\n    for(size_t i=0;i&#x3C;ehdr.e_phnum;++i){\n      if(phdr[i].p_type==PT_LOAD){\n        ret = fs_lseek(fd,phdr[i].p_offset,SEEK_SET);\n        assert(ret!=-1);\n        ret = fs_read(fd,(void*)phdr[i].p_vaddr,phdr[i].p_memsz);\n        assert(ret!=-1);\n        memset((void*)(phdr[i].p_vaddr+phdr[i].p_filesz),0,phdr[i].p_memsz-phdr[i].p_filesz);\n      }\n    }\n    fs_close(fd);\n    return ehdr.e_entry;\n  }\n\n}\n</code></pre></li></ol><p>值得注意的是<code>nexus-am/am/include/arc/riscv32-nemu.h</code>中对<code>struct _Context</code>的定义与<code>nexus-am/am/src/riscv32/nemu/trap.S</code>中的压栈顺序并不一致，所以我对<code>struct _Context</code>的定义做了修改</p><h3>3.2.文件系统</h3><p>这里主要实现的是<code>nanos-lite/src/fs.c</code></p><p>这里解释一下<code>nanos-lite/src/files.h</code>这个文件include在<code>nanos-lite/src/fs.c</code>的<code>file_table</code>中，所以文件系统的所有文件包含了<code>file_table</code>中的以及<code>files.h</code>中的。由于我们的一切皆文件，所以还需要在<code>file_table</code>中加上<code>/dev/events</code>，<code>/proc/dispinfo</code>，<code>/dev/fb</code>，<code>dev/fbsync</code>，<code>/dev/tty</code>。这些虚拟文件分别在<code>fs_read</code>，<code>fs_write</code>中做特殊处理。为了处理这些特殊文件，我们会用到<code>nanos-lite/src/device.c</code>中的函数，这些函数只需要调用<code>nexus-am/am/am.h</code>中的<code>_io_read</code>就可以完成设备的读写操作，顺带提一句，这里的<code>fb_write</code>真的是蛋疼，在<code>_io_read</code>接口把线性空间写操作改为长方形写操作，在<code>nexus-am/am/src/nemu-common/nemu-video.c</code>的<code>__am_video_write</code>函数中又还原成线性写操作，这不是闲的蛋疼么，是不是闲我们CPU占用太低了拉点CPU占用😅。</p><p><code>Finfo</code>结构体中需要增加成员记录文件打开后的偏移位置。值得注意的是，⭐千万不要把文件指针直接返回，结构体在出函数时会自动销毁，建议返回文件在<code>file_table</code>中的索引位置。</p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"791.25\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:924.65625px\" viewBox=\"0 0 924.656 791.25\"><defs><path id=\"b\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(797.813 372.25)\"><rect width=\"237.688\" height=\"654\" x=\"-118.844\" y=\"-327\" fill=\"#6495ed\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"68.266\" height=\"19\" transform=\"translate(0 -313) translate(-34.133 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nexus-am</div></foreignObject></g><g opacity=\"1\" transform=\"translate(797.813 372.25)\"><rect width=\"187.688\" height=\"614\" x=\"-93.844\" y=\"-307\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"21.688\" height=\"19\" transform=\"translate(0 -293) translate(-10.844 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">am</div></foreignObject></g><g opacity=\"1\" transform=\"translate(797.813 372.25)\"><rect width=\"137.688\" height=\"574\" x=\"-68.844\" y=\"-287\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"36.313\" height=\"19\" transform=\"translate(0 -273) translate(-18.156 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">am.h</div></foreignObject></g><g opacity=\"1\" transform=\"translate(318.484 358.625)\"><rect width=\"620.969\" height=\"701.25\" x=\"-310.484\" y=\"-350.625\" fill=\"coral\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.188\" height=\"19\" transform=\"translate(0 -336.625) translate(-35.594 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nanos-lite</div></foreignObject></g><g opacity=\"1\" transform=\"translate(318.484 358.625)\"><rect width=\"570.969\" height=\"661.25\" x=\"-285.484\" y=\"-330.625\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"20.625\" height=\"19\" transform=\"translate(0 -316.625) translate(-10.313 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(209.82 358.625)\"><rect width=\"303.641\" height=\"621.25\" x=\"-151.82\" y=\"-310.625\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"26.188\" height=\"19\" transform=\"translate(0 -296.625) translate(-13.094 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">fs.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(495.305 418.125)\"><rect width=\"167.328\" height=\"502.25\" x=\"-83.664\" y=\"-251.125\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"60.484\" height=\"19\" transform=\"translate(0 -237.125) translate(-30.242 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">device.c</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M208.094 525.75h4.166c4.167 0 12.5 0 23.343 5.375 10.842 5.375 24.194 16.125 30.87 21.5l6.675 5.375\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"M200.102 614.75h5.498c5.499 0 16.496 0 27.1-2.958 10.603-2.959 20.812-8.875 25.916-11.834l5.105-2.958\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#d)\" d=\"M178.25 102.5h9.14c9.141 0 27.423 0 45.998 24s37.444 72 46.879 96l9.435 24\"/><defs><marker id=\"d\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#e)\" d=\"M177 191.5h9.349c9.349 0 28.047 0 45.304 9.167 17.257 9.166 33.074 27.5 40.983 36.666l7.908 9.167\"/><defs><marker id=\"e\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#f)\" d=\"M199.61 347.75h5.58c5.58 0 16.742 0 30.48-10.375s30.052-31.125 38.209-41.5l8.157-10.375\"/><defs><marker id=\"f\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#g)\" d=\"M186.969 436.75h7.687c7.688 0 23.063 0 40.24-25.208 17.176-25.209 36.153-75.625 45.642-100.834l9.489-25.208\"/><defs><marker id=\"g\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#h)\" d=\"m321.586 558 6.676-5.375c6.676-5.375 20.027-16.125 30.87-21.5 10.842-5.375 19.175-5.375 27.509-5.375h54.906\"/><defs><marker id=\"h\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#i)\" d=\"m331.014 597 5.104 2.958c5.105 2.959 15.314 8.875 24.585 11.834 9.271 2.958 17.604 2.958 25.938 2.958h50\"/><defs><marker id=\"i\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#j)\" d=\"m325.532 246.5 6.018-4.167c6.018-4.166 18.054-12.5 28.24-16.666 10.184-4.167 18.517-4.167 26.85-4.167h56.032\"/><defs><marker id=\"j\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#k)\" d=\"m312.698 285.5 8.157 10.375c8.158 10.375 24.472 31.125 36.795 41.5 12.324 10.375 20.657 10.375 28.99 10.375h68.172\"/><defs><marker id=\"k\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#l)\" d=\"m304.707 285.5 9.49 25.208c9.488 25.209 28.466 75.625 42.121 100.834 13.656 25.208 21.99 25.208 30.323 25.208h52.656\"/><defs><marker id=\"l\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#m)\" d=\"m307.295 246.5 9.057-17.792c9.058-17.791 27.173-53.375 40.398-71.166 13.224-17.792 21.557-17.792 29.89-17.792H767.657\"/><defs><marker id=\"m\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#n)\" d=\"M547.938 221.5h156.031c8.333 0 16.666 0 29.57 10.375s30.378 31.125 39.115 41.5l8.737 10.375\"/><defs><marker id=\"n\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#o)\" d=\"M535.797 347.75h168.172c8.333 0 16.666 0 27.28-4.167 10.612-4.166 23.504-12.5 29.95-16.666l6.446-4.167\"/><defs><marker id=\"o\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#p)\" d=\"M551.313 436.75h152.656c8.333 0 16.666 0 30.631-19s33.56-57 43.359-76l9.798-19\"/><defs><marker id=\"p\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#q)\" d=\"M549.063 525.75h154.906c8.333 0 16.666 0 27.984 5.375 11.317 5.375 25.618 16.125 32.768 21.5l7.15 5.375\"/><defs><marker id=\"q\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#r)\" d=\"M553.969 614.75h150c8.333 0 16.666 0 26.3-2.958 9.635-2.959 20.57-8.875 26.037-11.834l5.467-2.958\"/><defs><marker id=\"r\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(797.813 139.75)\"><rect width=\"60.313\" height=\"39\" x=\"-30.156\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"40.313\" height=\"19\" transform=\"translate(-20.156 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_putc</div></foreignObject></g><g opacity=\"1\" transform=\"translate(797.813 303.25)\"><rect width=\"87.688\" height=\"39\" x=\"-43.844\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"67.688\" height=\"19\" transform=\"translate(-33.844 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_io_write</div></foreignObject></g><g opacity=\"1\" transform=\"translate(797.813 577.5)\"><rect width=\"82.203\" height=\"39\" x=\"-41.102\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"62.203\" height=\"19\" transform=\"translate(-31.102 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_io_read</div></foreignObject></g><g opacity=\"1\" transform=\"translate(495.305 525.75)\"><rect width=\"107.516\" height=\"39\" x=\"-53.758\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"87.516\" height=\"19\" transform=\"translate(-43.758 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">events_read</div></foreignObject></g><g opacity=\"1\" transform=\"translate(495.305 614.75)\"><rect width=\"117.328\" height=\"39\" x=\"-58.664\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"97.328\" height=\"19\" transform=\"translate(-48.664 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">dispinfo_read</div></foreignObject></g><g opacity=\"1\" transform=\"translate(495.305 221.5)\"><rect width=\"105.266\" height=\"39\" x=\"-52.633\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"85.266\" height=\"19\" transform=\"translate(-42.633 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">serial_write</div></foreignObject></g><g opacity=\"1\" transform=\"translate(495.305 347.75)\"><rect width=\"80.984\" height=\"39\" x=\"-40.492\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"60.984\" height=\"19\" transform=\"translate(-30.492 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">fb_write</div></foreignObject></g><g opacity=\"1\" transform=\"translate(495.305 436.75)\"><rect width=\"112.016\" height=\"39\" x=\"-56.008\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"92.016\" height=\"19\" transform=\"translate(-46.008 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">fbsync_write</div></foreignObject></g><g opacity=\"1\" transform=\"translate(297.367 577.5)\"><rect width=\"73.047\" height=\"39\" x=\"-36.523\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"53.047\" height=\"19\" transform=\"translate(-26.523 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">fs_read</div></foreignObject></g><g opacity=\"1\" transform=\"translate(145.547 525.75)\"><rect width=\"125.094\" height=\"39\" x=\"-62.547\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"105.094\" height=\"19\" transform=\"translate(-52.547 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">/proc/dispinfo</div></foreignObject></g><g opacity=\"1\" transform=\"translate(145.547 614.75)\"><rect width=\"109.109\" height=\"39\" x=\"-54.555\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"89.109\" height=\"19\" transform=\"translate(-44.555 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">/dev/events</div></foreignObject></g><g opacity=\"1\" transform=\"translate(297.367 266)\"><rect width=\"78.547\" height=\"39\" x=\"-39.273\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"58.547\" height=\"19\" transform=\"translate(-29.273 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">fs_write</div></foreignObject></g><g opacity=\"1\" transform=\"translate(145.547 102.5)\"><rect width=\"65.406\" height=\"39\" x=\"-32.703\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"45.406\" height=\"19\" transform=\"translate(-22.703 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">stdout</div></foreignObject></g><g opacity=\"1\" transform=\"translate(145.547 191.5)\"><rect width=\"62.906\" height=\"39\" x=\"-31.453\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"42.906\" height=\"19\" transform=\"translate(-21.453 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">stderr</div></foreignObject></g><g opacity=\"1\" transform=\"translate(145.547 347.75)\"><rect width=\"108.125\" height=\"39\" x=\"-54.063\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"88.125\" height=\"19\" transform=\"translate(-44.063 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">/dev/fbsync</div></foreignObject></g><g opacity=\"1\" transform=\"translate(145.547 436.75)\"><rect width=\"82.844\" height=\"39\" x=\"-41.422\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"62.844\" height=\"19\" transform=\"translate(-31.422 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">/dev/tty</div></foreignObject></g><g opacity=\"1\" transform=\"translate(145.547 763.75)\"><rect width=\"55.047\" height=\"39\" x=\"-27.523\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"35.047\" height=\"19\" transform=\"translate(-17.523 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">stdin</div></foreignObject></g></svg></p><p><strong>特殊文件读写权限</strong></p><ul><li><p>Read Only</p><p><code>/proc/dispinfo</code>，<code>/dev/events</code></p></li><li><p>Write Only</p><p><code>stdout</code>，<code>stderr</code>，<code>/dev/fb</code>，<code>/dev/fbsync</code>，<code>/dev/tty</code></p></li><li><p>Forbidden</p><p><code>stdin</code></p></li></ul><p><strong><code>/nanos-lite/src/fs.c</code></strong></p><ol><li><p><code>Finfo</code></p><pre><code class=\"language-c\">typedef struct {\n  char *name;\n  size_t size;\n  size_t disk_offset;\n  size_t open_offset;\n  ReadFn read;\n  WriteFn write;\n} Finfo;\n</code></pre></li><li><p><code>file_table</code></p><pre><code class=\"language-c\">static Finfo file_table[] __attribute__((used)) = {\n  {\"stdin\", 0, 0, 0,invalid_read, invalid_write},\n  {\"stdout\", 0, 0, 0,invalid_read, invalid_write},\n  {\"stderr\", 0, 0, 0,invalid_read, invalid_write},\n  {\"/dev/events\",0,0,0},\n  {\"/proc/dispinfo\",0,0,0},\n  {\"/dev/fb\",0,0,0},\n  {\"/dev/fbsync\",0,0,0},\n  {\"/dev/tty\",0,0,0},\n#include \"files.h\"\n};\n</code></pre></li><li><p><code>int fs_open(const char* pathname, int flags, int mode)</code> 设置结构体中的<code>open_offset</code>为0就好，返回的<code>fd</code>最好不是结构体指针，c语言会蛋疼的销毁结构体，最好返回位置索引。</p></li><li><p><code>size_t fs_read(int fd, void *buf, size_t len)</code></p><p>对于可读特殊文件调用相应的系统函数就好（<code>events_read</code>，<code>dispinfo_read</code>）</p></li><li><p><code>size_t fs_write(int fd, void *buf, size_t len)</code></p><p>对于可写特殊文件调用相应的系统函数就好（<code>_putc</code>，<code>fb_write</code>，<code>fbsync_write</code>，<code>serial_write</code>）</p></li></ol><p><strong><code>/nanos-lite/src/device.c</code></strong></p><ol><li><p><code>size_t serial_write(const void *buf, size_t offset, size_t len)</code></p><p>调用<code>_putc</code>输出到<code>stdout</code>。</p></li><li><p><code>size_t events_read(void *buf, size_t offset, size_t len)</code></p><p>调用<code>_io_read</code>读取按键并和掩码<code>0x7fff</code>做与运算按照格式输出到<code>buf</code>。</p></li><li><p><code>size_t dispinfo_read(void *buf, size_t offset, size_t len)</code></p><p>在<code>void init_device()</code>中一开始就初始化<code>dispinfo</code>字符串，这个时候只需要复制到<code>buf</code>里即可。</p></li><li><p><code>size_t fb_write(void *buf, size_t offset, size_t len)</code></p><p>这里我实现了将线性赋值变成了一到三个矩形画图，这个转换真的是闲的蛋疼😓，我直接放代码好了。</p><pre><code class=\"language-c\">size_t fb_write(void *buf, size_t offset, size_t len) {\n#ifdef MULTIPROC\n  _yield();\n#endif\n  offset /=4;\n  //printf(\"fb write buf:0x%x offset:%d len:%d\\n\",buf,offset,len);\n  uint32_t * p=buf;\n  len = min(H*W-offset,len);\n  int ret = len;\n  _DEV_VIDEO_FBCTL_t ctl ;\n  ctl.pixels = p;\n  ctl.x = offset%W;\n  ctl.y =offset/W;\n  ctl.w = W-offset%W;\n  ctl.h = 1,\n  ctl.sync = 0,\n  _io_write(_DEV_VIDEO, _DEVREG_VIDEO_FBCTL, &#x26;ctl, sizeof(ctl));\n  \n  ctl.x=0;\n  ctl.y+=ctl.h;\n  len-=ctl.w*ctl.h;\n  p+=ctl.w*ctl.h;\n  if(len/W){\n    ctl.h=len/W;\n    ctl.w =W;\n    ctl.pixels=p;\n    _io_write(_DEV_VIDEO, _DEVREG_VIDEO_FBCTL, &#x26;ctl, sizeof(ctl));\n    ctl.y+=ctl.h;\n    len-=ctl.h*ctl.w;\n    p+=ctl.h*ctl.w;\n  }\n\n  if(len){\n    ctl.pixels = p;\n    ctl.w = len;\n    ctl.h = 1;\n    _io_write(_DEV_VIDEO, _DEVREG_VIDEO_FBCTL, &#x26;ctl, sizeof(ctl));\n  }\n  return ret;\n}\n</code></pre></li><li><p><code>size_t fbsync_write(const void *buf, size_t offset, size_t len)</code></p><p>这里没啥技术含量，仿照之前的test里面的代码写一写就好了</p><pre><code class=\"language-c\">size_t fbsync_write(const void *buf, size_t offset, size_t len) {\n _DEV_VIDEO_FBCTL_t ctl;\n ctl.pixels = NULL;\n ctl.x = ctl.y = ctl.w = ctl.h = 0;\n ctl.sync = 1;\n _io_write(_DEV_VIDEO, _DEVREG_VIDEO_FBCTL, &#x26;ctl, sizeof(ctl));\n return 0;\n}\n</code></pre></li></ol><p>值得注意的是，我在WSL中发现<code>files.h</code>的<code>/share/texts/num</code>文件大小是6000字节，而不是5000字节，猜测与windows系统地<code>\\n\\r</code>有关，所以在做<code>/bin/text</code>测试时，需要在<code>navy-apps/tests/text/text.c</code>修改测试代码</p><h3>3.3测试</h3><p>在<code>nanos-lite/src/proc.c</code>的<code>void init_proc()</code>中，修改<code>naive_load</code>的文件就可以了，这些文件可以是<code>files.h</code>中的任何可执行文件。如果需要运行PAL(仙剑奇侠传，那么需要下载额外文件到<code>navy-apps/apps/pal</code>)</p><h3>3.4.注意事项</h3><ol><li><code>nexus-am/am/include/arc/riscv32-nemu.h</code>中对<code>struct _Context</code>的定义与<code>nexus-am/am/src/riscv32/nemu/trap.S</code>中的压栈顺序并不一致，所以我对<code>struct _Context</code>的定义做了修改</li><li>千万不要把文件指针直接返回，结构体在出函数时会自动销毁，建议返回文件在<code>file_table</code>中的索引位置。</li><li>我在WSL中发现<code>files.h</code>的<code>/share/texts/num</code>文件大小是6000字节，而不是5000字节，猜测与windows系统地<code>\\n\\r</code>有关，所以在做<code>/bin/text</code>测试时，需要在<code>navy-apps/tests/text/text.c</code>修改测试代码</li><li>在debug时，可以修改<code>navy-apps/tests/*</code>下的文件来进行错误定位，在编译后，可以使用<code>riscv64-unkown-elf-objdump</code>指令来反汇编<code>navy-apps/fsimg/bin</code>下的二进制文件进行观察</li></ol><hr><h2>4.PA4 NANOS-LITE pro</h2><h4>4.1.多进程</h4><p>程序加载流程为</p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"369\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:1059.1875px\" viewBox=\"0 0 1059.188 369\"><defs><path id=\"b\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(219.477 266.5)\"><rect width=\"422.953\" height=\"189\" x=\"-211.477\" y=\"-94.5\" fill=\"#6495ed\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"68.266\" height=\"19\" transform=\"translate(0 -80.5) translate(-34.133 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nexus-am</div></foreignObject></g><g opacity=\"1\" transform=\"translate(219.477 266.5)\"><rect width=\"382.953\" height=\"139\" x=\"-191.477\" y=\"-69.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"156.766\" height=\"19\" transform=\"translate(0 -55.5) translate(-78.383 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">am/src/riscv32/nemu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(128.57 266.5)\"><rect width=\"161.141\" height=\"89\" x=\"-80.57\" y=\"-44.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"36.797\" height=\"19\" transform=\"translate(0 -30.5) translate(-18.398 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cte.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(310.047 266.5)\"><rect width=\"161.813\" height=\"89\" x=\"-80.906\" y=\"-44.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"43.641\" height=\"19\" transform=\"translate(0 -30.5) translate(-21.82 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">vme.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(751.07 184.5)\"><rect width=\"600.234\" height=\"353\" x=\"-300.117\" y=\"-176.5\" fill=\"coral\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.188\" height=\"19\" transform=\"translate(0 -162.5) translate(-35.594 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nanos-lite</div></foreignObject></g><g opacity=\"1\" transform=\"translate(751.07 184.5)\"><rect width=\"560.234\" height=\"303\" x=\"-280.117\" y=\"-151.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"20.625\" height=\"19\" transform=\"translate(0 -137.5) translate(-10.313 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(751.07 184.5)\"><rect width=\"520.234\" height=\"253\" x=\"-260.117\" y=\"-126.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"57.234\" height=\"19\" transform=\"translate(0 -112.5) translate(-28.617 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">loader.c</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M923.172 122v75c0 8.333 0 16.667-.936 25-.937 8.333-2.81 16.667-3.746 20.833l-.936 4.167\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"m790.54 122 6.752 4.167c6.753 4.166 20.258 12.5 27.01 20.833 6.753 8.333 6.753 16.667 6.753 25v25c0 8.333 0 16.667 8.221 25.289 8.221 8.621 24.664 17.532 32.885 21.987l8.222 4.455\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#d)\" d=\"M586.836 122v75c0 8.333 0 16.667-68.783 27.512-68.782 10.846-206.347 24.205-275.13 30.884l-68.782 6.679\"/><defs><marker id=\"d\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#e)\" d=\"m725.612 122-7.121 4.167c-7.12 4.166-21.363 12.5-28.483 20.833-7.121 8.333-7.121 16.667-7.121 25v25c0 8.333 0 16.667-54.49 27.337-54.488 10.67-163.466 23.677-217.955 30.18l-54.489 6.504\"/><defs><marker id=\"e\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(310.047 266.5)\"><rect width=\"91.813\" height=\"39\" x=\"-45.906\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"71.813\" height=\"19\" transform=\"translate(-35.906 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_ucontext</div></foreignObject></g><g opacity=\"1\" transform=\"translate(128.57 266.5)\"><rect width=\"91.141\" height=\"39\" x=\"-45.57\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"71.141\" height=\"19\" transform=\"translate(-35.57 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_kcontext</div></foreignObject></g><g opacity=\"1\" transform=\"translate(913.172 266.5)\"><rect width=\"65.578\" height=\"39\" x=\"-32.789\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"45.578\" height=\"19\" transform=\"translate(-22.79 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">loader</div></foreignObject></g><g opacity=\"1\" transform=\"translate(923.172 102.5)\"><rect width=\"106.031\" height=\"39\" x=\"-53.016\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"86.031\" height=\"19\" transform=\"translate(-43.016 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">naive_uload</div></foreignObject></g><g opacity=\"1\" transform=\"translate(586.836 102.5)\"><rect width=\"121.766\" height=\"39\" x=\"-60.883\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"101.766\" height=\"19\" transform=\"translate(-50.883 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">context_kload</div></foreignObject></g><g opacity=\"1\" transform=\"translate(758.938 102.5)\"><rect width=\"122.438\" height=\"39\" x=\"-61.219\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"102.438\" height=\"19\" transform=\"translate(-51.219 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">context_uload</div></foreignObject></g></svg></p><p>进程切换的流程为</p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"334\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:1124.9375px\" viewBox=\"0 0 1124.938 334\"><defs><path id=\"b\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(907.32 102.5)\"><rect width=\"419.234\" height=\"189\" x=\"-209.617\" y=\"-94.5\" fill=\"coral\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.188\" height=\"19\" transform=\"translate(0 -80.5) translate(-35.594 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nanos-lite</div></foreignObject></g><g opacity=\"1\" transform=\"translate(907.32 102.5)\"><rect width=\"369.234\" height=\"149\" x=\"-184.617\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"20.625\" height=\"19\" transform=\"translate(0 -60.5) translate(-10.313 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(815.836 102.5)\"><rect width=\"136.266\" height=\"109\" x=\"-68.133\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"33.5\" height=\"19\" transform=\"translate(0 -40.5) translate(-16.75 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">irq.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1000.453 102.5)\"><rect width=\"132.969\" height=\"109\" x=\"-66.484\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"45.438\" height=\"19\" transform=\"translate(0 -40.5) translate(-22.719 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">proc.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(327.852 167)\"><rect width=\"639.703\" height=\"318\" x=\"-319.852\" y=\"-159\" fill=\"#6495ed\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"68.266\" height=\"19\" transform=\"translate(0 -145) translate(-34.133 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nexus-am</div></foreignObject></g><g opacity=\"1\" transform=\"translate(327.852 167)\"><rect width=\"589.703\" height=\"278\" x=\"-294.852\" y=\"-139\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"156.766\" height=\"19\" transform=\"translate(0 -125) translate(-78.383 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">am/src/riscv32/nemu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(327.852 102.5)\"><rect width=\"539.703\" height=\"109\" x=\"-269.852\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"36.797\" height=\"19\" transform=\"translate(0 -40.5) translate(-18.398 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cte.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(287.852 231.5)\"><rect width=\"183.297\" height=\"109\" x=\"-91.648\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"43.453\" height=\"19\" transform=\"translate(0 -40.5) translate(-21.727 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">trap.S</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M146.203 102.5h25c8.333 0 16.667 0 33.8 18.25 17.132 18.25 43.063 54.75 56.029 73L273.998 212\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"M354.5 231.5h4.167c4.166 0 12.5 0 20.833-21.5 8.333-21.5 16.667-64.5 25-86 8.333-21.5 16.667-21.5 20.833-21.5h4.167\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#d)\" d=\"M572.703 102.5h200\"/><defs><marker id=\"d\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#e)\" d=\"M858.969 102.5h100\"/><defs><marker id=\"e\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(1000.453 102.5)\"><rect width=\"82.969\" height=\"39\" x=\"-41.484\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"62.969\" height=\"19\" transform=\"translate(-31.484 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">schedule</div></foreignObject></g><g opacity=\"1\" transform=\"translate(815.836 102.5)\"><rect width=\"86.266\" height=\"39\" x=\"-43.133\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"66.266\" height=\"19\" transform=\"translate(-33.133 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">do_event</div></foreignObject></g><g opacity=\"1\" transform=\"translate(287.852 231.5)\"><rect width=\"133.297\" height=\"39\" x=\"-66.648\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"113.297\" height=\"19\" transform=\"translate(-56.648 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_asm_trap</div></foreignObject></g><g opacity=\"1\" transform=\"translate(114.602 102.5)\"><rect width=\"63.203\" height=\"39\" x=\"-31.602\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"43.203\" height=\"19\" transform=\"translate(-21.602 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_yield</div></foreignObject></g><g opacity=\"1\" transform=\"translate(501.102 102.5)\"><rect width=\"143.203\" height=\"39\" x=\"-71.602\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"123.203\" height=\"19\" transform=\"translate(-61.602 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_irq_handle</div></foreignObject></g></svg></p><p>所有涉及到的文件就一目了然了</p><ol><li><p><strong><code>nexus-am/am/src/riscv32/nemu/trap.S</code></strong></p><p>首先<code>__am_irq_handle</code>需要重置<code>sp</code>，因为在<code>__am_irq_hanlde</code>期间，如果是切换进程，那么<code>Context</code>都会改变，所以需要将新的<code>Context</code>导出到寄存器</p><pre><code>   mv a0, sp\n   jal __am_irq_handle\n   mv sp, a0\n</code></pre></li><li><p><strong><code>nanos-lite/src/irq.c</code></strong></p><p><code>_Context* do_event(_Event e, _Context* c)</code>当操作系统收到<code>EVENT_YIELD</code>时，需要调用<code>schedule</code>来切换进程</p><pre><code class=\"language-c\">    case _EVENT_YIELD:{\n      printf(\"event yield\\n\");\n      c=schedule(c);\n      break;\n    }\n</code></pre></li><li><p><strong><code>nanos-lite/src/loader.c</code></strong></p><p>在<code>context_uload</code>中，首先使用<code>loader</code>将代码段装到<code>pcb</code>，不同进程的代码是不同的，然后调用<code>_ucontext</code>对上下文进行初始化</p></li></ol><h3>4.2.分页</h3><p>分页机制就是使用虚拟地址而不是实际地址来，然而并不是所有的虚拟地址都会映射到物理地址。当我们需要使用哪些虚拟地址时便会建立映射。在<code>rtl_lm</code>或者<code>rtl_sm</code>访问地址的时候会根据一定策略来将虚拟地址转换为物理地址。</p><p>建立映射的位置有两个，一个是在程序加载的时候，还有一个是在程序运行时申请空间的时候。</p><h4>4.2.1 程序加载</h4><p>对于程序加载主要流程如下，<code>nanos-lite/src/loader.c</code>中按照页大小对程序进行读取 ，每读取一页通过调用<code>_map</code>建立虚拟地址到物理地址的映射存入<code>c->ptr</code>中（这个也是页目录）。注意编译时需要将<code>navy-apps/Makefile.compile</code>中<code>VME=enable</code>前的注释符号去掉，让Makefile将程序映射到<code>0x40000000</code>开头的虚拟地址空间。</p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"471.25\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:645.859375px\" viewBox=\"0 0 645.859 471.25\"><defs><path id=\"b\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(516.938 368.75)\"><rect width=\"241.844\" height=\"189\" x=\"-120.922\" y=\"-94.5\" fill=\"#6495ed\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"68.266\" height=\"19\" transform=\"translate(0 -80.5) translate(-34.133 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nexus-am</div></foreignObject></g><g opacity=\"1\" transform=\"translate(516.938 368.75)\"><rect width=\"191.844\" height=\"149\" x=\"-95.922\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"156.766\" height=\"19\" transform=\"translate(0 -60.5) translate(-78.383 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">am/src/riscv32/nemu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(516.938 368.75)\"><rect width=\"141.844\" height=\"109\" x=\"-70.922\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"43.641\" height=\"19\" transform=\"translate(0 -40.5) translate(-21.82 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">vme.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(322.93 131.125)\"><rect width=\"629.859\" height=\"246.25\" x=\"-314.93\" y=\"-123.125\" fill=\"coral\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.188\" height=\"19\" transform=\"translate(0 -109.125) translate(-35.594 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nanos-lite</div></foreignObject></g><g opacity=\"1\" transform=\"translate(322.93 131.125)\"><rect width=\"579.859\" height=\"206.25\" x=\"-289.93\" y=\"-103.125\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"20.625\" height=\"19\" transform=\"translate(0 -89.125) translate(-10.313 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(202.008 134.75)\"><rect width=\"288.016\" height=\"159\" x=\"-144.008\" y=\"-79.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"57.234\" height=\"19\" transform=\"translate(0 -65.5) translate(-28.617 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">loader.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(516.938 102.5)\"><rect width=\"141.844\" height=\"109\" x=\"-70.922\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"40.359\" height=\"19\" transform=\"translate(0 -40.5) translate(-20.18 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">mm.c</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M205.438 139.75h50\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"m318.479 120.25 4.59-2.958c4.589-2.959 13.768-8.875 22.524-11.834 8.756-2.958 17.09-2.958 25.423-2.958h100\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#d)\" d=\"m318.479 159.25 4.59 2.958c4.589 2.959 13.768 8.875 22.524 11.834C354.349 177 362.683 177 371.016 177h50c8.333 0 16.666 0 31.451 28.708 14.785 28.709 36.022 86.125 46.64 114.834l10.618 28.708\"/><defs><marker id=\"d\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(516.938 368.75)\"><rect width=\"59\" height=\"39\" x=\"-29.5\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"39\" height=\"19\" transform=\"translate(-19.5 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_map</div></foreignObject></g><g opacity=\"1\" transform=\"translate(516.938 102.5)\"><rect width=\"91.844\" height=\"39\" x=\"-45.922\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"71.844\" height=\"19\" transform=\"translate(-35.922 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">new_page</div></foreignObject></g><g opacity=\"1\" transform=\"translate(288.227 139.75)\"><rect width=\"65.578\" height=\"39\" x=\"-32.789\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"45.578\" height=\"19\" transform=\"translate(-22.79 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">loader</div></foreignObject></g><g opacity=\"1\" transform=\"translate(144.219 139.75)\"><rect width=\"122.438\" height=\"39\" x=\"-61.219\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"102.438\" height=\"19\" transform=\"translate(-51.219 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">context_uload</div></foreignObject></g></svg></p><ol><li><p><strong><code>static uintptr_t loader(PCB *pcb, const char *filename)</code></strong></p><p>在加载程序的时候根据elf将每个块分页，读入分配物理地址，并调用<code>_map</code>来进行映射</p></li><li><p><strong><code>int _map(_AddressSpace *as, void *va, void *pa, int prot)</code></strong></p><p>根据页目录基地址<code>as->ptr</code>，建立<code>va</code>到<code>pa</code>的映射，这里我规定<code>va</code>和<code>pa</code>都是页起始地址，也就意味着他们的低12位为0</p></li></ol><h4>4.2.2.程序运行</h4><p>在程序运行时，像<code>malloc</code>之类的函数会动态的申请新的虚拟地址，因此我们还需要对这部分动态申请的虚拟地址建立映射。申请空间会调用<code>SYS_brk</code>因此在调用<code>SYS_brk</code>的时候我们分配物理地址并进行映射就好了</p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"424\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:1707.734375px\" viewBox=\"0 0 1707.734 424\"><defs><path id=\"b\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(1312.852 316.5)\"><rect width=\"773.766\" height=\"199\" x=\"-386.883\" y=\"-99.5\" fill=\"coral\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.188\" height=\"19\" transform=\"translate(0 -85.5) translate(-35.594 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nanos-lite</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1312.852 316.5)\"><rect width=\"723.766\" height=\"159\" x=\"-361.883\" y=\"-79.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"20.625\" height=\"19\" transform=\"translate(0 -65.5) translate(-10.313 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1044.102 311.5)\"><rect width=\"136.266\" height=\"109\" x=\"-68.133\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"33.5\" height=\"19\" transform=\"translate(0 -40.5) translate(-16.75 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">irq.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1233.484 311.5)\"><rect width=\"142.5\" height=\"109\" x=\"-71.25\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"60.406\" height=\"19\" transform=\"translate(0 -40.5) translate(-30.203 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">syscall.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1502.234 316.5)\"><rect width=\"295\" height=\"119\" x=\"-147.5\" y=\"-59.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"40.359\" height=\"19\" transform=\"translate(0 -45.5) translate(-20.18 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">mm.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1049.602 102.5)\"><rect width=\"1300.266\" height=\"189\" x=\"-650.133\" y=\"-94.5\" fill=\"#6495ed\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"68.266\" height=\"19\" transform=\"translate(0 -80.5) translate(-34.133 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nexus-am</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1049.602 102.5)\"><rect width=\"1250.266\" height=\"149\" x=\"-625.133\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"156.766\" height=\"19\" transform=\"translate(0 -60.5) translate(-78.383 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">am/src/riscv32/nemu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(541.117 102.5)\"><rect width=\"183.297\" height=\"109\" x=\"-91.648\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"43.453\" height=\"19\" transform=\"translate(0 -40.5) translate(-21.727 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">trap.S</div></foreignObject></g><g opacity=\"1\" transform=\"translate(779.367 102.5)\"><rect width=\"193.203\" height=\"109\" x=\"-96.602\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"36.797\" height=\"19\" transform=\"translate(0 -40.5) translate(-18.398 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cte.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1578.813 102.5)\"><rect width=\"141.844\" height=\"109\" x=\"-70.922\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"43.641\" height=\"19\" transform=\"translate(0 -40.5) translate(-21.82 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">vme.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(178.734 102.5)\"><rect width=\"341.469\" height=\"189\" x=\"-170.734\" y=\"-94.5\" fill=\"#7fffd4\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.469\" height=\"19\" transform=\"translate(0 -80.5) translate(-35.734 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">navy-apps</div></foreignObject></g><g opacity=\"1\" transform=\"translate(178.734 102.5)\"><rect width=\"291.469\" height=\"149\" x=\"-145.734\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"95.328\" height=\"19\" transform=\"translate(0 -60.5) translate(-47.664 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">libs/libos/src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(178.734 102.5)\"><rect width=\"241.469\" height=\"109\" x=\"-120.734\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"54.75\" height=\"19\" transform=\"translate(0 -40.5) translate(-27.375 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nanos.c</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M141.078 102.5h50\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"M274.469 102.5h200\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#d)\" d=\"M607.766 102.5h100\"/><defs><marker id=\"d\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#e)\" d=\"M850.969 102.5h100c8.333 0 16.666 0 31.13 31.583 14.462 31.584 35.054 94.75 45.35 126.334L1037.745 292\"/><defs><marker id=\"e\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#f)\" d=\"M1087.234 311.5h100\"/><defs><marker id=\"f\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#g)\" d=\"M1279.734 311.5h100\"/><defs><marker id=\"g\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#h)\" d=\"m1457.89 317.599 4.167.65c4.167.65 12.5 1.95 20.834 2.6 8.333.651 16.666.651 25 .651h25\"/><defs><marker id=\"h\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#i)\" d=\"m1457.89 300.98 4.167-1.122c4.167-1.121 12.5-3.365 20.834-4.486 8.333-1.122 16.666-1.122 31.451-29.83 14.785-28.709 36.022-86.125 46.64-114.834L1571.6 122\"/><defs><marker id=\"i\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(1418.813 311.5)\"><rect width=\"78.156\" height=\"39\" x=\"-39.078\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"58.156\" height=\"19\" transform=\"translate(-29.078 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">mm_brk</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1578.813 321.5)\"><rect width=\"91.844\" height=\"39\" x=\"-45.922\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"71.844\" height=\"19\" transform=\"translate(-35.922 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">new_page</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1233.484 311.5)\"><rect width=\"92.5\" height=\"39\" x=\"-46.25\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"72.5\" height=\"19\" transform=\"translate(-36.25 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">do_syscall</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1044.102 311.5)\"><rect width=\"86.266\" height=\"39\" x=\"-43.133\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"66.266\" height=\"19\" transform=\"translate(-33.133 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">do_event</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1578.813 102.5)\"><rect width=\"59\" height=\"39\" x=\"-29.5\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"39\" height=\"19\" transform=\"translate(-19.5 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_map</div></foreignObject></g><g opacity=\"1\" transform=\"translate(779.367 102.5)\"><rect width=\"143.203\" height=\"39\" x=\"-71.602\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"123.203\" height=\"19\" transform=\"translate(-61.602 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_irq_handle</div></foreignObject></g><g opacity=\"1\" transform=\"translate(541.117 102.5)\"><rect width=\"133.297\" height=\"39\" x=\"-66.648\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"113.297\" height=\"19\" transform=\"translate(-56.648 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_asm_trap</div></foreignObject></g><g opacity=\"1\" transform=\"translate(232.773 102.5)\"><rect width=\"83.391\" height=\"39\" x=\"-41.695\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"63.391\" height=\"19\" transform=\"translate(-31.695 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_syscall_</div></foreignObject></g><g opacity=\"1\" transform=\"translate(112.04 102.5)\"><rect width=\"58.078\" height=\"39\" x=\"-29.039\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"38.078\" height=\"19\" transform=\"translate(-19.04 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_sbrk</div></foreignObject></g></svg></p><ol><li><p><strong><code>mm_brk(uintptr_t brk, intptr_t increment)</code></strong></p><p>为<code>[brk,brk+increment]</code>的虚拟空间分配物理空间并建立映射，如果有的虚拟页已经建立映射则直接跳过。</p></li></ol><h4>4.2.3.运行时访存</h4><p>除了建立映射， 在访问时还需要根据映射来进行虚地址到物理地址的转换。因此还需要在地址访问时进行转化。转换的依据是<code>satp</code>寄存器，最高位为模式为，<code>1</code>时为开启分页，<code>0</code>为关闭分页。<code>PPN</code>为页目录基地址右移12位，可以将<code>satp&#x3C;&#x3C;12</code>得到<code>pdir</code>页目录基地址。</p><p><img src=\"https://s2.loli.net/2022/01/14/G7yqcMgC3nLmKOR.jpg\" alt=\"\" width=\"595\" height=\"86\" type=\"jpg\" blurdataurl=\"data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAf/xAAbEAEAAAcAAAAAAAAAAAAAAAAAAwQFBzZ1tP/EABQBAQAAAAAAAAAAAAAAAAAAAAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwC1WSxCe3VS64oAP//Z\"></p><p>在执行<code>isa_vaddr_read</code>/<code>isa_vaddr_write</code>时，需要判断是否开启分页 ，如果开启分页则调用<code>page_translate</code>来映射地址再进行读取，需要注意跨页情况。</p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"604.75\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:577.140625px\" viewBox=\"0 0 577.141 604.75\"><defs><path id=\"b\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(288.57 302.375)\"><rect width=\"561.141\" height=\"588.75\" x=\"-280.57\" y=\"-294.375\" fill=\"#a9a9a9\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"39.5\" height=\"19\" transform=\"translate(0 -280.375) translate(-19.75 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nemu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(288.57 302.375)\"><rect width=\"511.141\" height=\"548.75\" x=\"-255.57\" y=\"-274.375\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"20.625\" height=\"19\" transform=\"translate(0 -260.375) translate(-10.313 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(288.57 173.375)\"><rect width=\"461.141\" height=\"250.75\" x=\"-230.57\" y=\"-125.375\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"77.641\" height=\"19\" transform=\"translate(0 -111.375) translate(-38.82 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">isa/riscv32</div></foreignObject></g><g opacity=\"1\" transform=\"translate(405.71 437.75)\"><rect width=\"226.859\" height=\"238\" x=\"-113.43\" y=\"-119\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"57.984\" height=\"19\" transform=\"translate(0 -105) translate(-28.992 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">memory</div></foreignObject></g><g opacity=\"1\" transform=\"translate(405.71 437.75)\"><rect width=\"176.859\" height=\"198\" x=\"-88.43\" y=\"-99\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"69.828\" height=\"19\" transform=\"translate(0 -85) translate(-34.914 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">memory.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(288.57 173.375)\"><rect width=\"411.141\" height=\"210.75\" x=\"-205.57\" y=\"-105.375\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"49.109\" height=\"19\" transform=\"translate(0 -91.375) translate(-24.555 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">mmu.c</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"m239.531 113.457 4.625-1.368c4.625-1.368 13.875-4.103 22.667-5.471 8.792-1.368 17.125-1.368 25.458-1.368 8.334 0 16.667 0 25 .813 8.334.813 16.667 2.438 20.834 3.251l4.166.813\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"m208.108 202 9.863-5.833c9.862-5.834 29.586-17.5 43.615-23.334C275.615 167 283.948 167 292.28 167c8.334 0 16.667 0 29.114-4.167 12.446-4.166 29.006-12.5 37.286-16.666l8.28-4.167\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#d)\" d=\"m208.108 152 9.863 5.833c9.862 5.834 29.586 17.5 43.615 23.334C275.615 187 283.948 187 292.28 187c8.334 0 16.667 0 34.178 31.125 17.512 31.125 44.202 93.375 57.546 124.5l13.345 31.125\"/><defs><marker id=\"d\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#e)\" d=\"m242.281 236.074 4.167.904c4.167.904 12.5 2.713 20.833 3.618 8.334.904 16.667.904 25 .904 8.334 0 16.667 0 34.378 36.875s44.8 110.625 58.345 147.5l13.544 36.875\"/><defs><marker id=\"e\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(405.71 393.25)\"><rect width=\"102.031\" height=\"39\" x=\"-51.016\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"82.031\" height=\"19\" transform=\"translate(-41.016 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">paddr_read</div></foreignObject></g><g opacity=\"1\" transform=\"translate(405.71 482.25)\"><rect width=\"107.516\" height=\"39\" x=\"-53.758\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"87.516\" height=\"19\" transform=\"translate(-43.758 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">paddr_write</div></foreignObject></g><g opacity=\"1\" transform=\"translate(405.71 122.5)\"><rect width=\"126.859\" height=\"39\" x=\"-63.43\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"106.859\" height=\"19\" transform=\"translate(-53.43 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">page_translate</div></foreignObject></g><g opacity=\"1\" transform=\"translate(175.14 132.5)\"><rect width=\"128.781\" height=\"39\" x=\"-64.391\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"108.781\" height=\"19\" transform=\"translate(-54.39 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">isa_vaddr_read</div></foreignObject></g><g opacity=\"1\" transform=\"translate(175.14 221.5)\"><rect width=\"134.281\" height=\"39\" x=\"-67.141\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"114.281\" height=\"19\" transform=\"translate(-57.14 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">isa_vaddr_write</div></foreignObject></g></svg></p><ol><li><strong><code>paddr_t page_translate(vaddr_t vaddr)</code></strong></li></ol><p><code>page_translate</code>函数可以根据下图来实现</p><p><img src=\"https://s2.loli.net/2022/01/14/WEHG64AdF8vrQc2.jpg\" alt=\"\" width=\"510\" height=\"425\" type=\"jpg\" blurdataurl=\"data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAEAAQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAX/xAAeEAABBAMAAwAAAAAAAAAAAAABAAIDEQQFIRIxQf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwC/Pkv0uz2UGFZilypJ/GZ7pS0uPQC4k1YuiT7PziIiD//Z\"></p><p>为了展示更详细一点，这里提供一个简单的实现代码</p><pre><code class=\"language-c\"> uint32_t page_translate(uint32_t* pdir,uint32_t vaddr){\n     /*\n         simple version of page_translate\n         @pdir :page directory\n         @vaddr:virtual address\n     */\n     uint32_t pdx = (vaddr>>22)&#x26;0x3ff;\n     uint32_t ptx = (vaddr>>12)&#x26;0x3ff;\n     uint32_t off = vaddr&#x26;0xfff;\n     uint32_t pde = pdir[pdx];\n     assert(pde&#x26;0x1);//assert the pde is valid\n     uint32_t* ptab = (pde&#x26;~0x3ff)&#x3C;&#x3C;2;\n     uint32_t pte = ptab[ptx];\n     assert(pte&#x26;0x1);//assert the pte is valid\n     uint32_t paddr = ((pte&#x26;~0x3ff)&#x3C;&#x3C;2)|off;\n     return  paddr;\n }\n</code></pre><ol start=\"2\"><li><p><strong><code>uint32_t isa_vaddr_read(vaddr_t addr, int len)</code></strong></p><p>如果<code>satp.MODE</code>为1，则为开启分页，此时要判断是否跨页，如果跨页则分别读取并凭借，否则直接通过<code>page_tranlsate</code>转换为物理地址进行读取。如果<code>stap.MODE</code>为0，则直接当做物理地址进行读取。</p></li><li><p><strong><code>void isa_vaddr_write(vaddr_t addr, uint32_t data, int len)</code></strong></p><p>同理</p></li></ol><h4>4.2.4.进程切换</h4><p>对于不同进程切换的情况，页目录基地址也会随之改变，因此需要跟随进程切换一同切换<code>satp</code>,在陷入后，立即将当前页目录基地址放入上下文进行保存。在操作执行完之后，立即更新当前的<code>satp</code>，因为进程切换了，所以<code>satp</code>要跟着切换</p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"415.75\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:870.140625px\" viewBox=\"0 0 870.141 415.75\"><defs><path id=\"b\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(435.07 207.875)\"><rect width=\"854.141\" height=\"399.75\" x=\"-427.07\" y=\"-199.875\" fill=\"#6495ed\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"68.266\" height=\"19\" transform=\"translate(0 -185.875) translate(-34.133 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nexus-am</div></foreignObject></g><g opacity=\"1\" transform=\"translate(435.07 207.875)\"><rect width=\"804.141\" height=\"359.75\" x=\"-402.07\" y=\"-179.875\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"156.766\" height=\"19\" transform=\"translate(0 -165.875) translate(-78.383 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">am/src/riscv32/nemu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(287.852 102.5)\"><rect width=\"183.297\" height=\"109\" x=\"-91.648\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"43.453\" height=\"19\" transform=\"translate(0 -40.5) translate(-21.727 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">trap.S</div></foreignObject></g><g opacity=\"1\" transform=\"translate(327.852 263.75)\"><rect width=\"539.703\" height=\"173.5\" x=\"-269.852\" y=\"-86.75\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"36.797\" height=\"19\" transform=\"translate(0 -72.75) translate(-18.398 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cte.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(729.922 268.75)\"><rect width=\"164.438\" height=\"198\" x=\"-82.219\" y=\"-99\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"43.641\" height=\"19\" transform=\"translate(0 -85) translate(-21.82 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">vme.c</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M146.203 258.75h25c8.333 0 16.667 0 34.202-22.792 17.535-22.791 44.272-68.375 57.64-91.166L276.414 122\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"M354.5 102.5h4.167c4.166 0 12.5 0 20.833 27.708 8.333 27.709 16.667 83.125 25 110.834 8.333 27.708 16.667 27.708 20.833 27.708h4.167\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#d)\" d=\"m543.433 249.25 9.045-4.167c9.045-4.166 27.135-12.5 40.347-16.666 13.211-4.167 21.545-4.167 29.878-4.167h50\"/><defs><marker id=\"d\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#e)\" d=\"m543.433 288.25 9.045 4.167c9.045 4.166 27.135 12.5 40.347 16.666 13.211 4.167 21.545 4.167 29.878 4.167H673.516\"/><defs><marker id=\"e\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(729.922 224.25)\"><rect width=\"114.438\" height=\"39\" x=\"-57.219\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"94.438\" height=\"19\" transform=\"translate(-47.219 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__get_cur_as</div></foreignObject></g><g opacity=\"1\" transform=\"translate(729.922 313.25)\"><rect width=\"112.813\" height=\"39\" x=\"-56.406\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"92.813\" height=\"19\" transform=\"translate(-46.406 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_switch</div></foreignObject></g><g opacity=\"1\" transform=\"translate(114.602 258.75)\"><rect width=\"63.203\" height=\"39\" x=\"-31.602\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"43.203\" height=\"19\" transform=\"translate(-21.602 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_yield</div></foreignObject></g><g opacity=\"1\" transform=\"translate(501.102 268.75)\"><rect width=\"143.203\" height=\"39\" x=\"-71.602\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"123.203\" height=\"19\" transform=\"translate(-61.602 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_irq_handle</div></foreignObject></g><g opacity=\"1\" transform=\"translate(287.852 102.5)\"><rect width=\"133.297\" height=\"39\" x=\"-66.648\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"113.297\" height=\"19\" transform=\"translate(-56.648 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_asm_trap</div></foreignObject></g></svg></p><ol><li><p><strong><code>_Context* __am_irq_handle(_Context *c)</code></strong></p><p>在开头调用<code>__get_cur_as</code>将当前的页目录基地址存储入当前的上下文。在结束时调用<code>__am_switch</code>将新的页目录基地址更新到<code>satp</code>中。</p></li></ol><h3>4.3.中断</h3><p>终端主要分为三个流程。其一是时钟，时钟每次被唤起都会将<code>cpu.INTR</code>置1。其二，<code>cpu</code>每次执行一次<code>exec_once</code>便会调用<code>isa_query_intr</code>判断是否需要中断，如果是则调用<code>raise_intr</code>进行自陷，来进行中断处理。因为我们不想在处理中断时被中断，因此在进入自陷前关掉中断并保存中断状态<code>sstatus.PIE</code>到<code>sstatus.SIE</code>，在出<code>sret</code>最后一步再进行恢复。其三，在进入自陷处理函数<code>__am_irq_handle</code>时需要判断自陷诱发原因是否是时钟中断，如果是则需要传递信息给事件处理函数<code>do_event</code></p><p><img src=\"https://s2.loli.net/2022/01/14/kw1d9YTRxKv7JZt.jpg\" alt=\"\" width=\"791\" height=\"195\" type=\"jpg\" blurdataurl=\"data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAb/xAAaEAEAAQUAAAAAAAAAAAAAAAAAAwYHN3XD/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/EABQRAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhEDEQA/AJu4+UKx2PGIAH//2Q==\"></p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"634.75\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:1802.796875px\" viewBox=\"0 0 1802.797 634.75\"><defs><path id=\"b\" d=\"M0 0z\"/><path id=\"d\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(1320.281 437.75)\"><rect width=\"476.5\" height=\"149\" x=\"-238.25\" y=\"-74.5\" fill=\"coral\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.188\" height=\"19\" transform=\"translate(0 -60.5) translate(-35.594 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nanos-lite</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1198.68 437.75)\"><rect width=\"183.297\" height=\"109\" x=\"-91.648\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"43.453\" height=\"19\" transform=\"translate(0 -40.5) translate(-21.727 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">trap.S</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1436.93 437.75)\"><rect width=\"193.203\" height=\"109\" x=\"-96.602\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"36.797\" height=\"19\" transform=\"translate(0 -40.5) translate(-18.398 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cte.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1701.664 437.75)\"><rect width=\"186.266\" height=\"149\" x=\"-93.133\" y=\"-74.5\" fill=\"#6495ed\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"68.266\" height=\"19\" transform=\"translate(0 -60.5) translate(-34.133 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nexus-am</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1701.664 437.75)\"><rect width=\"136.266\" height=\"109\" x=\"-68.133\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"33.5\" height=\"19\" transform=\"translate(0 -40.5) translate(-16.75 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">irq.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(520.016 317.375)\"><rect width=\"1024.031\" height=\"618.75\" x=\"-512.016\" y=\"-309.375\" fill=\"#a9a9a9\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"39.5\" height=\"19\" transform=\"translate(0 -295.375) translate(-19.75 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nemu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(362.648 532.25)\"><rect width=\"222.516\" height=\"149\" x=\"-111.258\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"25.578\" height=\"19\" transform=\"translate(0 -60.5) translate(-12.79 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cpu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(253.453 363.25)\"><rect width=\"440.906\" height=\"149\" x=\"-220.453\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"46.688\" height=\"19\" transform=\"translate(0 -60.5) translate(-23.344 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">device</div></foreignObject></g><g opacity=\"1\" transform=\"translate(765.469 308.75)\"><rect width=\"483.125\" height=\"561.5\" x=\"-241.563\" y=\"-280.75\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"77.641\" height=\"19\" transform=\"translate(0 -266.75) translate(-38.82 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">isa/riscv32</div></foreignObject></g><g opacity=\"1\" transform=\"translate(683.64 167)\"><rect width=\"269.469\" height=\"238\" x=\"-134.734\" y=\"-119\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"33.391\" height=\"19\" transform=\"translate(0 -105) translate(-16.695 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">exec</div></foreignObject></g><g opacity=\"1\" transform=\"translate(765.469 437.75)\"><rect width=\"433.125\" height=\"263.5\" x=\"-216.563\" y=\"-131.75\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"37.531\" height=\"19\" transform=\"translate(0 -117.75) translate(-18.766 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">intr.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(683.64 167)\"><rect width=\"219.469\" height=\"198\" x=\"-109.734\" y=\"-99\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"63\" height=\"19\" transform=\"translate(0 -85) translate(-31.5 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">system.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(129.695 363.25)\"><rect width=\"143.391\" height=\"109\" x=\"-71.695\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"50.797\" height=\"19\" transform=\"translate(0 -40.5) translate(-25.398 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">timer.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(362.648 363.25)\"><rect width=\"172.516\" height=\"109\" x=\"-86.258\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"45.922\" height=\"19\" transform=\"translate(0 -40.5) translate(-22.96 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_intr.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(362.648 532.25)\"><rect width=\"172.516\" height=\"109\" x=\"-86.258\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"39.375\" height=\"19\" transform=\"translate(0 -40.5) translate(-19.688 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cpu.c</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"3\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M423.906 363.25h125c8.334 0 16.667 0 34.902 10.833 18.235 10.834 46.372 32.5 60.44 43.334l14.07 10.833\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"M176.39 363.25h125.001\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#d\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#e)\" d=\"M768.375 122.5h25c8.333 0 16.667 0 25 36.792 8.333 36.791 16.667 110.375 30.004 159.666 13.337 49.292 31.678 74.292 40.848 86.792l9.17 12.5\"/><defs><marker id=\"e\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#d\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#f)\" d=\"M410.531 532.25h138.376c8.333 0 16.666 0 34.901-10.833 18.235-10.834 46.372-32.5 60.44-43.334l14.07-10.833\"/><defs><marker id=\"f\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#d\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#g)\" d=\"M744.938 447.75H818.375c8.333 0 16.667 0 25-.601 8.333-.601 16.667-1.803 20.833-2.404l4.167-.601\"/><defs><marker id=\"g\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#d\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"3\" stroke-width=\"2px\" marker-end=\"url(#h)\" d=\"M957.031 437.75h175\"/><defs><marker id=\"h\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#i)\" d=\"M1265.328 437.75h100\"/><defs><marker id=\"i\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#d\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#j)\" d=\"M1508.531 437.75h150\"/><defs><marker id=\"j\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#d\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(1436.93 437.75)\"><rect width=\"143.203\" height=\"39\" x=\"-71.602\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"123.203\" height=\"19\" transform=\"translate(-61.602 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_irq_handle</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1198.68 437.75)\"><rect width=\"133.297\" height=\"39\" x=\"-66.648\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"113.297\" height=\"19\" transform=\"translate(-56.648 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_asm_trap</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1701.664 437.75)\"><rect width=\"86.266\" height=\"39\" x=\"-43.133\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"66.266\" height=\"19\" transform=\"translate(-33.133 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">do_event</div></foreignObject></g><g opacity=\"1\" transform=\"translate(912.703 437.75)\"><rect width=\"88.656\" height=\"39\" x=\"-44.328\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"68.656\" height=\"19\" transform=\"translate(-34.328 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">raise_intr</div></foreignObject></g><g opacity=\"1\" transform=\"translate(683.64 447.75)\"><rect width=\"122.594\" height=\"39\" x=\"-61.297\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"102.594\" height=\"19\" transform=\"translate(-51.297 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">isa_query_intr</div></foreignObject></g><g opacity=\"1\" transform=\"translate(683.64 122.5)\"><rect width=\"169.469\" height=\"39\" x=\"-84.734\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"149.469\" height=\"19\" transform=\"translate(-74.734 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">make_EHelper(ecall)</div></foreignObject></g><g opacity=\"1\" transform=\"translate(683.64 211.5)\"><rect width=\"162.734\" height=\"39\" x=\"-81.367\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"142.734\" height=\"19\" transform=\"translate(-71.367 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">make_EHelper(sret)</div></foreignObject></g><g opacity=\"1\" transform=\"translate(362.648 363.25)\"><rect width=\"122.516\" height=\"39\" x=\"-61.258\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"102.516\" height=\"19\" transform=\"translate(-51.258 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">dev_raise_intr</div></foreignObject></g><g opacity=\"1\" transform=\"translate(129.695 363.25)\"><rect width=\"93.391\" height=\"39\" x=\"-46.695\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"73.391\" height=\"19\" transform=\"translate(-36.695 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">timer_intr</div></foreignObject></g><g opacity=\"1\" transform=\"translate(362.648 532.25)\"><rect width=\"95.766\" height=\"39\" x=\"-47.883\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"75.766\" height=\"19\" transform=\"translate(-37.883 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">exec_once</div></foreignObject></g></svg></p><p>由于时间原因，这个阶段虽然代码已经实现，但是还是有bug。</p><hr><h2>5.PA5 PAL pro</h2><h3>5.1.浮点数</h3><p>实现<code>navy-app/apps/pal/include/FLOAT.h</code>和<code>navy-apps/apps/src/FLOAT/FLOAT.c</code>就可以了</p><pre><code class=\"language-c\">//navy-app/apps/pal/include/FLOAT.h\nstatic inline int F2int(FLOAT a) {return (a &#x26;= 0xffff0000)>>16;}\nstatic inline FLOAT int2F(int a) {return a &#x3C;&#x3C; 16;}\nstatic inline FLOAT F_mul_int(FLOAT a, int b) {return a * b;}\nstatic inline FLOAT F_div_int(FLOAT a, int b) {return a / b;}\n</code></pre><pre><code class=\"language-c\">//navy-apps/apps/src/FLOAT/FLOAT.c\nFLOAT F_mul_F(FLOAT a, FLOAT b) {\n\tlong long c = (long long)a * (long long)b;\n\treturn (FLOAT)(c >> 16);\n}\n\nFLOAT F_div_F(FLOAT a, FLOAT b) {\n\tFLOAT p, q;\n\tasm volatile(\"idiv %2\" : \"=a\"(p), \"=d\"(q) : \"r\"(b), \"a\"(a &#x3C;&#x3C; 16), \"d\"(a >> 16));\n\treturn p;\n}\n\nFLOAT f2F(float a) {\n\tint b = *(int *)&#x26;a;\n\tint sign = b >> 31;\n\tint exp = (b >> 23) &#x26; 0xff;\n\tFLOAT c = b &#x26; 0x7fffff;\n\tif (exp != 0) {\n\t\tc += 1 &#x3C;&#x3C; 23;\n\t}\n\texp -= 150;\n\tif (exp &#x3C; -16) {\n\t\tc >>= -16 - exp;\n\t}\n\tif (exp > -16) {\n\t\tc &#x3C;&#x3C;= exp + 16;\n\t}\n\treturn sign == 0 ? c : -c;\n}\n\nFLOAT Fabs(FLOAT a) {\n\tFLOAT b;\n\tif (a > 0){\n\t\tb = a;\n\t} else {\n\t\tb = -a;\n\t}\n\treturn b;\n}\n</code></pre><h3>5.2.JIT</h3><p>这让👴怎么实现啊😅，看看得了，感觉龙芯说用LoongArch跑x86也是跟这个一样，做汇编级别的翻译。</p><hr>","renderType":"md","imageProps":{"src":"https://s2.loli.net/2022/05/21/irBOsuSDxvUzG6X.png","width":841,"height":1196,"type":"png","blurDataURL":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAAECAIAAADETxJQAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAMUlEQVQImWOYuO1/66SNdjZODP///b9+ZM/ZZd0MWbUzxWT0VDVsGHyjCzn5FRkYZAGWiQ/0yjg/IQAAAABJRU5ErkJggg=="},"language":"en"},"__N_SSG":true}