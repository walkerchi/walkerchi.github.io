{"pageProps":{"frontmatter":{"title":"[华科]数据库笔记","description":"华中科技大学 数据库笔记","date":"2021-7-4","image":"https://s2.loli.net/2022/05/21/xBCITtd3PXU2gih.jpg"},"content":"<h1>数据库</h1><h2>概论</h2><h3>特点</h3><p>结构化、共享度高，冗余度低、易扩展、数据独立性</p><h3>ER图</h3><ul><li>M:N关系需要一张表</li><li>N:1关系不需要表</li></ul><h3>数据模型</h3><ul><li><p>层次模型</p><ul><li>双亲是唯一的</li><li>只能处理一对多联系</li></ul></li><li><p>网状模型</p><ul><li>允许没有双亲</li><li>可以有多个双相亲</li><li>只能处理一对多联系</li></ul></li><li><p>关系模型（主流）</p></li></ul><h3>两级映像 三级模式</h3><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"57\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:338.3125px\" viewBox=\"0 0 338.313 57\"><defs><path id=\"b\" d=\"M0 0z\"/></defs><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M76 28.5h50\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"M178 28.5h50\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(42 28.5)\"><rect width=\"68\" height=\"41\" x=\"-34\" y=\"-20.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"5\" ry=\"5\"/><foreignObject width=\"48\" height=\"21\" transform=\"translate(-24 -10.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">内模式</div></foreignObject></g><g opacity=\"1\" transform=\"translate(152 28.5)\"><rect width=\"52\" height=\"41\" x=\"-26\" y=\"-20.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"5\" ry=\"5\"/><foreignObject width=\"32\" height=\"21\" transform=\"translate(-16 -10.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">模式</div></foreignObject></g><g opacity=\"1\" transform=\"translate(279.156 28.5)\"><rect width=\"102.313\" height=\"41\" x=\"-51.156\" y=\"-20.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"5\" ry=\"5\"/><foreignObject width=\"82.313\" height=\"21\" transform=\"translate(-41.156 -10.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">外模式View</div></foreignObject></g></svg></p><h2>关系数据库</h2><p><span class=\"math math-inline\">关系数据库操作语言\\begin{cases}关系代数语言\\\\关系演算语言\\\\结构化查询语言SQL\\end{cases}</span></p><p><span class=\"math math-inline\">关系：笛卡尔积中有意义的子集</span></p><p><span class=\"math math-inline\">元素：关系中每个元素（行）</span></p><p><span class=\"math math-inline\">属性：列名</span></p><p><span class=\"math math-inline\">候选码：最小能唯一表示一个元组的一组属性</span></p><p><span class=\"math math-inline\">全码：候选码是所有的属性</span></p><p><span class=\"math math-inline\">主码：候选码之一</span></p><p><span class=\"math math-inline\">主属性：候选码的属性</span></p><p><span class=\"math math-inline\">非码属性：任何候选码都不包含的属性</span></p><p><span class=\"math math-inline\">外码：在R中的属性组，在S中是主码</span></p><h3>关系完整性</h3><ul><li><p>实体完整性</p><p>主属性不能为空</p></li><li><p>参照完整性</p><p>外码必须为空或S的主码值</p></li><li><p>用户定义完整性</p></li></ul><h3>关系代数</h3><p>自然连接：删除重复列</p><ul><li><p><span class=\"math math-inline\">R(X,Y)\\div S(Y,Z)</span></p><p><span class=\"math math-inline\">R\\div S = \\{t[X]|t\\in R \\and Y_{t[X]} \\supseteq \\Pi_Y (S)\\}</span></p><p><span class=\"math math-inline\">R\\div S = \\Pi_X(R) - \\Pi_X(\\Pi_X(R)\\times \\Pi_Y(S) - R)</span></p><p><img src=\"https://img-blog.csdnimg.cn/20200824204535830.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2pvZXlfcm8=,size_16,color_FFFFFF,t_70#pic_center\" alt=\"在这里插入图片描述\" width=\"632\" height=\"385\" type=\"png\" blurdataurl=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAIAAAA7ljmRAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAMklEQVQImQEnANj/ACQkJAAAAWVlZf///wCfn58NDg9PT1CVlZUAr6+vV1hZxcfH5OTkEyYRYmAJawoAAAAASUVORK5CYII=\"></p></li></ul><h2>SQL</h2><h3>查询</h3><ul><li><p>列出至少有三门课程成绩在90分以上的学生学号和平均成绩</p><pre><code class=\"language-sql\">select sno,avg(grade) as avg_grade\r\nfrom sc sc1\r\ngroup by sno\r\nhaving (select count(*)\r\n        from sc\r\n        where sno=sc1.sno and grade>=90\r\n       )>=3\n</code></pre></li><li><p>exist 与 in 转换</p><pre><code class=\"language-sql\">select ... from T1 \r\nwhere C1 in (\r\n\tselect C2 from T2 \r\n\twhere ...\r\n)\r\nselect ... from T1\r\nwhere exists (\r\n\tselect * from T1 \r\n     where ... and C2=T1.C1\r\n)\n</code></pre></li><li><p>查询选修了全部课程的学生的姓名</p><pre><code class=\"language-sql\">select sname \r\nfrom student\r\nwhere not exists(\r\n\tselect * from course\r\n    where not exists(\r\n        \tselect * from sc\r\n            where sno=student.sno and cno = cources.cno\r\n        )\r\n)\r\n\r\nselect sname\r\nfrom student\r\nwhere not exists(\r\n\tselect * from course\r\n    where cno not in (\r\n    \tselect cno from sc \r\n        where sno = student.sno\r\n    )\r\n)\n</code></pre></li></ul><h2>关系数据理论</h2><h3>函数依赖</h3><p><span class=\"math math-inline\">若s[X]=t[X]则有s[Y]=t[Y]称X函数确定Y（Y函数依赖X，X\\rightarrow Y）</span></p><p><span class=\"math math-inline\">X\\rightarrow Y, Y\\nsubseteq X,则X\\rightarrow Y是非平凡的函数依赖</span></p><p><span class=\"math math-inline\">X\\rightarrow Y,且任意 X'\\in X \\Rightarrow X'\\nrightarrow Y，则Y完全依赖于X</span></p><p><span class=\"math math-inline\">主码候选码统称为码</span></p><p><span class=\"math math-inline\">Armstrong公理系统\\begin{cases}自反律:Y\\subseteq X\\Rightarrow X\\rightarrow Y\\\\赠广律:X\\rightarrow Y\\Rightarrow XZ\\rightarrow YZ\\\\传递律:X\\rightarrow Y,Y\\rightarrow Z\\Rightarrow X\\rightarrow Z\\end{cases}</span></p><p><span class=\"math math-inline\">X\\rightarrow Y \\Leftrightarrow X_F^+\\supseteq Y</span></p><p>候选码的属性一定不会在右侧出现</p><ul><li>计算最小依赖集<ol><li>右部单属性化</li><li>去掉多余函数依赖</li><li>去掉左部多余属性</li></ol></li><li>正则覆盖<ol><li>合并左侧相同的函数依赖</li><li>去掉每个函数中的无关属性</li></ol></li><li>求候选码<ol><li>找到不在右边出现的属性<span class=\"math math-inline\">N</span>，并计算闭包，如果闭包为U则终止</li><li>找到既在左部又在右部的属性集，将LR的子集并入<span class=\"math math-inline\">N</span>测试是否构成码</li></ol></li></ul><h3>范式</h3><ul><li><p>1NF</p><p>属性不可分</p><p>数据冗余、更新异常、插入异常、删除异常</p></li><li><p>2NF</p><p>非主属性完全依赖于码</p><p>数据冗余、更新异常、插入异常、删除异常</p></li><li><p>3NF</p><p>不允许：</p><div class=\"math math-display\">X\\rightarrow Y \\rightarrow Z\\\\ X:码\\quad Y:不含码\\quad Z:非主属性，且Z\\nsubseteq Y</div><p>没有非主属性对码的传递依赖</p><p>要么左侧是超码要么右侧是主属性</p><p>没有非主属性一定是3NF</p><p>数据冗余、更新异常、插入异常、删除异常</p><div class=\"math math-display\">若R\\in 3NF 则 R\\in 2NF \\\\ 证：\\\\ 假设R\\notin 2NF, 但R\\in 3NF\\\\ \\because R\\notin 2NF\\\\ \\therefore \\exist Y\\subset X, Y\\rightarrow Z\\Rightarrow X\\rightarrow Y\\rightarrow Z\\\\ R\\notin3NF矛盾</div></li><li><p>BCNF</p><p>非平凡函数依赖左侧包含候选码</p><div class=\"math math-display\">如果R\\in BCNF 则 R\\in 3NF \\\\ 证: \\\\ 设R\\in BCNF，但R\\notin 3NF \\\\ 则必存在码X，属性组Y，非主属性组Z： \\\\ X\\rightarrow Y,Y\\rightarrow Z, Y\\nrightarrow X, Z\\nsubseteq Y \\\\ 由BCNF定义Y必包含候选码，故有Y\\rightarrow X， 矛盾</div></li><li><p>4NF</p><p>所有非平凡函数依赖<span class=\"math math-inline\">X\\rightarrow \\rightarrow Y(Y\\nsubseteq X)</span>X都含有候选码</p><p>所有二值关系至少是4NF</p></li><li><p>5NF</p></li></ul><ol><li>二元关系最高到4NF</li><li>全主属性3NF，不一定到BCNF</li><li>全码一定是BCNF，不一定是是4NF</li><li>只有一个主属性一定是2NF不一定是3NF</li><li>只有一个非主属性，不一定到2NF</li></ol><h3>模式分解</h3><ul><li><p>判断无损链接</p><ul><li><p>方法一</p><ol><li>对每一个关系函数进行遍历，修改右侧，如果为a则都改为a</li><li>出现同花顺停止，则为无损链接</li></ol><p><img src=\"https://s2.loli.net/2022/06/18/m9Hlci1weGJCXvE.png\" alt=\"img\" width=\"1422\" height=\"710\" type=\"png\" blurdataurl=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAACCAIAAADwyuo0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAI0lEQVQImWNYsXJVTW1delbuyrUbGN69e8fGx8DAxPD//38AqGIMlAkmLosAAAAASUVORK5CYII=\"></p></li><li><p>方法二</p><p><span class=\"math math-inline\">U_1\\bigcap U_2\\rightarrow U_1 - U_2 \\in F^+</span></p></li></ul></li></ul><ol><li>若进要求分解具有无损链接性则分解一定能达到4NF</li><li>若仅要求分解保持函数依赖，则分解一定能达到3NF</li><li>若已具有无损链接性又保持函数依赖则分解一定能达到3NF，不一定达到BCNF</li></ol><ul><li><p>模式分解</p><p><img src=\"https://s2.loli.net/2022/06/18/PlwEeOWd32haKIm.png\" alt=\"img\" width=\"806\" height=\"324\" type=\"png\" blurdataurl=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAABCAIAAAB2XpiaAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAFUlEQVQImWMQFZVgYGBdv37Tv///ARNHBVSvlMjzAAAAAElFTkSuQmCC\"></p></li></ul><h2>查询处理</h2><h3>查询操作</h3><p><span class=\"math math-inline\">\\begin{cases}嵌套循环链接\\\\排序-合并方法\\\\索引链接\\\\hash链接\\end{cases}</span></p><h3>查询优化</h3><ul><li><p>例</p><p><img src=\"https://s2.loli.net/2022/06/18/iwD87nfZFgqsTO5.png\" alt=\"img\" width=\"776\" height=\"560\" type=\"png\" blurdataurl=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAIAAAA7ljmRAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAKklEQVQImWNwd3dnYGDMLyo5fe4Cw////zds2JCbk/v//38o5/r160AOAIaWGHTWiNpVAAAAAElFTkSuQmCC\"></p><p><img src=\"https://s2.loli.net/2022/06/18/MwJDST5hNfgPQbO.png\" alt=\"img\" width=\"815\" height=\"569\" type=\"png\" blurdataurl=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAIAAAA7ljmRAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAMklEQVQImQEnANj/AAAAAW1tbqmqr0dKSwCdnZ2enp+1tLidnZ0Avr6+////zc3Nzs7PWHEV2/G+A8wAAAAASUVORK5CYII=\"></p><p><img src=\"https://s2.loli.net/2022/06/18/GmjHWJDseEYkQKF.png\" alt=\"image-20210703180221065\" width=\"870\" height=\"590\" type=\"png\" blurdataurl=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAACCAIAAADwyuo0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAJUlEQVQImQEaAOX/AAwICAEAAykqK8vNzgD////Jx8jn5eXl4+J2Tw21ENucsgAAAABJRU5ErkJggg==\"></p><p><img src=\"https://s2.loli.net/2022/06/18/PlwEeOWd32haKIm.png\" alt=\"img\" width=\"806\" height=\"324\" type=\"png\" blurdataurl=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAABCAIAAAB2XpiaAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAFUlEQVQImWMQFZVgYGBdv37Tv///ARNHBVSvlMjzAAAAAElFTkSuQmCC\"></p><p><img src=\"https://s2.loli.net/2022/06/18/WTzOXLqvK518eIG.png\" alt=\"img\" width=\"788\" height=\"603\" type=\"png\" blurdataurl=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAIAAAA7ljmRAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAMklEQVQImQEnANj/AG1sbUlKSzQ5PKetsgDd3d+HhYVWVVWbnZsAKS4zAAABlpWU/v//OxQRFxulP9AAAAAASUVORK5CYII=\"></p><div class=\"math math-display\">嵌套循环代价：\\\\ 读块数=Br+\\frac{Br\\cdot Bs}{K-2}\\\\ 写块数=Br+\\frac{Br\\cdot Bs}{K-2}+\\frac{Frs\\cdot Nr\\cdot Ns}{Mrs}\\\\\\ 索引扫描代价:\\\\ 读块数=L+S\\\\ L:B+树层数</div></li></ul><h2>数据库恢复</h2><h3>事务的特性ACID</h3><ul><li>原子性</li><li>一致性</li><li>隔离性</li><li>持续性</li></ul><h3>故障</h3><ul><li>事务故障 UNDO</li><li>系统故障 UNDO+REDO</li><li>介质故障 REDO</li><li>计算机病毒</li></ul><h3>恢复</h3><ul><li><p>数据转储</p><ul><li>静态转储 动态转储</li><li>海量转储 增量转储</li></ul></li><li><p>日志文件</p><ol><li>从检查点开始扫描日志，UNDO队列初始化为ACTIVE队列，REDO队列初始化为空</li><li>UNDO队列总每个事务从后向前扫描日志UNDO</li><li>REDO对立中每个事务从前向后扫描日志REDO</li></ol><p><img src=\"https://s2.loli.net/2022/06/18/upXEGLKg7WetbCm.png\" alt=\"img\" width=\"757\" height=\"489\" type=\"png\" blurdataurl=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAACCAIAAADwyuo0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAI0lEQVQImWOwMDf39fH5////t2/fGE6dOsnIwGBtZTll8mQApGMMMesZ0LoAAAAASUVORK5CYII=\"></p></li></ul><h2>并发控制</h2><h3>数据不一致性</h3><ul><li>丢失更新</li><li>读脏数据</li><li>不可重复读</li></ul><h3>三级封锁</h3><p><span class=\"math math-inline\">\\begin{cases} X锁（写锁）\\\\ S锁（读锁）\\end{cases}</span></p><ul><li><p>一级封锁协议</p><p>事务写之前加X锁</p><p>防止丢失更新</p></li><li><p>二级封锁协议</p><p>事务写之前加X锁，读之前加S锁</p><p>防止丢失更新、读脏数据</p></li><li><p>三级封锁协议</p><p>事务写之前加X锁，事务读之前加S锁</p><p>防止丢失更新、读脏数据、不可重复读</p></li><li><p>活锁</p><p>解决：先来先服务</p></li><li><p>死锁</p><p><span class=\"math math-inline\">产生条件\\begin{cases}互斥\\\\不可剥夺\\\\部分分配\\\\环路\\end{cases}</span></p></li></ul><p><strong>可串行化是并行事务正确性的唯一标准</strong></p><p><strong>n个事务允许并发执行，最多有n种可能的正确结果</strong></p><p><strong>冲突可串行化调度一定是可串行化调度</strong></p><p><strong>不是冲突可串行化调度仍有可能是可串行化调度</strong></p><h3>并发调度可传行性</h3><p>不同事务，统一数据，读读操作可交换</p><p>不同事物，不同数据，皆可交换</p><h3>两段锁</h3><p>读写之前先封锁</p><p>释放封锁后不再申请锁</p><p><strong>三级封锁是两段锁的特例</strong></p><p><strong>两段锁协议是可串行化调度的充分不必要条件</strong></p><h3>多粒度封锁</h3><p><span class=\"math math-inline\">\\Join</span></p>","renderType":"md","imageProps":{"src":"https://s2.loli.net/2022/05/21/xBCITtd3PXU2gih.jpg","width":4325,"height":1440,"type":"jpg","blurDataURL":"data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAf/xAAbEAEAAAcAAAAAAAAAAAAAAAAAAwQGBzd1tP/EABUBAQEAAAAAAAAAAAAAAAAAAAED/8QAFhEBAQEAAAAAAAAAAAAAAAAAAAEx/9oADAMBAAIRAxEAPwC32XxpTuuk+WEAZiVf/9k="},"language":"cn"},"__N_SSG":true}