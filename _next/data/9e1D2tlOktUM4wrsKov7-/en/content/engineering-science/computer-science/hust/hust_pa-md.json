{"pageProps":{"frontmatter":{"title":"[åç§‘]è®¡ç®—æœºå­¦é™¢ç³»ç»Ÿè®­ç»ƒ","description":"åä¸­ç§‘æŠ€å¤§å­¦è®¡ç®—æœºå­¦é™¢ç³»ç»Ÿè®­ç»ƒ","date":"2022-1-9","image":"https://s2.loli.net/2022/05/21/irBOsuSDxvUzG6X.png"},"content":"<h1><span style=\"text-decoration:line-through;display:inline-box\">ICS PA 2019</span> <span>HUST PA</span></h1><div class=\"math math-display\"></div><div class=\"math math-display\">f_y = \\frac{x}{y}</div><div class=\"math math-display\">\\begin{cases} f_x = x+1\\\\ f_y = \\frac{x}{y} \\end{cases}</div><hr><p><span class=\"math math-inline\">walkerchi\\cdot 2022-1-9</span></p><hr><p>ç…§ç€NJU-PAåšå°±å¥½ï¼Œ<a href=\"https://zhuanlan.zhihu.com/p/413911195\">æ„Ÿè°¢æ±ªå…ˆå¥‡å¥†ä½¬æ‰‹æŠŠæ‰‹å…¥é—¨æ•™ç¨‹</a>ï¼Œæ•´ä¸ªè¿‡ç¨‹éå¸¸æŠ˜ç£¨ï¼Œæœ‰çš„æ—¶å€™ä¸ºäº†å®ç°ä¸€ä¸ªç®€å•çš„åŠŸèƒ½å¯ä»¥åæ±‡ç¼–è·Ÿè¸ªåˆ°äº†13å±‚å‡½æ•°è°ƒç”¨(æ²¡é”™ï¼Œå°±æ˜¯printf)ã€‚ æœ‰äº›åº“å‡½æ•°æ³¨é‡Šéƒ½æ˜¯ä¸Šä¸ªä¸–çºª70å¹´ä»£çš„ï¼Œå®ç°è¿‡ç¨‹å¤æ‚ç¹çï¼Œéå¸¸å¤šæ— ç”¨åŠŸï¼Œæºä»£ç æ”¹è¿›ç©ºé—´è¿˜æ˜¯å¾ˆå¤§çš„ã€‚è¿™ä¸ªé¡¹ç›®ä¸»è¦è¿˜æ˜¯å‘Šè¯‰æˆ‘ä»¬æ•´ä¸ªè®¡ç®—æœºç³»ç»Ÿå¦‚ä½•è¿è¡Œï¼Œæ‰€ä»¥è¿‡åˆ†çº ç»“ä»£ç é£æ ¼ä¼šç»™äººå¸¦æ¥æ— ç©·çš„ç—›è‹¦ğŸ’”ã€‚è·Ÿæˆ‘ä¸€åŒè¿‡æ¥äº¤æ¢çš„å…¶ä»–å­¦é™¢åŒå­¦éƒ½åœ¨å¾·å›½æ³•å›½è·å…°ç©ï¼Œè€Œæˆ‘æŠŠè‡ªå·±å…³åœ¨å®¶é‡Œå†™PA ğŸ’©ã€‚è¿™ä¸ªProjectæ•™å¯¼æˆ‘æœ€å¤šçš„ä¸æ˜¯è®¡ç®—æœºï¼Œè€Œæ˜¯å¦‚ä½•å¿ƒå¹³æ°”å’Œå¤„äº‹ğŸ™ã€‚å®šä¹å†…å¤–ä¹‹åˆ†ï¼Œè¾©æŠ¤è£è¾±ä¹‹å¢ƒï¼Œå¦‚ç©ºæ— è±¡ï¼Œæ¹›ç„¶åœ†æ»¡ã€‚</p><img src=\"https://s2.loli.net/2022/01/10/ohAz19NgHxL7nTQ.jpg\" style=\"zoom:30%;\" width=\"800\" height=\"800\" type=\"jpg\" blurdataurl=\"data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAEAAQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAX/xAAiEAABAwMDBQAAAAAAAAAAAAABAAMRBAUTAgYhBxIUIkH/xAAVAQEBAAAAAAAAAAAAAAAAAAACA//EABcRAQEBAQAAAAAAAAAAAAAAAAECACH/2gAMAwEAAhEDEQA/AJG1+rt/on78PHoHw7dX3RmzHHMDt0w4PUR9k8nlERSiZDhmrv/Z\"><hr><h2>0.PA0 ç¯å¢ƒé…ç½®</h2><p>è¿™ä¸ªé¡¹ç›®åœ¨ WSL2 Ubuntu20.04 ä¸Šå®Œæˆï¼Œä¼šé‡åˆ°å¾ˆå¤šå‘ï¼Œæ¯•ç«ŸWSLä¸æ˜¯çœŸæ­£çš„è™šæ‹Ÿæœºã€‚</p><h3>0.0å…‹éš†ä»“åº“</h3><p>è¿™ä¸€æ­¥åœ¨æ ¡å¤–çš„åŒå­¦éœ€è¦é€šè¿‡å­¦æ ¡VPNé“¾æ¥ã€‚ åœ¨åšPAæ—¶æˆ‘äººåœ¨å¾·å›½ï¼Œå¹¸å¥½ä¹‹å‰ä¸ºäº†åšç§‘ç ”åŠè¿‡VPNï¼Œç°åœ¨å°±æ–¹ä¾¿ä¸€äº›ã€‚</p><pre><code>git clone https://course.cunok.cn/pa/ics2019_1.git/\n</code></pre><p>åœ¨é˜…è¯»Makefileæºä»£ç åæˆ‘ä»¬å¯ä»¥å‘ç°åœ¨æ¯æ¬¡makeåéƒ½ä¼šè‡ªåŠ¨æ›´æ–°åˆ°gitä»“åº“ï¼Œååˆ†æ–¹ä¾¿ã€‚ä½†åŒæ—¶è¿™ä¹Ÿæ„å‘³ç€Makefileé”™ç»¼å¤æ‚ï¼Œç‰µä¸€å‘è€ŒåŠ¨å…¨èº«ã€‚</p><h3>0.1é…ç½®ç¯å¢ƒå˜é‡</h3><pre><code class=\"language-bash\">export STUID=UXXXXXXXXX              #å­¦å·ï¼Œç”¨äºæäº¤\nexport STUNAME=XXX                   #å§“åï¼Œç”¨äºæäº¤\nexport ICS_HOME=./ics2019            #ics2019 æ ¹ç›®å½•ä½ç½®ï¼Œæ–¹ä¾¿ä¿®æ”¹ç›®å½•ä½ç½®\nexport NANO_HOME=ICS_HOME/nanos-lite #nanos-lite ç®€æ˜“æ“ä½œç³»ç»Ÿ æ–‡ä»¶å¤¹ä½ç½®\nexport NAVY_HOME=ICS_HOME/navy-apps  #navy-apps è¿è¡Œè½¯ä»¶ æ–‡ä»¶å¤¹çˆ±ä½ç½®\nexport NEMU_HOME=ICS_HOME/nemu       #nemu ç®€æ˜“æŒ‡ä»¤é›† æ–‡ä»¶å¤¹ä½ç½®\nexport AM_HOME=ICS_HOME/nexus-am     #nexus-am ç®€æ˜“è£¸æœº æ–‡ä»¶å¤¹ä½ç½® \n</code></pre><p>å»ºè®®å†™åœ¨<strong>~/.bashrc</strong>ä¸­</p><h2>1.PA1 NEMUå…¥é—¨</h2><h3>1.1.ç®€æ˜“è°ƒè¯•å™¨</h3><p>è¿™é‡Œåªç”¨ç®€å•é˜…è¯»ä¸€ä¸‹ <code>nemu/src/monitor/debug/*</code> çš„ä»£ç å¹¶è¡¥å…¨å°±å¥½ã€‚</p><p>ä¸è¿‡åœ¨<code>info r</code>æŒ‡ä»¤ä¸­éœ€è¦ç”¨åˆ° <code>nemu/src/isa/riscv32/reg.c</code>ä¸­çš„<code>isa_reg_display</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å¾—è‡ªå·±è¡¥å…¨ã€‚</p><p>è¿™ä¸ªåé¢å¥½åƒæ²¡æ€ä¹ˆç”¨åˆ°ï¼Œå¯èƒ½æ˜¯æˆ‘æ‰“å¼€çš„æ–¹å¼ä¸å¯¹ğŸ˜…</p><p>æœ€éš¾çš„è«è¿‡äºpçš„å®ç°ï¼Œè€ƒéªŒä¸€äº›ç¼–è¯‘åŸç†ï¼Œç®€å•çš„è¡¨è¾¾å¼å¯ä»¥ä½¿ç”¨é€†æ³¢å…°å¼çš„æ±‚è§£æ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸ªéœ€è¦æ”¯æŒå¯„å­˜å™¨ä¸æŒ‡é’ˆè®¿é—®ï¼Œæ‰€ä»¥ä¸åŒï¼Œå¿…é¡»æŒ‰ç…§æ–‡æ¡£ä¸Šä½¿ç”¨é€’å½’æ±‚è§£ã€‚</p><table><thead><tr><th align=\"center\">å‘½ä»¤</th><th align=\"center\">è¯´æ˜</th></tr></thead><tbody><tr><td align=\"center\">help</td><td align=\"center\">å¸®åŠ©</td></tr><tr><td align=\"center\">c</td><td align=\"center\">ç»§ç»­è¿è¡Œ</td></tr><tr><td align=\"center\">q</td><td align=\"center\">é€€å‡º</td></tr><tr><td align=\"center\">si [N]</td><td align=\"center\">å•æ­¥æ‰§è¡ŒNæ­¥ï¼Œé»˜è®¤ä¸º1</td></tr><tr><td align=\"center\">info r/w</td><td align=\"center\">æ‰“å°å¯„å­˜å™¨/ç›‘è§†ç‚¹ä¿¡æ¯</td></tr><tr><td align=\"center\">p EXPR</td><td align=\"center\">æ±‚å‡ºè¡¨è¾¾å¼EXPRå€¼</td></tr><tr><td align=\"center\">x N EXPR</td><td align=\"center\">ä»EXPRå¼€å§‹æ‰“å°å†…å­˜Nä¸ªå­—é•¿å€¼</td></tr><tr><td align=\"center\">d N</td><td align=\"center\">åˆ é™¤åºå·ä¸ºNçš„ç›‘è§†ç‚¹</td></tr><tr><td align=\"center\">w EXPR</td><td align=\"center\">å½“EXPRä¸ºtrueæ—¶ç¨‹åºæš‚åœ</td></tr></tbody></table><h3>1.2.æµ‹è¯•</h3><p><code>nemu/</code>ç›®å½•ä¸‹ <code>make ISA=$ISA run</code></p><h3>1.3.æ³¨æ„äº‹é¡¹</h3><ol start=\"0\"><li>å­¦ä¼šé˜…è¯»Makefileï¼Œåœ¨åšPA1ã€PA2çš„æ—¶å€™åï¼Œæˆ‘é‡åˆ°çš„å¤§éƒ¨åˆ†æ˜¯MakefileæŠ¥é”™ï¼Œç”±äºä¹‹å‰æ²¡æœ‰æ³¨æ„åœ¨æ„è¯­è¨€ï¼Œæ‰€ä»¥èŠ±äº†å¾ˆå¤šåŠŸå¤«æ¥å­¦ä¹ Makefile.(ğŸ˜…è®ºä¸€ä¸ªæœ‰åŒ…ç®¡ç†å™¨å’Œé¡¹ç›®ç®¡ç†å™¨è¯­è¨€çš„é‡è¦æ€§ï¼Œè¿™é‡Œæ¨èRUSTã€GOã€JSï¼ŒPythonå°±ç®—äº†ï¼Œæ¯”åŒä¸ºåŠ¨æ€è¯­è¨€çš„JSæ•ˆç‡ä½åˆ°ä¸çŸ¥é“å“ªé‡Œå»äº†ï¼Œé™¤éä½ numbaæˆ–è€…cythonå¾ˆæºœï¼Œå¸Œæœ›åç§‘ä»¥åå‡ºä¸€ä¸ªæ›´friendlyä¸€ç‚¹çš„å®Œçˆ†å—å¤§)</li><li>ç¬¬ä¸€æ¬¡makeä¼šé‡åˆ°åŒ…æœªå®‰è£…çš„æƒ…å†µï¼ŒæŒ‰ç…§googleä¸Šä¸€é¡¹ä¸€é¡¹è§£å†³å°±å¥½äº†</li><li>RTFM <strong>R</strong>ead <strong>T</strong>he <strong>F</strong>ucking <strong>M</strong>anual å¾ˆå¤šå…³é”®é—®é¢˜æ–‡æ¡£ä¸Šä¸€å¸¦è€Œè¿‡ï¼Œç„¶åæ”¾ä¸€å¥RTFMè®©äººè¯»æ‰‹å†Œï¼Œç»™æˆ‘TMæ•´æ— è¯­äº†ğŸ˜…ï¼Œå¤šè¯´ä¸¤å¥è¯åˆä¸æ˜¯å°‘å‡ å¹´å¯¿å‘½ã€‚</li></ol><hr><h2>2.PA2 NEMU+NEXUS-AM</h2><p>è¿™ä¸ªå°±æ˜¯å®æ‰“å®çš„å®ç°RISCV32äº†ï¼Œé€æ¸å¼€å§‹ç¡¬æ ¸ã€‚å› ä¸ºCæ²¡æœ‰æ¥å£ï¼ˆè™šç±»ã€è™šå‡½æ•°ï¼‰ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡ä¸€ç³»åˆ—è®©æˆ‘æˆ‘å¼€çœ¼çš„å®å®šä¹‰æ¥è¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœã€‚</p><p>è¿™é‡Œè¯´ä¸€ä¸‹ä¸»è¦çš„è¿è¡Œæµç¨‹ã€‚<code>nemu/src/monitor/monitor.c</code>ä¸­çš„<code>cpu_exec</code>è°ƒç”¨äº†<code>nemu/src/cpu/cpu.c</code>ä¸­çš„<code>exec_once</code>ï¼Œè¿™ä¸ªå‡½æ•°åˆè°ƒç”¨äº†<code>nemu/src/isa/riscv32/exec/exec.c</code>ä¸­çš„<code>void isa_exec(vaddr_t *pc)</code>, è¯¥å‡½æ•°ä¸­çš„ä¸»è¦æ‰§è¡Œå‡½æ•°<code>static inline void idex(vaddr_t *pc, OpcodeEntry *e)</code>å’Œå®<code>IDEX</code>éƒ½å®šä¹‰åœ¨<code>nemu/include/cpu/exec.h</code>ä¸­ã€‚</p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"724.75\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:1134.203125px\" viewBox=\"0 0 1134.203 724.75\"><defs><path id=\"b\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(567.102 362.375)\"><rect width=\"1118.203\" height=\"708.75\" x=\"-559.102\" y=\"-354.375\" fill=\"#a9a9a9\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"39.5\" height=\"19\" transform=\"translate(0 -340.375) translate(-19.75 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nemu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(126.68 294.25)\"><rect width=\"187.359\" height=\"149\" x=\"-93.68\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"56.328\" height=\"19\" transform=\"translate(0 -60.5) translate(-28.164 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">monitor</div></foreignObject></g><g opacity=\"1\" transform=\"translate(685.781 233.375)\"><rect width=\"830.844\" height=\"410.75\" x=\"-415.422\" y=\"-205.375\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"20.625\" height=\"19\" transform=\"translate(0 -191.375) translate(-10.313 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(949.281 577.75)\"><rect width=\"303.844\" height=\"238\" x=\"-151.922\" y=\"-119\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"86.297\" height=\"19\" transform=\"translate(0 -105) translate(-43.148 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">include/cpu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(949.281 577.75)\"><rect width=\"253.844\" height=\"198\" x=\"-126.922\" y=\"-99\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"48.016\" height=\"19\" transform=\"translate(0 -85) translate(-24.008 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">exec.h</div></foreignObject></g><g opacity=\"1\" transform=\"translate(393.242 294.25)\"><rect width=\"195.766\" height=\"149\" x=\"-97.883\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"25.578\" height=\"19\" transform=\"translate(0 -60.5) translate(-12.79 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cpu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(808.664 233.375)\"><rect width=\"535.078\" height=\"370.75\" x=\"-267.539\" y=\"-185.375\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"77.641\" height=\"19\" transform=\"translate(0 -171.375) translate(-38.82 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">isa/riscv32</div></foreignObject></g><g opacity=\"1\" transform=\"translate(656.742 233.375)\"><rect width=\"181.234\" height=\"330.75\" x=\"-90.617\" y=\"-165.375\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"33.391\" height=\"19\" transform=\"translate(0 -151.375) translate(-16.695 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">exec</div></foreignObject></g><g opacity=\"1\" transform=\"translate(949.281 128)\"><rect width=\"203.844\" height=\"109\" x=\"-101.922\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"56.859\" height=\"19\" transform=\"translate(0 -40.5) translate(-28.43 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">docde.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(949.281 257)\"><rect width=\"203.844\" height=\"109\" x=\"-101.922\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"68.547\" height=\"19\" transform=\"translate(0 -40.5) translate(-34.273 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">all-instr.h</div></foreignObject></g><g opacity=\"1\" transform=\"translate(656.742 233.375)\"><rect width=\"131.234\" height=\"290.75\" x=\"-65.617\" y=\"-145.375\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"47.188\" height=\"19\" transform=\"translate(0 -131.375) translate(-23.594 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">exec.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(393.242 294.25)\"><rect width=\"145.766\" height=\"109\" x=\"-72.883\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"39.375\" height=\"19\" transform=\"translate(0 -40.5) translate(-19.688 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cpu.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(126.68 294.25)\"><rect width=\"137.359\" height=\"109\" x=\"-68.68\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"67.984\" height=\"19\" transform=\"translate(0 -40.5) translate(-33.992 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">monitor.c</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M170.36 294.25h174.999\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"M441.125 294.25h175\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#d)\" d=\"m664.439 274.75 9.653-24.458c9.654-24.459 28.96-73.375 42.78-97.834C730.693 128 739.027 128 747.36 128h125\"/><defs><marker id=\"d\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#e)\" d=\"m691.092 274.75 5.211-2.958c5.212-2.959 15.634-8.875 25.012-11.834C730.693 257 739.026 257 747.359 257h125.625\"/><defs><marker id=\"e\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#f)\" d=\"m691.092 313.75 5.211 2.958c5.212 2.959 15.634 8.875 25.012 11.834 9.378 2.958 17.711 2.958 26.044 2.958h75c8.334 0 16.667 0 36.179 30.375s50.202 91.125 65.547 121.5l15.345 30.375\"/><defs><marker id=\"f\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#g)\" d=\"m679.092 313.75 7.211 6.292c7.212 6.291 21.634 18.875 33.012 25.166 11.378 6.292 19.711 6.292 28.044 6.292h75c8.334 0 16.667 0 36.597 41.875s51.458 125.625 67.221 167.5l15.764 41.875\"/><defs><marker id=\"g\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(949.281 533.25)\"><rect width=\"50.219\" height=\"39\" x=\"-25.109\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"30.219\" height=\"19\" transform=\"translate(-15.11 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">idex</div></foreignObject></g><g opacity=\"1\" transform=\"translate(949.281 622.25)\"><rect width=\"51.75\" height=\"39\" x=\"-25.875\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"31.75\" height=\"19\" transform=\"translate(-15.875 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">IDEX</div></foreignObject></g><g opacity=\"1\" transform=\"translate(949.281 257)\"><rect width=\"152.594\" height=\"39\" x=\"-76.297\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"132.594\" height=\"19\" transform=\"translate(-66.297 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">make_EHelper(...)</div></foreignObject></g><g opacity=\"1\" transform=\"translate(949.281 128)\"><rect width=\"153.844\" height=\"39\" x=\"-76.922\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"133.844\" height=\"19\" transform=\"translate(-66.922 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">make_DHelper(...)</div></foreignObject></g><g opacity=\"1\" transform=\"translate(656.742 294.25)\"><rect width=\"81.234\" height=\"39\" x=\"-40.617\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"61.234\" height=\"19\" transform=\"translate(-30.617 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">isa_exec</div></foreignObject></g><g opacity=\"1\" transform=\"translate(393.242 294.25)\"><rect width=\"95.766\" height=\"39\" x=\"-47.883\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"75.766\" height=\"19\" transform=\"translate(-37.883 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">exec_once</div></foreignObject></g><g opacity=\"1\" transform=\"translate(126.68 294.25)\"><rect width=\"87.359\" height=\"39\" x=\"-43.68\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"67.359\" height=\"19\" transform=\"translate(-33.68 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cpu_exec</div></foreignObject></g></svg></p><p>å–å€é˜¶æ®µå·²ç»åœ¨<code>void isa_exec(vaddr_t *pc)</code>ä¸­å¸®æˆ‘ä»¬å®ç°å¥½äº†ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°æ‰€æœ‰æŒ‡ä»¤çš„è¯‘ç å’Œæ‰§è¡Œå°±å¯ä»¥äº†ã€‚ä¸ºäº†ä½¿ç”¨æˆ‘ä»¬åœ¨è¯‘ç å’Œæ‰§è¡Œå®šä¹‰çš„å‡½æ•°ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦å¯¹<code>nemu/src/isa/riscv32/exec/exec.c</code>ä¸­çš„åˆ†å‘ä¹Ÿå°±æ˜¯<code>static OpcodeEntry opcode_table</code>è¿›è¡Œä¿®æ”¹</p><p>è¿™é‡Œæ”¾ä¸Šæ‰€æœ‰éœ€è¦å®ç°çš„æŒ‡ä»¤ä»¥ä¾›å‚è€ƒã€‚</p><p><img src=\"https://s2.loli.net/2022/01/09/5VrksKp3RI4MedH.png\" alt=\"\" width=\"659\" height=\"875\" type=\"png\" blurdataurl=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAAECAIAAADETxJQAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAJElEQVQImSXIQQ0AQBCDQOygsH5qtJfc8ppAWzUJJxUgP7bdeBF/DOUBCQ23AAAAAElFTkSuQmCC\"></p><p><img src=\"https://s2.loli.net/2022/01/09/R7MOlTpjz1unV2I.png\" alt=\"\" width=\"1127\" height=\"342\" type=\"png\" blurdataurl=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAABCAIAAAB2XpiaAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAFUlEQVQImWOwtrH5////3r17GRgYACq4BegA1rRlAAAAAElFTkSuQmCC\"></p><h3>2.1.IDè¯‘ç </h3><p><strong>NEMU</strong>çš„è¯‘ç ä¸»è¦é€šè¿‡<code>nemu/src/isa/riscv32/decode.c</code>æ¥å®ç°ã€‚</p><p>åœ¨<code>enmu/src/isa/riscv32/exec/exec.c</code>ä¸­<code>opcode_table</code>æ•°ç»„çš„æ¯ä¸€ä¸ª<code>IDEX</code>ï¼ˆä¸ä¸º<code>EMPTY</code>ï¼‰éƒ½è°ƒç”¨äº†è¯‘ç å‡½æ•°ï¼ˆç¬¬ä¸€ä¸ªå‚æ•°ï¼‰å’Œæ‰§è¡Œå‡½æ•°ï¼ˆç¬¬äºŒä¸ªå‚æ•°ï¼‰</p><p>å…¶ä¸­æ¯”è¾ƒè´¹è§£çš„æ˜¯<code>make_DHelper</code>ï¼Œè¿™ä¸ªå®æ˜¯ä¸ºäº†ä¿è¯å‡½æ•°æ¥å£çš„ä¸€è‡´ï¼Œåœ¨<code>nemu/include/cpu/decode.h</code>ä¸­å®šä¹‰çš„ï¼Œå‡½æ•°è¾“å…¥æ¥å£ä¸º<code>(vaddr *pc)</code></p><p><img src=\"https://s2.loli.net/2022/01/09/gjC64M837ZRzywB.png\" alt=\"RISCV32-TPYE\" width=\"1164\" height=\"388\" type=\"png\" blurdataurl=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAABCAIAAAB2XpiaAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAEklEQVQImWNYBAYMDAz///8HACoZBsr6y/UfAAAAAElFTkSuQmCC\"></p><p>RISCV32 æŒ‡ä»¤å¯ä»¥å¤§è‡´åˆ†ä¸º<span class=\"math math-inline\">R,I,S,B,U,J</span>äº”ç§æŒ‡ä»¤ï¼Œä½†æ˜¯è¿™äº›æŒ‡ä»¤æœ‰äº›å˜ä½“ï¼Œæ‰€ä»¥åœ¨<code>nemu/src/isa/riscv32/decode.c</code>ä¸­è¿½åŠ å®ç°æ—¶éœ€è¦æ›´å¤šçš„å‡½æ•°</p><h3>2.2.EXæ‰§è¡Œ</h3><p><strong>NEMU</strong>çš„æ‰§è¡Œåˆ†æ•£åˆ°äº†<code>nemu/src/isa/riscv32/exec</code>æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶é‡Œï¼Œåœ¨<code>all-instr.h</code>é‡Œè¿›è¡Œå£°æ˜ï¼Œå‰©ä¸‹çš„<code>*.c</code>æ–‡ä»¶é‡Œçœ‹ä¸ªäººå–œå¥½å¡«å†™å‡½æ•°å®ç°ï¼Œå¯ä»¥å…¨éƒ¨å†™åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œï¼Œä¹Ÿå¯ä»¥æŒ‰ç…§åŠŸèƒ½è¿›è¡Œåˆ†ç±»ã€‚ä¸<code>make_DHelper</code>ç±»ä¼¼ï¼Œ<code>make_EHelper</code>è¢«å®šä¹‰åœ¨<code>nemu/include/cpu/exec.h</code>ä¸­</p><p>åœ¨è¿™é‡Œæˆ‘è®¤ä¸ºéœ€è¦è§£é‡Šä¸€ä¸‹<code>rtl_lr</code>å’Œ<code>rtl_sr</code>ä¸¤ä¸ªå‡½æ•°ï¼Œä»–ä»¬åˆ†åˆ«å®šä¹‰åœ¨<code>nemu/src/isa/riscv32/include/isa/rtl.h</code>æ–‡ä»¶ä¸­ï¼Œä¸»è¦ä½œç”¨æ˜¯å¯¹å¯¹åº”åºå·çš„å¯„å­˜å™¨åš<span class=\"math math-inline\">load</span>æˆ–è€…<span class=\"math math-inline\">save</span>æ“ä½œï¼Œè¿™æ ·å¯ä»¥ä¿è¯å¯„å­˜å™¨å†…æ•°æ®çš„å®‰å…¨ã€‚</p><p>æœ‰çš„ç»“æœä¸èƒ½ä¸€æ¬¡å¾—åˆ°ï¼Œå› æ­¤å¾€å¾€é€šè¿‡ä¸­é—´å¯„å­˜å™¨<code>s0</code>æ¥æš‚å­˜ã€‚</p><p>åœ¨å®ç°CSRå¯„å­˜å™¨æ—¶ï¼Œç”±äºæ²¡æœ‰çœ‹RISCV32æ‰‹å†Œï¼Œéƒ½æ˜¯é€šè¿‡åæ±‡ç¼–æ¥è§‚å¯Ÿçš„ï¼Œæ€»ç»“å‡ºæ¥äº†ä¸€ä¸‹è§„å¾‹ï¼š</p><table><thead><tr><th align=\"center\">CSRå¯„å­˜å™¨</th><th align=\"center\">CSRå¯„å­˜å™¨åºå·</th></tr></thead><tbody><tr><td align=\"center\">SSTATUS</td><td align=\"center\">0x100</td></tr><tr><td align=\"center\">STVEC</td><td align=\"center\">0x105</td></tr><tr><td align=\"center\">SEPC</td><td align=\"center\">0x141</td></tr><tr><td align=\"center\">SCAUSE</td><td align=\"center\">0x142</td></tr><tr><td align=\"center\">SATP</td><td align=\"center\">0x180</td></tr></tbody></table><p>å…³äºCSRæŒ‡ä»¤ï¼Œç½‘ä¸Šèµ„æ–™å°‘è€Œæ•£ï¼Œè€Œä¸”æœ‰çš„æœ‰è¯¯å¯¼ï¼Œè¿™é‡Œæˆ‘ç»Ÿä¸€æ•´ç†ä¸€ä¸‹ã€‚</p><p>é¦–å…ˆï¼ŒCSRæŒ‡ä»¤éƒ½æ˜¯Iå‹æŒ‡ä»¤ï¼Œè¿™é‡Œçš„å¯¹CSRRçš„ç´¢å¼•æ˜¯æ‰¾CSRå¯„å­˜å™¨åºå·å¯¹åº”çš„CSRå¯„å­˜å™¨ï¼Œå› æ­¤è¿˜éœ€è¦è‡ªå·±å®ç°åºå·å’Œå¯„å­˜å™¨ä¹‹é—´æ˜ å°„çš„å‡½æ•°ã€‚</p><ol><li><p><code>csrrw imm rd rs1</code></p><p><code>CSRR[imm]->rd, rs1->CSRR[imm]</code></p></li><li><p><code>csrrs imm rd rs1</code></p><p><code>CSRR[imm]->rd, rs1|CSRR[imm]->CSRR[imm]</code></p></li><li><p><code>csrrc</code></p><p><code>CSRR[imm]->rd, (~rs1)&#x26;CSRR[imm]->CSRR[imm]</code></p></li><li><p><code>csrrwi imm1 rd imm2</code></p><p><code>CSRR[imm1]->rd, imm2->CSRR[imm1]</code></p></li><li><p><code>csrrsi imm1 rd imm2</code></p><p><code>CSRR[imm1]->rd, imm2|CSRR[imm1]->CSRR[imm1]</code></p></li><li><p><code>csrrci imm1 rd imm2</code></p><p><code>CSRR[imm1]->rd, (~imm2)&#x26;CSRR[imm1]->CSRR[imm1]</code></p></li><li><p><code>ecall</code></p><p><code>pc+4->CSRR[SEPC], a7->CSRR[SCAUSE], CSRR[STVEC]->pc</code></p></li><li><p><code>sret</code></p><p><code>CSRR[SEPC]->pc</code></p></li></ol><p>æ³¨æ„ï¼Œ<code>nemu/src/isa/riscv32/include/isa/reg.h</code>å’Œ<code>nemu/src/isa/riscv32/reg.c</code>éƒ½æ²¡æœ‰å®ç°<code>CSR</code>å¯„å­˜å™¨ï¼Œéœ€è¦è‡ªå·±è¡¥ä¸Šå»</p><h3>2.3.è¾“å…¥è¾“å‡º</h3><p>è¿™é‡Œéœ€è¦åˆ†åˆ«å®ç°é”®ç›˜ã€è®¡æ—¶å™¨å’Œè§†é¢‘çš„IOï¼Œä»–ä»¬åœ¨æ–‡ä»¶å¤¹<code>nexus-am/am/src/nemu-common</code>æ–‡ä»¶å¤¹ä¸‹ï¼Œåˆ†åˆ«ä¸º<code>nemu-input.c</code>ï¼Œ<code>nemu-timer.c</code>å’Œ<code>nemu-video.c</code></p><p><code>nexus-am/am/src/nemu-common/ioe.c</code>ä¸­çš„<code>_io_read</code>å’Œ<code>_io_write</code>å‡½æ•°ä¼šè½¬å‘ä¿¡æ¯åˆ°ä»¥ä¸Šçš„ä¸‰ä¸ªå‡½æ•°ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºæˆ‘æ˜¯ç”¨çš„Vscode--RemoteWSL--WSL2çš„å¼€å‘æ¨¡å¼ï¼Œæ‰€ä»¥SDLåº“æ˜¯æ— æ³•æ£€æµ‹åˆ°é”®ç›˜ä¿¡æ¯çš„ï¼Œæˆ‘è¿˜ç‰¹æ„å†™äº†ä¸€æ®µä»£ç è¿›è¡Œæµ‹è¯•ã€‚å¦‚æœä½ åŒæ ·ä½¿ç”¨çš„WSL2ï¼Œè¯·ä¸‹è½½è¿œç¨‹æ¡Œé¢ï¼Œé€šè¿‡æ¡Œé¢è¿›è¡Œè°ƒè¯•ï¼Œæˆ‘æ˜¯ç”¨çš„æ˜¯vnc+xrdp.</p><ol><li><strong><code>size_t __am_input_read(uintptr_t reg, void *buf, size_t size)</code></strong></li></ol><p>â€‹ åœ¨<code>nemu-input.c</code>ä¸­æˆ‘ä»¬ä¸éœ€è¦è€ƒè™‘é”®ç›˜çš„æ©ç ï¼Œåªéœ€è¦ä»<code>0xa1000060</code>è¯»å‡ºå€¼ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºç©ºå’Œèµ‹ å€¼å°±å¥½äº†ã€‚</p><ol start=\"2\"><li><strong><code>size_t __am_timer_read(uintptr_t reg, void *buf, size_t size)</code></strong></li></ol><p>â€‹ åœ¨<code>nemu-timer.c</code>ä¸­åªéœ€è¦å®ç°<code>_DEVERG_TIMER_UPTIME</code>çš„æƒ…å†µï¼Œä»<code>0xa1000048</code>è¯»å‡ºæ—¶é—´ï¼Œå‡å»å¼€æœº æ—¶é—´èµ‹å€¼ç»™<code>uptime->lo</code>å°±å¯ä»¥äº†ã€‚</p><ol start=\"3\"><li><strong><code>size_t __am_video_read(uintptr_t reg, void *buf, size_t size)</code></strong></li></ol><p>â€‹ åœ¨<code>nemu-video.c</code>ä¸­æ˜¯ä¸ªç”»çŸ©å½¢å‡½æ•°ï¼Œå°†çŸ©å½¢å¯¹åº”ä½ç½®çš„å›¾åƒä¿¡æ¯å†™å…¥ <code>0xa0000000</code>ã€‚è¿™ä¸ªä¸ªäººæ„Ÿè§‰ éå¸¸ä½æ•ˆï¼Œä½¿å¾—åé¢PA3çš„æ¥å£è°ƒç”¨æ•ˆç‡å¤§å¤§é™ä½ã€‚</p><h3>2.4 klib</h3><p>â€‹\tä¸ºäº†ä¿è¯æµ‹è¯•çš„é¡ºåˆ©ï¼Œè¿˜éœ€è¦å®ç°<code>nexus-am/libs/klib/src</code>ä¸‹çš„ä¸€äº›å‡½æ•°</p><p><strong><code>nexus-am/libs/klib/src/stdio.c</code></strong></p><ol><li><p><code>int my_printf(const char *fmt, ...)</code></p><p>æˆ‘å°±ç›´æ¥è°ƒç”¨<code>my_vsprintf</code>äº†</p></li><li><p><code>int my_vsprintf(char *out, const char *fmt, va_list ap)</code></p><p>ç›´æ¥ä¸Šä»£ç </p><pre><code class=\"language-c\">int itoa_helper(char *out, int ptr, uint32_t valint, int base){\n  assert(valint>=0);\n  int stack[128],sptr=0;\n  if(valint==0)out[ptr++]='0';\n  else{\n    for(;valint;stack[sptr++]=valint%base,valint=valint/base);\n    for(--sptr;sptr>=0;--sptr){\n      if(stack[sptr]&#x3C;10)out[ptr++]=stack[sptr]+'0';\n      else if(stack[sptr]&#x3C;16)out[ptr++]=stack[sptr]-10+'a';\n      else{\n        assert(0);\n      }\n    }\n  }\n  return ptr;\n}\nint my_vsprintf(char *out, const char *fmt, va_list ap) {\n  int ptr=0;\n  for(;*fmt;++fmt){\n    if(*fmt!='%')out[ptr++]=*fmt;\n    else{\n      switch(*(++fmt)){\n        case 'c':{\n          char c = va_arg(ap,int);\n          out[ptr++]=c;\n          break;\n        }\n        case 'd':{\n          int valint=va_arg(ap,int);\n          if(valint&#x3C;0){\n            out[ptr++]='-';\n            valint=-valint;\n          }\n          ptr = itoa_helper(out,ptr,valint,10);\n          break;\n        }\n        case 'x':{\n          uint32_t valint=va_arg(ap,uint32_t);\n          ptr = itoa_helper(out,ptr,valint,16);\n          break;\n        }\n        case 's':{\n          const char* valstr=va_arg(ap,char*);\n          for(;*valstr;out[ptr++]=*valstr++);\n          break;\n        }\n        case 'f':{\n          float valflt=va_arg(ap,float);\n          if(valflt&#x3C;0){\n            out[ptr++]='-';\n            valflt=-valflt;\n          }\n          int tmpint=(int)valflt;\n          int tmpflt=(int)(10000*(valflt-tmpint));\n          ptr=itoa_helper(out,ptr,tmpint,10);\n          out[ptr++]='.';\n          ptr=itoa_helper(out,ptr,tmpflt,10);\n          break;\n        }\n        default:{\n          out[ptr++]='%';\n          out[ptr++]=*fmt;\n          break;\n        }\n      }\n    }\n  }\n  out[ptr]=0;\n  return ptr;\n}\n</code></pre></li><li><p><code>int my_sprintf(char *out, const char *fmt, ...)</code></p></li><li><p><code>int my_snprintf(char *out, size_t n, const char *fmt, ...)</code></p></li></ol><p><strong><code>nexus-am/libs/klib/src/string.c</code></strong></p><ol><li><p><code>size_t my_strlen(const char *s)</code></p></li><li><p><code>char *my_strcpy(char* dst,const char* src)</code></p></li><li><p><code>char* my_strncpy(char* dst, const char* src, size_t n)</code></p></li><li><p><code>char* my_strcat(char* dst, const char* src)</code></p></li><li><p><code>int my_strcmp(const char* s1, const char* s2)</code></p></li><li><p><code>int my_strncmp(const char* s1, const char* s2, size_t n)</code></p></li><li><p><code>void* my_memset(void* v,int c,size_t n)</code></p><p>å¯ä»¥å¾ªç¯å±•å¼€ï¼Œä¹Ÿå¯ä»¥æŠŠä¸€ä¸ªå­—èŠ‚å˜æˆå››å­—èŠ‚ï¼Œå¤ªæ…¢äº†è¿™ä¸ªå‡½æ•°ï¼Œç½‘ä¸Šæœ‰è¶…è¶ŠåŸç‰ˆcè¯­è¨€<code>memset</code>çš„å†™æ³•</p></li><li><p><code>void* my_memcpy(void* out, const void* in, size_t n)</code></p><p>åŒä¸Š</p></li><li><p><code>void* my_memcpy(void* out, const void* in, size_t n)</code></p></li><li><p><code>int my_memcmp(const void* s1, const void* s2, size_t n)</code></p></li></ol><h3>2.5.æµ‹è¯•</h3><ol><li><p>åœ¨<code>nexus-am/tests/cputest</code> ä¸­æ‰§è¡Œ<code>make ALL=xxx run</code>æ¥æµ‹è¯•cpuçš„è¿è¡Œçš„æ­£ç¡®æ€§,è¿™é‡Œçš„<code>xxx</code>å¯ä»¥ä½¿<code>nexus-am/tests/cputest/tests</code>ç›®å½•ä¸‹çš„ä»»ä½•ä¸€ä¸ªåå­—ã€‚</p></li><li><p>åœ¨<code>nexus-am/tests/amtest/</code>ä¸­æ‰§è¡Œ<code>make ARCH=native mainargs=H run</code>æ¥æµ‹è¯•è¾“å…¥è¾“å‡ºçš„æ­£ç¡®æ€§ï¼Œå…¶ä¸­<code>mainargs</code>çš„å‚æ•°å¯ä»¥æ ¹æ®æµ‹è¯•çš„é¡¹ç›®ç›¸åº”ä¿®æ”¹ï¼Œä¹Ÿå¯ä»¥åœ¨<code>nemu/</code>ç›®å½•ä¸‹è¿è¡Œ<code>bash runall.sh ISA=riscv32</code>æ¥è¿›è¡Œæ‰¹æµ‹è¯•ã€‚</p></li><li><p>åœ¨<code>nexus-am/apps/*</code>æ–‡ä»¶å¤¹ä¸‹æœ‰å„ç§æµ‹è¯•å¯ä»¥è¿›å…¥æ–‡ä»¶å¤¹è¿è¡Œ<code>make run</code>æ¥æµ‹è¯•ç¨‹åº</p></li></ol><h3>2.5.æ³¨æ„äº‹é¡¹</h3><ol><li>ä½¿ç”¨WSL2çš„åŒå­¦éœ€è¦å®‰è£…è¿œç¨‹æ¡Œé¢æ¥è§£å†³SDLè½¬å‘çš„é—®é¢˜ï¼Œç›®å‰ä¸çŸ¥é“å¦‚ä½•é€šè¿‡Vscode çš„RemoteWSLè½¬å‘</li><li><code>nemu/src/isa/riscv32/include/isa/reg.h</code>å’Œ<code>nemu/src/isa/riscv32/reg.c</code>éƒ½æ²¡æœ‰å®ç°<code>CSR</code>å¯„å­˜å™¨ï¼Œéœ€è¦è‡ªå·±è¡¥ä¸Šå»</li></ol><hr><h2>3.PA3 Nanos-Lite</h2><h3>3.1.ç³»ç»Ÿè°ƒç”¨</h3><p>é¦–å…ˆåœ¨<code>nanos-lite/</code>ç›®å½•ä¸‹è¿è¡Œ<code>make ARCH=riscv32 run</code>è¯•ä¸€ä¸‹ï¼ˆæ³¨æ„å¼€<code>nemu/include/common.h</code>ä¸­çš„<code>DEBUG</code>ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ‰“å°æ—¥å¿—æ¥debugäº†ï¼‰ã€‚é€šè¿‡è§‚å¯Ÿ<code>nanos-lite/nemu-log.txt</code>å’Œ<code>nanos-lite-riscv32-nemu.txt</code>ä»¥åŠ<code>ramdisk.asm</code>æ¥è¿›è¡Œdebugã€‚</p><p><strong>ç¼–è¯‘è¿‡ç¨‹</strong>è¿™é‡Œè¯´ä¸€ä¸‹ä¸»è¦çš„ç¼–è¯‘æµç¨‹<code>nanos-lite/build/nano-lite-riscv32-nemu.txt</code>ä½œä¸ºæ“ä½œç³»ç»Ÿä¼šè¿è¡Œ<code>nanos-lite/build/ramdisk.asm</code>ä¸­çš„ç¨‹åºï¼Œé€šè¿‡è§‚å¯Ÿ<code>nanos-lite/Makefile</code>å¯ä»¥å‘ç°ï¼Œæ¯æ¬¡<code>make ARCH=riscv32 run</code>ä¼šç¼–è¯‘<code>navy-apps/tests/*</code>å’Œ<code>navy-apps/apps/*</code>å¹¶æ”¾å…¥<code>navy-apps/fsimg</code>ï¼Œç„¶åå…¨éƒ¨copyè¿‡æ¥ä½œä¸º<code>nanos-lite/build/ramdisk.img</code>ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªriscvå·¥å…·é“¾æ¥åæ±‡ç¼–<code>nanos-lite/build/ramdisk.img</code>æ¥æŸ¥çœ‹å†…å®¹</p><pre><code class=\"language-bash\">riscv64-unknown-elf-objdump -d nanos-lite/build/ramdisk.img > nanos-lite/build/ramdisk.asm\n</code></pre><p><strong>è¿è¡Œè¿‡ç¨‹</strong>å†æ¥è¯´ä¸€ä¸‹è¿è¡Œæµç¨‹ï¼Œé¦–å…ˆ<code>nexus-am/am/src/riscv32/nemu/boot/start.S</code>ä¼šè¿è¡Œ<code>_start</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè·³è½¬åˆ°<code>nexus-am/am/src/riscv32/nemu-common/trm.c</code>çš„<code>void _trm_init()</code>ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨<code>nanos-lite/src/main.c</code>ä¸­çš„<code>int main(const char *args)</code>ï¼Œä¹Ÿå°±æ˜¯<strong>NANOS</strong>çš„å…¥å£ã€‚åœ¨å®Œæˆä¸€äº›åˆ—åˆå§‹åŒ–æ—¶ï¼Œåœ¨<code>nanos-lite/src/proc.c</code>ä¸­çš„<code>void init_proc()</code>å¼€å§‹ä»<code>ramdisk.img</code>è£…è½½ç¨‹åºï¼Œå¹¶è·³è½¬è¯¥ç¨‹åºè¿›è¡Œæ‰§è¡Œã€‚</p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"245\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:1134.71875px\" viewBox=\"0 0 1134.719 245\"><defs><path id=\"b\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(1063.781 122.5)\"><rect width=\"125.875\" height=\"149\" x=\"-62.938\" y=\"-74.5\" fill=\"#7fffd4\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.469\" height=\"19\" transform=\"translate(0 -60.5) translate(-35.734 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">navy-apps</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1063.781 122.5)\"><rect width=\"75.875\" height=\"109\" x=\"-37.938\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"34.375\" height=\"19\" transform=\"translate(0 -40.5) translate(-17.188 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">tests</div></foreignObject></g><g opacity=\"1\" transform=\"translate(756.219 122.5)\"><rect width=\"389.25\" height=\"189\" x=\"-194.625\" y=\"-94.5\" fill=\"coral\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.188\" height=\"19\" transform=\"translate(0 -80.5) translate(-35.594 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nanos-lite</div></foreignObject></g><g opacity=\"1\" transform=\"translate(756.219 122.5)\"><rect width=\"339.25\" height=\"149\" x=\"-169.625\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"20.625\" height=\"19\" transform=\"translate(0 -60.5) translate(-10.313 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(664.094 122.5)\"><rect width=\"105\" height=\"109\" x=\"-52.5\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"48.797\" height=\"19\" transform=\"translate(0 -40.5) translate(-24.398 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">main.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(833.719 122.5)\"><rect width=\"134.25\" height=\"109\" x=\"-67.125\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"45.438\" height=\"19\" transform=\"translate(0 -40.5) translate(-22.719 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">proc.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(259.797 122.5)\"><rect width=\"503.594\" height=\"229\" x=\"-251.797\" y=\"-114.5\" fill=\"#6495ed\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"68.266\" height=\"19\" transform=\"translate(0 -100.5) translate(-34.133 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nexus-am</div></foreignObject></g><g opacity=\"1\" transform=\"translate(259.797 122.5)\"><rect width=\"453.594\" height=\"189\" x=\"-226.797\" y=\"-94.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"50.703\" height=\"19\" transform=\"translate(0 -80.5) translate(-25.352 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">am/src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(139.094 122.5)\"><rect width=\"162.188\" height=\"149\" x=\"-81.094\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"138.5\" height=\"19\" transform=\"translate(0 -60.5) translate(-69.25 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">riscv32/nemu/boot</div></foreignObject></g><g opacity=\"1\" transform=\"translate(365.89 122.5)\"><rect width=\"191.406\" height=\"149\" x=\"-95.703\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"105.766\" height=\"19\" transform=\"translate(0 -60.5) translate(-52.883 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nemu-common</div></foreignObject></g><g opacity=\"1\" transform=\"translate(365.89 122.5)\"><rect width=\"141.406\" height=\"109\" x=\"-70.703\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"39.641\" height=\"19\" transform=\"translate(0 -40.5) translate(-19.82 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">trm.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(139.094 122.5)\"><rect width=\"112.188\" height=\"109\" x=\"-56.094\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"47.359\" height=\"19\" transform=\"translate(0 -40.5) translate(-23.68 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">start.S</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M170.188 122.5h149.999\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"M411.594 122.5h225\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#d)\" d=\"M691.594 122.5h100\"/><defs><marker id=\"d\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#e)\" d=\"M875.844 122.5h175\"/><defs><marker id=\"e\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(1063.781 122.5)\"><rect width=\"25.875\" height=\"39\" x=\"-12.938\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"5.875\" height=\"19\" transform=\"translate(-2.938 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">*</div></foreignObject></g><g opacity=\"1\" transform=\"translate(833.719 122.5)\"><rect width=\"84.25\" height=\"39\" x=\"-42.125\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"64.25\" height=\"19\" transform=\"translate(-32.125 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">init_proc</div></foreignObject></g><g opacity=\"1\" transform=\"translate(664.094 122.5)\"><rect width=\"55\" height=\"39\" x=\"-27.5\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"35\" height=\"19\" transform=\"translate(-17.5 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">main</div></foreignObject></g><g opacity=\"1\" transform=\"translate(365.89 122.5)\"><rect width=\"91.406\" height=\"39\" x=\"-45.703\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"71.406\" height=\"19\" transform=\"translate(-35.703 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_trim_init</div></foreignObject></g><g opacity=\"1\" transform=\"translate(139.094 122.5)\"><rect width=\"62.188\" height=\"39\" x=\"-31.094\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"42.188\" height=\"19\" transform=\"translate(-21.094 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_start</div></foreignObject></g></svg></p><p><strong>ç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹</strong>åœ¨<code>ramdisk.img</code>ä¸­çš„ç¨‹åºä½¿ç”¨ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä¸€èˆ¬æ˜¯<code>navy-apps/libs/libc</code>ä¸­çš„åº“å‡½æ•°ï¼Œè¿™äº›å‡½æ•°ä¼šç»è¿‡å±‚å±‚ç»•ç»•åè°ƒç”¨<code>navy-apps/libs/libos/src/nanos.c</code>ä¸­çš„ä¸€äº›å‡½æ•°ï¼Œè¿™äº›å‡½æ•°éƒ½ä¼šè°ƒç”¨<code>intptr_t _syscall_(intptr_t type, intptr_t a0, intptr_t a1, intptr_t a2)</code>ï¼Œè¿™ä¸ªå‡½æ•°ä¼šå¯¹å¯„å­˜å™¨è¿›è¡Œèµ‹å€¼å¹¶æ‰§è¡Œ<code>ecall</code>ã€‚ç„¶åä¼šè¿›å…¥<code>nexus-am/am/src/riscv32/nemu/trap.S</code>çš„<code>__am_asm_trap</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šå°†æ‰€æœ‰å¯„å­˜å™¨å‹æ ˆï¼Œå¹¶å°†æ ˆé¡¶ä½œä¸ºå‚æ•°è°ƒç”¨<code>nexus-am/am/src/riscv32/nemu/cte.c</code>ä¸­çš„<code>__am_irq_handle</code>ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨åœ¨<strong>NANOS</strong>ä¸­å®šä¹‰çš„<code>user_handler</code>ä¹Ÿå°±æ˜¯<code>nanos-lite/src/irq.c</code>ä¸­çš„<code>static _Context* do_event(_Event e, _Context* c)</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åˆä¼šè°ƒç”¨<code>nanos-lite/src/syscall.c</code>ä¸­çš„<code>_Context* do_syscall(_Context* c)</code>å‡½æ•°æ¥åœ¨æ“ä½œç³»ç»Ÿå±‚é¢å¤„ç†ã€‚</p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"917\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:1670.703125px\" viewBox=\"0 0 1670.703 917\"><defs><path id=\"b\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(1448.32 458.5)\"><rect width=\"428.766\" height=\"189\" x=\"-214.383\" y=\"-94.5\" fill=\"coral\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.188\" height=\"19\" transform=\"translate(0 -80.5) translate(-35.594 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nanos-lite</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1448.32 458.5)\"><rect width=\"378.766\" height=\"149\" x=\"-189.383\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"20.625\" height=\"19\" transform=\"translate(0 -60.5) translate(-10.313 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1352.07 458.5)\"><rect width=\"136.266\" height=\"109\" x=\"-68.133\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"33.5\" height=\"19\" transform=\"translate(0 -40.5) translate(-16.75 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">irq.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1541.453 458.5)\"><rect width=\"142.5\" height=\"109\" x=\"-71.25\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"60.406\" height=\"19\" transform=\"translate(0 -40.5) translate(-30.203 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">syscall.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(920.688 458.5)\"><rect width=\"526.5\" height=\"189\" x=\"-263.25\" y=\"-94.5\" fill=\"#6495ed\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"68.266\" height=\"19\" transform=\"translate(0 -80.5) translate(-34.133 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nexus-am</div></foreignObject></g><g opacity=\"1\" transform=\"translate(920.688 458.5)\"><rect width=\"476.5\" height=\"149\" x=\"-238.25\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"156.766\" height=\"19\" transform=\"translate(0 -60.5) translate(-78.383 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">am/src/riscv32/nemu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(799.086 458.5)\"><rect width=\"183.297\" height=\"109\" x=\"-91.648\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"43.453\" height=\"19\" transform=\"translate(0 -40.5) translate(-21.727 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">trap.S</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1037.336 458.5)\"><rect width=\"193.203\" height=\"109\" x=\"-96.602\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"36.797\" height=\"19\" transform=\"translate(0 -40.5) translate(-18.398 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cte.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(307.719 458.5)\"><rect width=\"599.438\" height=\"901\" x=\"-299.719\" y=\"-450.5\" fill=\"#7fffd4\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.469\" height=\"19\" transform=\"translate(0 -436.5) translate(-35.734 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">navy-apps</div></foreignObject></g><g opacity=\"1\" transform=\"translate(307.719 458.5)\"><rect width=\"549.438\" height=\"861\" x=\"-274.719\" y=\"-430.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"24.672\" height=\"19\" transform=\"translate(0 -416.5) translate(-12.336 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">libs</div></foreignObject></g><g opacity=\"1\" transform=\"translate(151.852 444.875)\"><rect width=\"187.703\" height=\"779.25\" x=\"-93.852\" y=\"-389.625\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"26.125\" height=\"19\" transform=\"translate(0 -375.625) translate(-13.063 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">libc</div></foreignObject></g><g opacity=\"1\" transform=\"translate(426.57 458.5)\"><rect width=\"261.734\" height=\"821\" x=\"-130.867\" y=\"-410.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"33.266\" height=\"19\" transform=\"translate(0 -396.5) translate(-16.633 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">libos</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"m157.14 429 14.761-54.417c14.76-54.416 44.281-163.25 63.208-217.666 18.927-54.417 27.26-54.417 35.594-54.417H331.852\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"m158.973 429 14.455-39.583c14.455-39.584 43.365-118.75 61.987-158.334C254.036 191.5 262.37 191.5 270.703 191.5h57.492\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#d)\" d=\"m162.745 429 13.826-24.75c13.827-24.75 41.48-74.25 59.472-99 17.993-24.75 26.327-24.75 34.66-24.75h56.094\"/><defs><marker id=\"d\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#e)\" d=\"m175.017 429 11.781-9.917c11.781-9.916 35.343-29.75 51.29-39.666 15.948-9.917 24.282-9.917 32.615-9.917h60.133\"/><defs><marker id=\"e\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#f)\" d=\"m220.703 455.836 4.167.444c4.166.444 12.5 1.332 20.833 1.776 8.333.444 16.667.444 25 .444h58.844\"/><defs><marker id=\"f\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#g)\" d=\"m170.337 468 12.561 13.25c12.561 13.25 37.683 39.75 54.41 53 16.728 13.25 25.062 13.25 33.395 13.25h56.758\"/><defs><marker id=\"g\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#h)\" d=\"m161.586 468 14.02 28.083c14.02 28.084 42.058 84.25 60.244 112.334 18.186 28.083 26.52 28.083 34.853 28.083H327.321\"/><defs><marker id=\"h\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#i)\" d=\"M158.458 468 173 510.917c14.541 42.916 43.623 128.75 62.33 171.666 18.707 42.917 27.04 42.917 35.374 42.917h50\"/><defs><marker id=\"i\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#j)\" d=\"m156.852 468 14.808 57.75c14.809 57.75 44.426 173.25 63.401 231s27.309 57.75 35.642 57.75h66.164\"/><defs><marker id=\"j\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#k)\" d=\"M387.898 102.5h6.025c6.025 0 18.074 0 34.606 56.083 16.532 56.084 37.546 168.25 48.053 224.334L487.089 439\"/><defs><marker id=\"k\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#l)\" d=\"M391.555 191.5h5.415c5.415 0 16.246 0 31.966 41.25 15.719 41.25 36.327 123.75 46.631 165L485.871 439\"/><defs><marker id=\"l\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#m)\" d=\"M392.953 280.5h5.182c5.183 0 15.547 0 30.628 26.417 15.08 26.416 34.876 79.25 44.775 105.666L483.436 439\"/><defs><marker id=\"m\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#n)\" d=\"M388.914 369.5h5.856c5.855 0 17.566 0 32.102 11.583 14.536 11.584 31.896 34.75 40.577 46.334l8.68 11.583\"/><defs><marker id=\"n\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#o)\" d=\"M390.203 458.5H449.047\"/><defs><marker id=\"o\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#p)\" d=\"M392.29 547.5h5.292c5.293 0 15.879 0 29.852-11.583 13.974-11.584 31.334-34.75 40.015-46.334l8.68-11.583\"/><defs><marker id=\"p\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#q)\" d=\"M392.43 636.5h5.27c5.269 0 15.808 0 30.975-26.417 15.168-26.416 34.964-79.25 44.863-105.666L483.436 478\"/><defs><marker id=\"q\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#r)\" d=\"M399.047 725.5h4.167c4.166 0 12.5 0 26.97-41.25 14.471-41.25 35.08-123.75 45.383-165L485.871 478\"/><defs><marker id=\"r\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#s)\" d=\"M382.883 814.5h6.86c6.861 0 20.583 0 37.95-56.083 17.368-56.084 38.382-168.25 48.889-224.334L487.089 478\"/><defs><marker id=\"s\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#t)\" d=\"M532.438 458.5h200\"/><defs><marker id=\"t\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#u)\" d=\"M865.734 458.5h100\"/><defs><marker id=\"u\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#v)\" d=\"M1108.938 458.5h200\"/><defs><marker id=\"v\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#w)\" d=\"M1395.203 458.5h100\"/><defs><marker id=\"w\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(1541.453 458.5)\"><rect width=\"92.5\" height=\"39\" x=\"-46.25\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"72.5\" height=\"19\" transform=\"translate(-36.25 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">do_syscall</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1352.07 458.5)\"><rect width=\"86.266\" height=\"39\" x=\"-43.133\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"66.266\" height=\"19\" transform=\"translate(-33.133 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">do_event</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1037.336 458.5)\"><rect width=\"143.203\" height=\"39\" x=\"-71.602\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"123.203\" height=\"19\" transform=\"translate(-61.602 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_irq_handle</div></foreignObject></g><g opacity=\"1\" transform=\"translate(799.086 458.5)\"><rect width=\"133.297\" height=\"39\" x=\"-66.648\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"113.297\" height=\"19\" transform=\"translate(-56.648 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_asm_trap</div></foreignObject></g><g opacity=\"1\" transform=\"translate(359.875 102.5)\"><rect width=\"56.047\" height=\"39\" x=\"-28.023\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"36.047\" height=\"19\" transform=\"translate(-18.023 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_exit</div></foreignObject></g><g opacity=\"1\" transform=\"translate(359.875 191.5)\"><rect width=\"63.359\" height=\"39\" x=\"-31.68\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"43.359\" height=\"19\" transform=\"translate(-21.68 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_open</div></foreignObject></g><g opacity=\"1\" transform=\"translate(359.875 280.5)\"><rect width=\"66.156\" height=\"39\" x=\"-33.078\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"46.156\" height=\"19\" transform=\"translate(-23.078 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_write</div></foreignObject></g><g opacity=\"1\" transform=\"translate(359.875 369.5)\"><rect width=\"58.078\" height=\"39\" x=\"-29.039\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"38.078\" height=\"19\" transform=\"translate(-19.04 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_sbrk</div></foreignObject></g><g opacity=\"1\" transform=\"translate(359.875 458.5)\"><rect width=\"60.656\" height=\"39\" x=\"-30.328\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"40.656\" height=\"19\" transform=\"translate(-20.328 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_read</div></foreignObject></g><g opacity=\"1\" transform=\"translate(359.875 547.5)\"><rect width=\"64.828\" height=\"39\" x=\"-32.414\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"44.828\" height=\"19\" transform=\"translate(-22.414 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_close</div></foreignObject></g><g opacity=\"1\" transform=\"translate(359.875 636.5)\"><rect width=\"65.109\" height=\"39\" x=\"-32.555\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"45.109\" height=\"19\" transform=\"translate(-22.555 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_lseek</div></foreignObject></g><g opacity=\"1\" transform=\"translate(359.875 725.5)\"><rect width=\"78.344\" height=\"39\" x=\"-39.172\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"58.344\" height=\"19\" transform=\"translate(-29.172 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_execve</div></foreignObject></g><g opacity=\"1\" transform=\"translate(359.875 814.5)\"><rect width=\"46.016\" height=\"39\" x=\"-23.008\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"26.016\" height=\"19\" transform=\"translate(-13.008 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_...</div></foreignObject></g><g opacity=\"1\" transform=\"translate(490.742 458.5)\"><rect width=\"83.391\" height=\"39\" x=\"-41.695\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"63.391\" height=\"19\" transform=\"translate(-31.695 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_syscall_</div></foreignObject></g><g opacity=\"1\" transform=\"translate(151.852 448.5)\"><rect width=\"137.703\" height=\"39\" x=\"-68.852\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"117.703\" height=\"19\" transform=\"translate(-58.852 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">printf,malloc,...</div></foreignObject></g></svg></p><p>è¿™ä¸€é˜¶æ®µï¼Œéœ€è¦å®ç°<code>nanos-lite/src/irq.c</code>ä¸­çš„äº‹ä»¶åˆ†å‘,ä»¥åŠ<code>nanos-lite/src/syscall.c</code>ä¸­çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä¸ºäº†ä½¿å¾—<code>navy-apps/tests/hello</code>èƒ½æ­£ç¡®è¾“å‡ºã€‚éœ€è¦å®ç°<code>SYS_exit</code>ï¼Œ<code>SYS_yield</code>ï¼Œ<code>SYS_write</code>ï¼Œ<code>SYS_brk</code>ï¼Œ<code>SYS_execve</code>ã€‚è¿™é‡Œé€šè¿‡<code>libc</code>ä¸­æºä»£ç æˆ‘ä»¬å¯¹<code>libc</code>ä¸­çš„<code>printf</code>åšä¸€ä¸ªç®€å•çš„åˆ†æï¼Œåœ¨è¿›å…¥æ“ä½œç³»ç»Ÿå±‚é¢å‰<code>printf</code>ä¸€å…±ä½¿ç”¨äº†13å±‚è°ƒç”¨ğŸ˜¨ WTF!</p><p><svg height=\"120\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:2321.8125px\" viewBox=\"0 0 2321.813 120\"><marker id=\"a\" fill=\"#333\" stroke=\"#333\" markerHeight=\"12\" markerUnits=\"userSpaceOnUse\" markerWidth=\"12\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><path stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></marker><marker fill=\"#333\" stroke=\"#333\" markerHeight=\"12\" markerUnits=\"userSpaceOnUse\" markerWidth=\"12\" orient=\"auto\" refX=\"0\" refY=\"5\" viewBox=\"0 0 10 10\"><path stroke-dasharray=\"1 0\" d=\"m0 5 10 5V0z\"/></marker><marker fill=\"#333\" stroke=\"#333\" markerHeight=\"11\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" orient=\"auto\" refX=\"11\" refY=\"5\" viewBox=\"0 0 10 10\"><circle cx=\"5\" cy=\"5\" r=\"5\" stroke-dasharray=\"1 0\"/></marker><marker fill=\"#333\" stroke=\"#333\" markerHeight=\"11\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" orient=\"auto\" refX=\"-1\" refY=\"5\" viewBox=\"0 0 10 10\"><circle cx=\"5\" cy=\"5\" r=\"5\" stroke-dasharray=\"1 0\"/></marker><marker fill=\"#333\" stroke=\"#333\" markerHeight=\"11\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" orient=\"auto\" refX=\"12\" refY=\"5.2\" viewBox=\"0 0 11 11\"/><marker fill=\"#333\" stroke=\"#333\" markerHeight=\"11\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" orient=\"auto\" refX=\"-1\" refY=\"5.2\" viewBox=\"0 0 11 11\"/><rect width=\"137.5\" height=\"104\" x=\"2176.313\" y=\"8\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"60.406\" height=\"19\" transform=\"translate(2214.86 13)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">syscall.c</span></div></foreignObject><rect width=\"131.266\" height=\"104\" x=\"1995.047\" y=\"8\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"33.5\" height=\"19\" transform=\"translate(2043.93 13)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">irq.c</span></div></foreignObject><rect width=\"188.203\" height=\"104\" x=\"1756.844\" y=\"8\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"36.797\" height=\"19\" transform=\"translate(1832.547 13)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">cte.c</span></div></foreignObject><rect width=\"198.391\" height=\"104\" x=\"1508.453\" y=\"8\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"43.453\" height=\"19\" transform=\"translate(1585.922 13)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">trap.S</span></div></foreignObject><rect width=\"111.156\" height=\"104\" x=\"1347.297\" y=\"8\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"33.266\" height=\"19\" transform=\"translate(1386.242 13)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">libos</span></div></foreignObject><rect width=\"1289.297\" height=\"104\" x=\"8\" y=\"8\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"26.125\" height=\"19\" transform=\"translate(639.586 13)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">libc</span></div></foreignObject><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M88.703 60h50\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M231.156 60h50\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M370.422 60h50\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M496.266 60h50\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M616.188 60h50\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M754.531 60h50\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M883.047 60h50\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M1020.516 60h50\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M1146.531 60h50\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M1272.297 60h100\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M1433.453 60h100\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M1681.844 60h100\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M1920.047 60h100\"/><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"0\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M2101.313 60h99.999\"/><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g transform=\"translate(2245.063 60)\"><rect width=\"87.5\" height=\"34\" x=\"-43.75\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"72.5\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-36.25 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">do_syscall</span></div></foreignObject></g><g transform=\"translate(2060.68 60)\"><rect width=\"81.266\" height=\"34\" x=\"-40.633\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"66.266\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-33.133 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">do_event</span></div></foreignObject></g><g transform=\"translate(1850.945 60)\"><rect width=\"138.203\" height=\"34\" x=\"-69.102\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"123.203\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-61.602 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">__am_irq_handle</span></div></foreignObject></g><g transform=\"translate(1607.648 60)\"><rect width=\"148.391\" height=\"34\" x=\"-74.195\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"133.391\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-66.695 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">__am_trap_handle</span></div></foreignObject></g><g transform=\"translate(1402.875 60)\"><rect width=\"61.156\" height=\"34\" x=\"-30.578\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"46.156\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-23.078 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">_write</span></div></foreignObject></g><g transform=\"translate(184.93 60)\"><rect width=\"92.453\" height=\"34\" x=\"-46.227\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"77.453\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-38.727 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">_vfprintf_r</span></div></foreignObject></g><g transform=\"translate(60.852 60)\"><rect width=\"55.703\" height=\"34\" x=\"-27.852\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"40.703\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-20.352 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">printf</span></div></foreignObject></g><g transform=\"translate(325.79 60)\"><rect width=\"89.266\" height=\"34\" x=\"-44.633\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"74.266\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-37.133 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">__sfputs_r</span></div></foreignObject></g><g transform=\"translate(458.344 60)\"><rect width=\"75.844\" height=\"34\" x=\"-37.922\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"60.844\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-30.422 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">_fputc_r</span></div></foreignObject></g><g transform=\"translate(581.227 60)\"><rect width=\"69.922\" height=\"34\" x=\"-34.961\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"54.922\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-27.46 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">_putc_r</span></div></foreignObject></g><g transform=\"translate(710.36 60)\"><rect width=\"88.344\" height=\"34\" x=\"-44.172\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"73.344\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-36.672 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">__swbuf_r</span></div></foreignObject></g><g transform=\"translate(843.79 60)\"><rect width=\"78.516\" height=\"34\" x=\"-39.258\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"63.516\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-31.758 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">_fflush_r</span></div></foreignObject></g><g transform=\"translate(976.781 60)\"><rect width=\"87.469\" height=\"34\" x=\"-43.734\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"72.469\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-36.234 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">__sflush_r</span></div></foreignObject></g><g transform=\"translate(1108.523 60)\"><rect width=\"76.016\" height=\"34\" x=\"-38.008\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"61.016\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-30.508 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">__swrite</span></div></foreignObject></g><g transform=\"translate(1234.414 60)\"><rect width=\"75.766\" height=\"34\" x=\"-37.883\" y=\"-17\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"60.766\" height=\"19\" color=\"#333\" style=\"text-align:center\" transform=\"translate(-30.383 -9.5)\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\">_write_r</span></div></foreignObject></g></svg></p><ol><li><code>SYS_exit</code></li></ol><p>â€‹\tç›´æ¥è°ƒç”¨<code>_halt()</code>å°±è¡Œ</p><ol start=\"2\"><li><p><code>SYS_yield</code></p><p>ç›´æ¥è°ƒç”¨<code>_yield()</code>å°±è¡Œ</p></li><li><p><code>SYS_write</code></p><p>å¯¹äº<code>fd</code>ä¸º1æˆ–è€…2ï¼Œåˆ™ç›´æ¥è¾“å‡ºåˆ°<code>stdout</code>å°±è¡Œï¼Œå½“<code>fd</code>ä¸ºå…¶å®ƒæ—¶è°ƒç”¨<code>fd_write</code>å†™å…¥åˆ°æ–‡ä»¶</p></li><li><p><code>SYS_brk</code></p><p>è¿™é‡Œæ²¡æœ‰å¤ªçœ‹æ‡‚Gitbookä¸Šçš„å†…å®¹ï¼Œæˆ‘çš„ç†è§£æ˜¯å°†<code>_heap.start</code>å¢åŠ <code>GPR2</code>ä¸ªå¤§å°ï¼Œè¿”å›ä¹‹å‰çš„<code>_heap.start</code></p><p>åæ¥é€šè¿‡é˜…è¯»<code>nexus-am/am/src/riscv32/nemu/boot/loader.ld</code>ä»¥åŠä¼Ÿå“¥çš„å¸®åŠ©ï¼Œç»ˆäºå¼„æ‡‚äº†ä¸€äº›</p><p>è¿™é‡Œæ”¾ä¸Š<code>loader.ld</code>çš„ä»£ç </p><pre><code class=\"language-c\">SECTIONS {\n  . = 0x80100000;\n  .text : {\n    *(entry)\n    *(.text)\n  }\n  etext = .;\n  _etext = .;\n  .rodata : {\n    *(.rodata*)\n  }\n  .data : {\n    *(.data)\n  }\n  edata = .;\n  _data = .;\n  .bss : {\n\t_bss_start = .;\n    *(.bss*)\n    *(.sbss*)\n    *(.scommon)\n  }\n  _stack_top = ALIGN(4096);\n  . = _stack_top + 0x8000;\n  _stack_pointer = .;\n  end = .;\n  _end = .;\n  _heap_start = ALIGN(4096);\n  _heap_end = 0x88000000;\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ç¨‹åºä¸€å…±åˆ†ä¸ºå‡ å¤§æ®µ<code>.text</code>ï¼Œ<code>.roddata</code>ï¼Œ<code>.data</code>ï¼Œ<code>.bss</code>ï¼Œ<code>.stack</code>ï¼Œ<code>.heap</code>ï¼Œå‰é¢å››æ®µåœ¨ç¼–è¯‘å®Œåå¤§å°å°±å¯ä»¥ç¡®å®šäº†ï¼Œå› æ­¤æ•´ä¸ªç¨‹åºç©ºé—´å‰©ä¸‹çš„ä½œä¸ºè¿è¡Œæ—¶å˜åŒ–çš„<code>.stack</code>å’Œ<code>.heap</code>æ®µä½¿ç”¨ã€‚æ•´ä¸ªç¨‹åºè¿è¡Œç©ºé—´å¤§å°ä¸º<code>0x880000000-0x80100000</code>ï¼Œå…¶ä¸­æ ˆå’Œå †ä»ä¸¤è¾¹åˆ†åˆ«å‘å¯¹ä¾§ç”Ÿé•¿ï¼Œç•Œé™ç”±<code>_end</code>æ§åˆ¶ã€‚ä¸ºäº†ç¡®è®¤æˆ‘ä»¬çš„æƒ³æ³•ï¼Œå¯ä»¥è§‚å¯Ÿä¸€ä¸‹<code>nexus-am/am/src/nemu-common/trm.c</code>ä¸­å¯¹<code>_heap</code>çš„å®šä¹‰</p><pre><code class=\"language-c\">/*\nnexus-am/am/src/nemu-common/trm.c\n*/\n#include &#x3C;am.h>\n#include &#x3C;nemu.h>\n\nextern char _heap_start;\nextern char _heap_end;\nint main(const char *args);\n\n_Area _heap = {\n  .start = &#x26;_heap_start,\n  .end = &#x26;_heap_end,\n};\n</code></pre><p>å¯ä»¥å‘ç°å †çš„å®šä¹‰å°±æ˜¯ä»<code>loader.ld</code>ä¸­è¯»å–<code>_heap_start</code>å’Œ<code>_heap_end</code>ã€‚å› æ­¤åœ¨<code>nanos.c</code>ä¸­è¿›è¡Œä¿®æ”¹</p><pre><code class=\"language-c\">/*\nnavy-apps/libs/libos/src/nanos.c\n*/\nextern char end;\nvoid *_sbrk(intptr_t increment) {\n  static void* program_break = (uintptr_t)&#x26;end;\n  void* old = program_break;\n  if(_syscall_(SYS_brk,program_break+increment,0,0)==0){\n    program_break += increment;\n    return old;\n  }\n  return (void*)-1;\n}\n</code></pre><p><code>syscall.c</code>ä¸­ç›¸åº”çš„å®ç°ä¸º</p><pre><code class=\"language-c\">case SYS_brk:{\n      printf(\"sys brk\\n\");\n      if(c->GPR2&#x3C;=_heap.start||c->GPR2>=_heap.end){\n        c->GPRx = -1;\n      }\n      break;\n    }\n</code></pre></li><li><p><code>SYS_execve</code></p><p>è¿™ä¸ªæ˜¯ç›´æ¥è°ƒç”¨<code>naive_loader</code>å°±å¥½äº†ï¼Œä½†æ˜¯åœ¨å®ç°<code>naive_loader</code>ï¼ˆè°ƒç”¨äº†<code>loader</code>ï¼‰çš„æ—¶å€™éœ€è¦å¯¹elfæ–‡ä»¶æ ¼å¼å¾ˆäº†è§£ï¼ˆè¿™ä¸ªæ–‡ä»¶æ ¼å¼æœ‰å¾ˆå¤šä¸åˆç†çš„åœ°æ–¹ï¼Œå†å²é—ç•™é—®é¢˜ï¼Œè€å±å±±äº†ğŸ’©ï¼‰ï¼Œå¯ä»¥çœ‹çœ‹<a href=\"https://b23.tv/afki9uB\">Bç«™ä¸Šå¯¹è¿™ä¸ªæ–‡ä»¶æ ¼å¼çš„è®²è§£</a>ï¼Œæˆ‘è¿™é‡Œå°±ç›´æ¥æä¾›æºä»£ç </p><pre><code class=\"language-c\">static uintptr_t loader(PCB *pcb, const char *filename) {\n  if(filename == NULL){\n    Elf_Ehdr ehdr;\n    ramdisk_read(&#x26;ehdr,0,sizeof(Elf_Ehdr));\n    Elf_Phdr phdr[ehdr.e_phnum];\n    ramdisk_read(phdr,ehdr.e_ehsize,sizeof(Elf_Phdr)*ehdr.e_phnum);\n    for(size_t i=0;i&#x3C;ehdr.e_phnum;++i){\n      if(phdr[i].p_type==PT_LOAD){\n        ramdisk_read((void*)phdr[i].p_vaddr,phdr[i].p_offset,phdr[i].p_memsz);\n        memset((void*)(phdr[i].p_vaddr+phdr[i].p_filesz),0,phdr[i].p_memsz-phdr[i].p_filesz);\n      }\n    }\n    return ehdr.e_entry;\n  }else{\n    int fd = fs_open(filename, 0,0);\n    Elf_Ehdr ehdr;\n    int ret = fs_read(fd, &#x26;ehdr,sizeof(Elf_Ehdr));\n    assert(ret!=-1);\n    ret = fs_lseek(fd,ehdr.e_ehsize,SEEK_SET);\n    assert(ret!=-1);\n    Elf_Phdr phdr[ehdr.e_phnum];\n    ret = fs_read(fd,phdr,sizeof(Elf_Phdr)*ehdr.e_phnum);\n    assert(ret!=-1);\n    for(size_t i=0;i&#x3C;ehdr.e_phnum;++i){\n      if(phdr[i].p_type==PT_LOAD){\n        ret = fs_lseek(fd,phdr[i].p_offset,SEEK_SET);\n        assert(ret!=-1);\n        ret = fs_read(fd,(void*)phdr[i].p_vaddr,phdr[i].p_memsz);\n        assert(ret!=-1);\n        memset((void*)(phdr[i].p_vaddr+phdr[i].p_filesz),0,phdr[i].p_memsz-phdr[i].p_filesz);\n      }\n    }\n    fs_close(fd);\n    return ehdr.e_entry;\n  }\n\n}\n</code></pre></li></ol><p>å€¼å¾—æ³¨æ„çš„æ˜¯<code>nexus-am/am/include/arc/riscv32-nemu.h</code>ä¸­å¯¹<code>struct _Context</code>çš„å®šä¹‰ä¸<code>nexus-am/am/src/riscv32/nemu/trap.S</code>ä¸­çš„å‹æ ˆé¡ºåºå¹¶ä¸ä¸€è‡´ï¼Œæ‰€ä»¥æˆ‘å¯¹<code>struct _Context</code>çš„å®šä¹‰åšäº†ä¿®æ”¹</p><h3>3.2.æ–‡ä»¶ç³»ç»Ÿ</h3><p>è¿™é‡Œä¸»è¦å®ç°çš„æ˜¯<code>nanos-lite/src/fs.c</code></p><p>è¿™é‡Œè§£é‡Šä¸€ä¸‹<code>nanos-lite/src/files.h</code>è¿™ä¸ªæ–‡ä»¶includeåœ¨<code>nanos-lite/src/fs.c</code>çš„<code>file_table</code>ä¸­ï¼Œæ‰€ä»¥æ–‡ä»¶ç³»ç»Ÿçš„æ‰€æœ‰æ–‡ä»¶åŒ…å«äº†<code>file_table</code>ä¸­çš„ä»¥åŠ<code>files.h</code>ä¸­çš„ã€‚ç”±äºæˆ‘ä»¬çš„ä¸€åˆ‡çš†æ–‡ä»¶ï¼Œæ‰€ä»¥è¿˜éœ€è¦åœ¨<code>file_table</code>ä¸­åŠ ä¸Š<code>/dev/events</code>ï¼Œ<code>/proc/dispinfo</code>ï¼Œ<code>/dev/fb</code>ï¼Œ<code>dev/fbsync</code>ï¼Œ<code>/dev/tty</code>ã€‚è¿™äº›è™šæ‹Ÿæ–‡ä»¶åˆ†åˆ«åœ¨<code>fs_read</code>ï¼Œ<code>fs_write</code>ä¸­åšç‰¹æ®Šå¤„ç†ã€‚ä¸ºäº†å¤„ç†è¿™äº›ç‰¹æ®Šæ–‡ä»¶ï¼Œæˆ‘ä»¬ä¼šç”¨åˆ°<code>nanos-lite/src/device.c</code>ä¸­çš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°åªéœ€è¦è°ƒç”¨<code>nexus-am/am/am.h</code>ä¸­çš„<code>_io_read</code>å°±å¯ä»¥å®Œæˆè®¾å¤‡çš„è¯»å†™æ“ä½œï¼Œé¡ºå¸¦æä¸€å¥ï¼Œè¿™é‡Œçš„<code>fb_write</code>çœŸçš„æ˜¯è›‹ç–¼ï¼Œåœ¨<code>_io_read</code>æ¥å£æŠŠçº¿æ€§ç©ºé—´å†™æ“ä½œæ”¹ä¸ºé•¿æ–¹å½¢å†™æ“ä½œï¼Œåœ¨<code>nexus-am/am/src/nemu-common/nemu-video.c</code>çš„<code>__am_video_write</code>å‡½æ•°ä¸­åˆè¿˜åŸæˆçº¿æ€§å†™æ“ä½œï¼Œè¿™ä¸æ˜¯é—²çš„è›‹ç–¼ä¹ˆï¼Œæ˜¯ä¸æ˜¯é—²æˆ‘ä»¬CPUå ç”¨å¤ªä½äº†æ‹‰ç‚¹CPUå ç”¨ğŸ˜…ã€‚</p><p><code>Finfo</code>ç»“æ„ä½“ä¸­éœ€è¦å¢åŠ æˆå‘˜è®°å½•æ–‡ä»¶æ‰“å¼€åçš„åç§»ä½ç½®ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œâ­åƒä¸‡ä¸è¦æŠŠæ–‡ä»¶æŒ‡é’ˆç›´æ¥è¿”å›ï¼Œç»“æ„ä½“åœ¨å‡ºå‡½æ•°æ—¶ä¼šè‡ªåŠ¨é”€æ¯ï¼Œå»ºè®®è¿”å›æ–‡ä»¶åœ¨<code>file_table</code>ä¸­çš„ç´¢å¼•ä½ç½®ã€‚</p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"791.25\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:924.65625px\" viewBox=\"0 0 924.656 791.25\"><defs><path id=\"b\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(797.813 372.25)\"><rect width=\"237.688\" height=\"654\" x=\"-118.844\" y=\"-327\" fill=\"#6495ed\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"68.266\" height=\"19\" transform=\"translate(0 -313) translate(-34.133 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nexus-am</div></foreignObject></g><g opacity=\"1\" transform=\"translate(797.813 372.25)\"><rect width=\"187.688\" height=\"614\" x=\"-93.844\" y=\"-307\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"21.688\" height=\"19\" transform=\"translate(0 -293) translate(-10.844 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">am</div></foreignObject></g><g opacity=\"1\" transform=\"translate(797.813 372.25)\"><rect width=\"137.688\" height=\"574\" x=\"-68.844\" y=\"-287\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"36.313\" height=\"19\" transform=\"translate(0 -273) translate(-18.156 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">am.h</div></foreignObject></g><g opacity=\"1\" transform=\"translate(318.484 358.625)\"><rect width=\"620.969\" height=\"701.25\" x=\"-310.484\" y=\"-350.625\" fill=\"coral\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.188\" height=\"19\" transform=\"translate(0 -336.625) translate(-35.594 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nanos-lite</div></foreignObject></g><g opacity=\"1\" transform=\"translate(318.484 358.625)\"><rect width=\"570.969\" height=\"661.25\" x=\"-285.484\" y=\"-330.625\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"20.625\" height=\"19\" transform=\"translate(0 -316.625) translate(-10.313 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(209.82 358.625)\"><rect width=\"303.641\" height=\"621.25\" x=\"-151.82\" y=\"-310.625\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"26.188\" height=\"19\" transform=\"translate(0 -296.625) translate(-13.094 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">fs.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(495.305 418.125)\"><rect width=\"167.328\" height=\"502.25\" x=\"-83.664\" y=\"-251.125\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"60.484\" height=\"19\" transform=\"translate(0 -237.125) translate(-30.242 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">device.c</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M208.094 525.75h4.166c4.167 0 12.5 0 23.343 5.375 10.842 5.375 24.194 16.125 30.87 21.5l6.675 5.375\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"M200.102 614.75h5.498c5.499 0 16.496 0 27.1-2.958 10.603-2.959 20.812-8.875 25.916-11.834l5.105-2.958\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#d)\" d=\"M178.25 102.5h9.14c9.141 0 27.423 0 45.998 24s37.444 72 46.879 96l9.435 24\"/><defs><marker id=\"d\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#e)\" d=\"M177 191.5h9.349c9.349 0 28.047 0 45.304 9.167 17.257 9.166 33.074 27.5 40.983 36.666l7.908 9.167\"/><defs><marker id=\"e\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#f)\" d=\"M199.61 347.75h5.58c5.58 0 16.742 0 30.48-10.375s30.052-31.125 38.209-41.5l8.157-10.375\"/><defs><marker id=\"f\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#g)\" d=\"M186.969 436.75h7.687c7.688 0 23.063 0 40.24-25.208 17.176-25.209 36.153-75.625 45.642-100.834l9.489-25.208\"/><defs><marker id=\"g\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#h)\" d=\"m321.586 558 6.676-5.375c6.676-5.375 20.027-16.125 30.87-21.5 10.842-5.375 19.175-5.375 27.509-5.375h54.906\"/><defs><marker id=\"h\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#i)\" d=\"m331.014 597 5.104 2.958c5.105 2.959 15.314 8.875 24.585 11.834 9.271 2.958 17.604 2.958 25.938 2.958h50\"/><defs><marker id=\"i\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#j)\" d=\"m325.532 246.5 6.018-4.167c6.018-4.166 18.054-12.5 28.24-16.666 10.184-4.167 18.517-4.167 26.85-4.167h56.032\"/><defs><marker id=\"j\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#k)\" d=\"m312.698 285.5 8.157 10.375c8.158 10.375 24.472 31.125 36.795 41.5 12.324 10.375 20.657 10.375 28.99 10.375h68.172\"/><defs><marker id=\"k\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#l)\" d=\"m304.707 285.5 9.49 25.208c9.488 25.209 28.466 75.625 42.121 100.834 13.656 25.208 21.99 25.208 30.323 25.208h52.656\"/><defs><marker id=\"l\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#m)\" d=\"m307.295 246.5 9.057-17.792c9.058-17.791 27.173-53.375 40.398-71.166 13.224-17.792 21.557-17.792 29.89-17.792H767.657\"/><defs><marker id=\"m\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#n)\" d=\"M547.938 221.5h156.031c8.333 0 16.666 0 29.57 10.375s30.378 31.125 39.115 41.5l8.737 10.375\"/><defs><marker id=\"n\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#o)\" d=\"M535.797 347.75h168.172c8.333 0 16.666 0 27.28-4.167 10.612-4.166 23.504-12.5 29.95-16.666l6.446-4.167\"/><defs><marker id=\"o\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#p)\" d=\"M551.313 436.75h152.656c8.333 0 16.666 0 30.631-19s33.56-57 43.359-76l9.798-19\"/><defs><marker id=\"p\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#q)\" d=\"M549.063 525.75h154.906c8.333 0 16.666 0 27.984 5.375 11.317 5.375 25.618 16.125 32.768 21.5l7.15 5.375\"/><defs><marker id=\"q\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#r)\" d=\"M553.969 614.75h150c8.333 0 16.666 0 26.3-2.958 9.635-2.959 20.57-8.875 26.037-11.834l5.467-2.958\"/><defs><marker id=\"r\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(797.813 139.75)\"><rect width=\"60.313\" height=\"39\" x=\"-30.156\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"40.313\" height=\"19\" transform=\"translate(-20.156 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_putc</div></foreignObject></g><g opacity=\"1\" transform=\"translate(797.813 303.25)\"><rect width=\"87.688\" height=\"39\" x=\"-43.844\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"67.688\" height=\"19\" transform=\"translate(-33.844 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_io_write</div></foreignObject></g><g opacity=\"1\" transform=\"translate(797.813 577.5)\"><rect width=\"82.203\" height=\"39\" x=\"-41.102\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"62.203\" height=\"19\" transform=\"translate(-31.102 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_io_read</div></foreignObject></g><g opacity=\"1\" transform=\"translate(495.305 525.75)\"><rect width=\"107.516\" height=\"39\" x=\"-53.758\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"87.516\" height=\"19\" transform=\"translate(-43.758 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">events_read</div></foreignObject></g><g opacity=\"1\" transform=\"translate(495.305 614.75)\"><rect width=\"117.328\" height=\"39\" x=\"-58.664\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"97.328\" height=\"19\" transform=\"translate(-48.664 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">dispinfo_read</div></foreignObject></g><g opacity=\"1\" transform=\"translate(495.305 221.5)\"><rect width=\"105.266\" height=\"39\" x=\"-52.633\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"85.266\" height=\"19\" transform=\"translate(-42.633 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">serial_write</div></foreignObject></g><g opacity=\"1\" transform=\"translate(495.305 347.75)\"><rect width=\"80.984\" height=\"39\" x=\"-40.492\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"60.984\" height=\"19\" transform=\"translate(-30.492 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">fb_write</div></foreignObject></g><g opacity=\"1\" transform=\"translate(495.305 436.75)\"><rect width=\"112.016\" height=\"39\" x=\"-56.008\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"92.016\" height=\"19\" transform=\"translate(-46.008 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">fbsync_write</div></foreignObject></g><g opacity=\"1\" transform=\"translate(297.367 577.5)\"><rect width=\"73.047\" height=\"39\" x=\"-36.523\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"53.047\" height=\"19\" transform=\"translate(-26.523 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">fs_read</div></foreignObject></g><g opacity=\"1\" transform=\"translate(145.547 525.75)\"><rect width=\"125.094\" height=\"39\" x=\"-62.547\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"105.094\" height=\"19\" transform=\"translate(-52.547 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">/proc/dispinfo</div></foreignObject></g><g opacity=\"1\" transform=\"translate(145.547 614.75)\"><rect width=\"109.109\" height=\"39\" x=\"-54.555\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"89.109\" height=\"19\" transform=\"translate(-44.555 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">/dev/events</div></foreignObject></g><g opacity=\"1\" transform=\"translate(297.367 266)\"><rect width=\"78.547\" height=\"39\" x=\"-39.273\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"58.547\" height=\"19\" transform=\"translate(-29.273 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">fs_write</div></foreignObject></g><g opacity=\"1\" transform=\"translate(145.547 102.5)\"><rect width=\"65.406\" height=\"39\" x=\"-32.703\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"45.406\" height=\"19\" transform=\"translate(-22.703 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">stdout</div></foreignObject></g><g opacity=\"1\" transform=\"translate(145.547 191.5)\"><rect width=\"62.906\" height=\"39\" x=\"-31.453\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"42.906\" height=\"19\" transform=\"translate(-21.453 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">stderr</div></foreignObject></g><g opacity=\"1\" transform=\"translate(145.547 347.75)\"><rect width=\"108.125\" height=\"39\" x=\"-54.063\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"88.125\" height=\"19\" transform=\"translate(-44.063 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">/dev/fbsync</div></foreignObject></g><g opacity=\"1\" transform=\"translate(145.547 436.75)\"><rect width=\"82.844\" height=\"39\" x=\"-41.422\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"62.844\" height=\"19\" transform=\"translate(-31.422 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">/dev/tty</div></foreignObject></g><g opacity=\"1\" transform=\"translate(145.547 763.75)\"><rect width=\"55.047\" height=\"39\" x=\"-27.523\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"35.047\" height=\"19\" transform=\"translate(-17.523 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">stdin</div></foreignObject></g></svg></p><p><strong>ç‰¹æ®Šæ–‡ä»¶è¯»å†™æƒé™</strong></p><ul><li><p>Read Only</p><p><code>/proc/dispinfo</code>ï¼Œ<code>/dev/events</code></p></li><li><p>Write Only</p><p><code>stdout</code>ï¼Œ<code>stderr</code>ï¼Œ<code>/dev/fb</code>ï¼Œ<code>/dev/fbsync</code>ï¼Œ<code>/dev/tty</code></p></li><li><p>Forbidden</p><p><code>stdin</code></p></li></ul><p><strong><code>/nanos-lite/src/fs.c</code></strong></p><ol><li><p><code>Finfo</code></p><pre><code class=\"language-c\">typedef struct {\n  char *name;\n  size_t size;\n  size_t disk_offset;\n  size_t open_offset;\n  ReadFn read;\n  WriteFn write;\n} Finfo;\n</code></pre></li><li><p><code>file_table</code></p><pre><code class=\"language-c\">static Finfo file_table[] __attribute__((used)) = {\n  {\"stdin\", 0, 0, 0,invalid_read, invalid_write},\n  {\"stdout\", 0, 0, 0,invalid_read, invalid_write},\n  {\"stderr\", 0, 0, 0,invalid_read, invalid_write},\n  {\"/dev/events\",0,0,0},\n  {\"/proc/dispinfo\",0,0,0},\n  {\"/dev/fb\",0,0,0},\n  {\"/dev/fbsync\",0,0,0},\n  {\"/dev/tty\",0,0,0},\n#include \"files.h\"\n};\n</code></pre></li><li><p><code>int fs_open(const char* pathname, int flags, int mode)</code> è®¾ç½®ç»“æ„ä½“ä¸­çš„<code>open_offset</code>ä¸º0å°±å¥½ï¼Œè¿”å›çš„<code>fd</code>æœ€å¥½ä¸æ˜¯ç»“æ„ä½“æŒ‡é’ˆï¼Œcè¯­è¨€ä¼šè›‹ç–¼çš„é”€æ¯ç»“æ„ä½“ï¼Œæœ€å¥½è¿”å›ä½ç½®ç´¢å¼•ã€‚</p></li><li><p><code>size_t fs_read(int fd, void *buf, size_t len)</code></p><p>å¯¹äºå¯è¯»ç‰¹æ®Šæ–‡ä»¶è°ƒç”¨ç›¸åº”çš„ç³»ç»Ÿå‡½æ•°å°±å¥½ï¼ˆ<code>events_read</code>ï¼Œ<code>dispinfo_read</code>ï¼‰</p></li><li><p><code>size_t fs_write(int fd, void *buf, size_t len)</code></p><p>å¯¹äºå¯å†™ç‰¹æ®Šæ–‡ä»¶è°ƒç”¨ç›¸åº”çš„ç³»ç»Ÿå‡½æ•°å°±å¥½ï¼ˆ<code>_putc</code>ï¼Œ<code>fb_write</code>ï¼Œ<code>fbsync_write</code>ï¼Œ<code>serial_write</code>ï¼‰</p></li></ol><p><strong><code>/nanos-lite/src/device.c</code></strong></p><ol><li><p><code>size_t serial_write(const void *buf, size_t offset, size_t len)</code></p><p>è°ƒç”¨<code>_putc</code>è¾“å‡ºåˆ°<code>stdout</code>ã€‚</p></li><li><p><code>size_t events_read(void *buf, size_t offset, size_t len)</code></p><p>è°ƒç”¨<code>_io_read</code>è¯»å–æŒ‰é”®å¹¶å’Œæ©ç <code>0x7fff</code>åšä¸è¿ç®—æŒ‰ç…§æ ¼å¼è¾“å‡ºåˆ°<code>buf</code>ã€‚</p></li><li><p><code>size_t dispinfo_read(void *buf, size_t offset, size_t len)</code></p><p>åœ¨<code>void init_device()</code>ä¸­ä¸€å¼€å§‹å°±åˆå§‹åŒ–<code>dispinfo</code>å­—ç¬¦ä¸²ï¼Œè¿™ä¸ªæ—¶å€™åªéœ€è¦å¤åˆ¶åˆ°<code>buf</code>é‡Œå³å¯ã€‚</p></li><li><p><code>size_t fb_write(void *buf, size_t offset, size_t len)</code></p><p>è¿™é‡Œæˆ‘å®ç°äº†å°†çº¿æ€§èµ‹å€¼å˜æˆäº†ä¸€åˆ°ä¸‰ä¸ªçŸ©å½¢ç”»å›¾ï¼Œè¿™ä¸ªè½¬æ¢çœŸçš„æ˜¯é—²çš„è›‹ç–¼ğŸ˜“ï¼Œæˆ‘ç›´æ¥æ”¾ä»£ç å¥½äº†ã€‚</p><pre><code class=\"language-c\">size_t fb_write(void *buf, size_t offset, size_t len) {\n#ifdef MULTIPROC\n  _yield();\n#endif\n  offset /=4;\n  //printf(\"fb write buf:0x%x offset:%d len:%d\\n\",buf,offset,len);\n  uint32_t * p=buf;\n  len = min(H*W-offset,len);\n  int ret = len;\n  _DEV_VIDEO_FBCTL_t ctl ;\n  ctl.pixels = p;\n  ctl.x = offset%W;\n  ctl.y =offset/W;\n  ctl.w = W-offset%W;\n  ctl.h = 1,\n  ctl.sync = 0,\n  _io_write(_DEV_VIDEO, _DEVREG_VIDEO_FBCTL, &#x26;ctl, sizeof(ctl));\n  \n  ctl.x=0;\n  ctl.y+=ctl.h;\n  len-=ctl.w*ctl.h;\n  p+=ctl.w*ctl.h;\n  if(len/W){\n    ctl.h=len/W;\n    ctl.w =W;\n    ctl.pixels=p;\n    _io_write(_DEV_VIDEO, _DEVREG_VIDEO_FBCTL, &#x26;ctl, sizeof(ctl));\n    ctl.y+=ctl.h;\n    len-=ctl.h*ctl.w;\n    p+=ctl.h*ctl.w;\n  }\n\n  if(len){\n    ctl.pixels = p;\n    ctl.w = len;\n    ctl.h = 1;\n    _io_write(_DEV_VIDEO, _DEVREG_VIDEO_FBCTL, &#x26;ctl, sizeof(ctl));\n  }\n  return ret;\n}\n</code></pre></li><li><p><code>size_t fbsync_write(const void *buf, size_t offset, size_t len)</code></p><p>è¿™é‡Œæ²¡å•¥æŠ€æœ¯å«é‡ï¼Œä»¿ç…§ä¹‹å‰çš„testé‡Œé¢çš„ä»£ç å†™ä¸€å†™å°±å¥½äº†</p><pre><code class=\"language-c\">size_t fbsync_write(const void *buf, size_t offset, size_t len) {\n _DEV_VIDEO_FBCTL_t ctl;\n ctl.pixels = NULL;\n ctl.x = ctl.y = ctl.w = ctl.h = 0;\n ctl.sync = 1;\n _io_write(_DEV_VIDEO, _DEVREG_VIDEO_FBCTL, &#x26;ctl, sizeof(ctl));\n return 0;\n}\n</code></pre></li></ol><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæˆ‘åœ¨WSLä¸­å‘ç°<code>files.h</code>çš„<code>/share/texts/num</code>æ–‡ä»¶å¤§å°æ˜¯6000å­—èŠ‚ï¼Œè€Œä¸æ˜¯5000å­—èŠ‚ï¼ŒçŒœæµ‹ä¸windowsç³»ç»Ÿåœ°<code>\\n\\r</code>æœ‰å…³ï¼Œæ‰€ä»¥åœ¨åš<code>/bin/text</code>æµ‹è¯•æ—¶ï¼Œéœ€è¦åœ¨<code>navy-apps/tests/text/text.c</code>ä¿®æ”¹æµ‹è¯•ä»£ç </p><h3>3.3æµ‹è¯•</h3><p>åœ¨<code>nanos-lite/src/proc.c</code>çš„<code>void init_proc()</code>ä¸­ï¼Œä¿®æ”¹<code>naive_load</code>çš„æ–‡ä»¶å°±å¯ä»¥äº†ï¼Œè¿™äº›æ–‡ä»¶å¯ä»¥æ˜¯<code>files.h</code>ä¸­çš„ä»»ä½•å¯æ‰§è¡Œæ–‡ä»¶ã€‚å¦‚æœéœ€è¦è¿è¡ŒPAL(ä»™å‰‘å¥‡ä¾ ä¼ ï¼Œé‚£ä¹ˆéœ€è¦ä¸‹è½½é¢å¤–æ–‡ä»¶åˆ°<code>navy-apps/apps/pal</code>)</p><h3>3.4.æ³¨æ„äº‹é¡¹</h3><ol><li><code>nexus-am/am/include/arc/riscv32-nemu.h</code>ä¸­å¯¹<code>struct _Context</code>çš„å®šä¹‰ä¸<code>nexus-am/am/src/riscv32/nemu/trap.S</code>ä¸­çš„å‹æ ˆé¡ºåºå¹¶ä¸ä¸€è‡´ï¼Œæ‰€ä»¥æˆ‘å¯¹<code>struct _Context</code>çš„å®šä¹‰åšäº†ä¿®æ”¹</li><li>åƒä¸‡ä¸è¦æŠŠæ–‡ä»¶æŒ‡é’ˆç›´æ¥è¿”å›ï¼Œç»“æ„ä½“åœ¨å‡ºå‡½æ•°æ—¶ä¼šè‡ªåŠ¨é”€æ¯ï¼Œå»ºè®®è¿”å›æ–‡ä»¶åœ¨<code>file_table</code>ä¸­çš„ç´¢å¼•ä½ç½®ã€‚</li><li>æˆ‘åœ¨WSLä¸­å‘ç°<code>files.h</code>çš„<code>/share/texts/num</code>æ–‡ä»¶å¤§å°æ˜¯6000å­—èŠ‚ï¼Œè€Œä¸æ˜¯5000å­—èŠ‚ï¼ŒçŒœæµ‹ä¸windowsç³»ç»Ÿåœ°<code>\\n\\r</code>æœ‰å…³ï¼Œæ‰€ä»¥åœ¨åš<code>/bin/text</code>æµ‹è¯•æ—¶ï¼Œéœ€è¦åœ¨<code>navy-apps/tests/text/text.c</code>ä¿®æ”¹æµ‹è¯•ä»£ç </li><li>åœ¨debugæ—¶ï¼Œå¯ä»¥ä¿®æ”¹<code>navy-apps/tests/*</code>ä¸‹çš„æ–‡ä»¶æ¥è¿›è¡Œé”™è¯¯å®šä½ï¼Œåœ¨ç¼–è¯‘åï¼Œå¯ä»¥ä½¿ç”¨<code>riscv64-unkown-elf-objdump</code>æŒ‡ä»¤æ¥åæ±‡ç¼–<code>navy-apps/fsimg/bin</code>ä¸‹çš„äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œè§‚å¯Ÿ</li></ol><hr><h2>4.PA4 NANOS-LITE pro</h2><h4>4.1.å¤šè¿›ç¨‹</h4><p>ç¨‹åºåŠ è½½æµç¨‹ä¸º</p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"369\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:1059.1875px\" viewBox=\"0 0 1059.188 369\"><defs><path id=\"b\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(219.477 266.5)\"><rect width=\"422.953\" height=\"189\" x=\"-211.477\" y=\"-94.5\" fill=\"#6495ed\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"68.266\" height=\"19\" transform=\"translate(0 -80.5) translate(-34.133 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nexus-am</div></foreignObject></g><g opacity=\"1\" transform=\"translate(219.477 266.5)\"><rect width=\"382.953\" height=\"139\" x=\"-191.477\" y=\"-69.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"156.766\" height=\"19\" transform=\"translate(0 -55.5) translate(-78.383 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">am/src/riscv32/nemu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(128.57 266.5)\"><rect width=\"161.141\" height=\"89\" x=\"-80.57\" y=\"-44.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"36.797\" height=\"19\" transform=\"translate(0 -30.5) translate(-18.398 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cte.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(310.047 266.5)\"><rect width=\"161.813\" height=\"89\" x=\"-80.906\" y=\"-44.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"43.641\" height=\"19\" transform=\"translate(0 -30.5) translate(-21.82 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">vme.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(751.07 184.5)\"><rect width=\"600.234\" height=\"353\" x=\"-300.117\" y=\"-176.5\" fill=\"coral\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.188\" height=\"19\" transform=\"translate(0 -162.5) translate(-35.594 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nanos-lite</div></foreignObject></g><g opacity=\"1\" transform=\"translate(751.07 184.5)\"><rect width=\"560.234\" height=\"303\" x=\"-280.117\" y=\"-151.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"20.625\" height=\"19\" transform=\"translate(0 -137.5) translate(-10.313 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(751.07 184.5)\"><rect width=\"520.234\" height=\"253\" x=\"-260.117\" y=\"-126.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"57.234\" height=\"19\" transform=\"translate(0 -112.5) translate(-28.617 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">loader.c</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M923.172 122v75c0 8.333 0 16.667-.936 25-.937 8.333-2.81 16.667-3.746 20.833l-.936 4.167\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"m790.54 122 6.752 4.167c6.753 4.166 20.258 12.5 27.01 20.833 6.753 8.333 6.753 16.667 6.753 25v25c0 8.333 0 16.667 8.221 25.289 8.221 8.621 24.664 17.532 32.885 21.987l8.222 4.455\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#d)\" d=\"M586.836 122v75c0 8.333 0 16.667-68.783 27.512-68.782 10.846-206.347 24.205-275.13 30.884l-68.782 6.679\"/><defs><marker id=\"d\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#e)\" d=\"m725.612 122-7.121 4.167c-7.12 4.166-21.363 12.5-28.483 20.833-7.121 8.333-7.121 16.667-7.121 25v25c0 8.333 0 16.667-54.49 27.337-54.488 10.67-163.466 23.677-217.955 30.18l-54.489 6.504\"/><defs><marker id=\"e\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(310.047 266.5)\"><rect width=\"91.813\" height=\"39\" x=\"-45.906\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"71.813\" height=\"19\" transform=\"translate(-35.906 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_ucontext</div></foreignObject></g><g opacity=\"1\" transform=\"translate(128.57 266.5)\"><rect width=\"91.141\" height=\"39\" x=\"-45.57\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"71.141\" height=\"19\" transform=\"translate(-35.57 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_kcontext</div></foreignObject></g><g opacity=\"1\" transform=\"translate(913.172 266.5)\"><rect width=\"65.578\" height=\"39\" x=\"-32.789\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"45.578\" height=\"19\" transform=\"translate(-22.79 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">loader</div></foreignObject></g><g opacity=\"1\" transform=\"translate(923.172 102.5)\"><rect width=\"106.031\" height=\"39\" x=\"-53.016\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"86.031\" height=\"19\" transform=\"translate(-43.016 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">naive_uload</div></foreignObject></g><g opacity=\"1\" transform=\"translate(586.836 102.5)\"><rect width=\"121.766\" height=\"39\" x=\"-60.883\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"101.766\" height=\"19\" transform=\"translate(-50.883 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">context_kload</div></foreignObject></g><g opacity=\"1\" transform=\"translate(758.938 102.5)\"><rect width=\"122.438\" height=\"39\" x=\"-61.219\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"102.438\" height=\"19\" transform=\"translate(-51.219 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">context_uload</div></foreignObject></g></svg></p><p>è¿›ç¨‹åˆ‡æ¢çš„æµç¨‹ä¸º</p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"334\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:1124.9375px\" viewBox=\"0 0 1124.938 334\"><defs><path id=\"b\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(907.32 102.5)\"><rect width=\"419.234\" height=\"189\" x=\"-209.617\" y=\"-94.5\" fill=\"coral\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.188\" height=\"19\" transform=\"translate(0 -80.5) translate(-35.594 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nanos-lite</div></foreignObject></g><g opacity=\"1\" transform=\"translate(907.32 102.5)\"><rect width=\"369.234\" height=\"149\" x=\"-184.617\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"20.625\" height=\"19\" transform=\"translate(0 -60.5) translate(-10.313 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(815.836 102.5)\"><rect width=\"136.266\" height=\"109\" x=\"-68.133\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"33.5\" height=\"19\" transform=\"translate(0 -40.5) translate(-16.75 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">irq.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1000.453 102.5)\"><rect width=\"132.969\" height=\"109\" x=\"-66.484\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"45.438\" height=\"19\" transform=\"translate(0 -40.5) translate(-22.719 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">proc.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(327.852 167)\"><rect width=\"639.703\" height=\"318\" x=\"-319.852\" y=\"-159\" fill=\"#6495ed\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"68.266\" height=\"19\" transform=\"translate(0 -145) translate(-34.133 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nexus-am</div></foreignObject></g><g opacity=\"1\" transform=\"translate(327.852 167)\"><rect width=\"589.703\" height=\"278\" x=\"-294.852\" y=\"-139\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"156.766\" height=\"19\" transform=\"translate(0 -125) translate(-78.383 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">am/src/riscv32/nemu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(327.852 102.5)\"><rect width=\"539.703\" height=\"109\" x=\"-269.852\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"36.797\" height=\"19\" transform=\"translate(0 -40.5) translate(-18.398 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cte.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(287.852 231.5)\"><rect width=\"183.297\" height=\"109\" x=\"-91.648\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"43.453\" height=\"19\" transform=\"translate(0 -40.5) translate(-21.727 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">trap.S</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M146.203 102.5h25c8.333 0 16.667 0 33.8 18.25 17.132 18.25 43.063 54.75 56.029 73L273.998 212\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"M354.5 231.5h4.167c4.166 0 12.5 0 20.833-21.5 8.333-21.5 16.667-64.5 25-86 8.333-21.5 16.667-21.5 20.833-21.5h4.167\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#d)\" d=\"M572.703 102.5h200\"/><defs><marker id=\"d\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#e)\" d=\"M858.969 102.5h100\"/><defs><marker id=\"e\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(1000.453 102.5)\"><rect width=\"82.969\" height=\"39\" x=\"-41.484\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"62.969\" height=\"19\" transform=\"translate(-31.484 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">schedule</div></foreignObject></g><g opacity=\"1\" transform=\"translate(815.836 102.5)\"><rect width=\"86.266\" height=\"39\" x=\"-43.133\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"66.266\" height=\"19\" transform=\"translate(-33.133 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">do_event</div></foreignObject></g><g opacity=\"1\" transform=\"translate(287.852 231.5)\"><rect width=\"133.297\" height=\"39\" x=\"-66.648\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"113.297\" height=\"19\" transform=\"translate(-56.648 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_asm_trap</div></foreignObject></g><g opacity=\"1\" transform=\"translate(114.602 102.5)\"><rect width=\"63.203\" height=\"39\" x=\"-31.602\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"43.203\" height=\"19\" transform=\"translate(-21.602 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_yield</div></foreignObject></g><g opacity=\"1\" transform=\"translate(501.102 102.5)\"><rect width=\"143.203\" height=\"39\" x=\"-71.602\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"123.203\" height=\"19\" transform=\"translate(-61.602 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_irq_handle</div></foreignObject></g></svg></p><p>æ‰€æœ‰æ¶‰åŠåˆ°çš„æ–‡ä»¶å°±ä¸€ç›®äº†ç„¶äº†</p><ol><li><p><strong><code>nexus-am/am/src/riscv32/nemu/trap.S</code></strong></p><p>é¦–å…ˆ<code>__am_irq_handle</code>éœ€è¦é‡ç½®<code>sp</code>ï¼Œå› ä¸ºåœ¨<code>__am_irq_hanlde</code>æœŸé—´ï¼Œå¦‚æœæ˜¯åˆ‡æ¢è¿›ç¨‹ï¼Œé‚£ä¹ˆ<code>Context</code>éƒ½ä¼šæ”¹å˜ï¼Œæ‰€ä»¥éœ€è¦å°†æ–°çš„<code>Context</code>å¯¼å‡ºåˆ°å¯„å­˜å™¨</p><pre><code>   mv a0, sp\n   jal __am_irq_handle\n   mv sp, a0\n</code></pre></li><li><p><strong><code>nanos-lite/src/irq.c</code></strong></p><p><code>_Context* do_event(_Event e, _Context* c)</code>å½“æ“ä½œç³»ç»Ÿæ”¶åˆ°<code>EVENT_YIELD</code>æ—¶ï¼Œéœ€è¦è°ƒç”¨<code>schedule</code>æ¥åˆ‡æ¢è¿›ç¨‹</p><pre><code class=\"language-c\">    case _EVENT_YIELD:{\n      printf(\"event yield\\n\");\n      c=schedule(c);\n      break;\n    }\n</code></pre></li><li><p><strong><code>nanos-lite/src/loader.c</code></strong></p><p>åœ¨<code>context_uload</code>ä¸­ï¼Œé¦–å…ˆä½¿ç”¨<code>loader</code>å°†ä»£ç æ®µè£…åˆ°<code>pcb</code>ï¼Œä¸åŒè¿›ç¨‹çš„ä»£ç æ˜¯ä¸åŒçš„ï¼Œç„¶åè°ƒç”¨<code>_ucontext</code>å¯¹ä¸Šä¸‹æ–‡è¿›è¡Œåˆå§‹åŒ–</p></li></ol><h3>4.2.åˆ†é¡µ</h3><p>åˆ†é¡µæœºåˆ¶å°±æ˜¯ä½¿ç”¨è™šæ‹Ÿåœ°å€è€Œä¸æ˜¯å®é™…åœ°å€æ¥ï¼Œç„¶è€Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„è™šæ‹Ÿåœ°å€éƒ½ä¼šæ˜ å°„åˆ°ç‰©ç†åœ°å€ã€‚å½“æˆ‘ä»¬éœ€è¦ä½¿ç”¨å“ªäº›è™šæ‹Ÿåœ°å€æ—¶ä¾¿ä¼šå»ºç«‹æ˜ å°„ã€‚åœ¨<code>rtl_lm</code>æˆ–è€…<code>rtl_sm</code>è®¿é—®åœ°å€çš„æ—¶å€™ä¼šæ ¹æ®ä¸€å®šç­–ç•¥æ¥å°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€ã€‚</p><p>å»ºç«‹æ˜ å°„çš„ä½ç½®æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯åœ¨ç¨‹åºåŠ è½½çš„æ—¶å€™ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶ç”³è¯·ç©ºé—´çš„æ—¶å€™ã€‚</p><h4>4.2.1 ç¨‹åºåŠ è½½</h4><p>å¯¹äºç¨‹åºåŠ è½½ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼Œ<code>nanos-lite/src/loader.c</code>ä¸­æŒ‰ç…§é¡µå¤§å°å¯¹ç¨‹åºè¿›è¡Œè¯»å– ï¼Œæ¯è¯»å–ä¸€é¡µé€šè¿‡è°ƒç”¨<code>_map</code>å»ºç«‹è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„å­˜å…¥<code>c->ptr</code>ä¸­ï¼ˆè¿™ä¸ªä¹Ÿæ˜¯é¡µç›®å½•ï¼‰ã€‚æ³¨æ„ç¼–è¯‘æ—¶éœ€è¦å°†<code>navy-apps/Makefile.compile</code>ä¸­<code>VME=enable</code>å‰çš„æ³¨é‡Šç¬¦å·å»æ‰ï¼Œè®©Makefileå°†ç¨‹åºæ˜ å°„åˆ°<code>0x40000000</code>å¼€å¤´çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚</p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"471.25\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:645.859375px\" viewBox=\"0 0 645.859 471.25\"><defs><path id=\"b\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(516.938 368.75)\"><rect width=\"241.844\" height=\"189\" x=\"-120.922\" y=\"-94.5\" fill=\"#6495ed\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"68.266\" height=\"19\" transform=\"translate(0 -80.5) translate(-34.133 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nexus-am</div></foreignObject></g><g opacity=\"1\" transform=\"translate(516.938 368.75)\"><rect width=\"191.844\" height=\"149\" x=\"-95.922\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"156.766\" height=\"19\" transform=\"translate(0 -60.5) translate(-78.383 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">am/src/riscv32/nemu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(516.938 368.75)\"><rect width=\"141.844\" height=\"109\" x=\"-70.922\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"43.641\" height=\"19\" transform=\"translate(0 -40.5) translate(-21.82 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">vme.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(322.93 131.125)\"><rect width=\"629.859\" height=\"246.25\" x=\"-314.93\" y=\"-123.125\" fill=\"coral\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.188\" height=\"19\" transform=\"translate(0 -109.125) translate(-35.594 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nanos-lite</div></foreignObject></g><g opacity=\"1\" transform=\"translate(322.93 131.125)\"><rect width=\"579.859\" height=\"206.25\" x=\"-289.93\" y=\"-103.125\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"20.625\" height=\"19\" transform=\"translate(0 -89.125) translate(-10.313 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(202.008 134.75)\"><rect width=\"288.016\" height=\"159\" x=\"-144.008\" y=\"-79.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"57.234\" height=\"19\" transform=\"translate(0 -65.5) translate(-28.617 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">loader.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(516.938 102.5)\"><rect width=\"141.844\" height=\"109\" x=\"-70.922\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"40.359\" height=\"19\" transform=\"translate(0 -40.5) translate(-20.18 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">mm.c</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M205.438 139.75h50\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"m318.479 120.25 4.59-2.958c4.589-2.959 13.768-8.875 22.524-11.834 8.756-2.958 17.09-2.958 25.423-2.958h100\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#d)\" d=\"m318.479 159.25 4.59 2.958c4.589 2.959 13.768 8.875 22.524 11.834C354.349 177 362.683 177 371.016 177h50c8.333 0 16.666 0 31.451 28.708 14.785 28.709 36.022 86.125 46.64 114.834l10.618 28.708\"/><defs><marker id=\"d\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(516.938 368.75)\"><rect width=\"59\" height=\"39\" x=\"-29.5\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"39\" height=\"19\" transform=\"translate(-19.5 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_map</div></foreignObject></g><g opacity=\"1\" transform=\"translate(516.938 102.5)\"><rect width=\"91.844\" height=\"39\" x=\"-45.922\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"71.844\" height=\"19\" transform=\"translate(-35.922 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">new_page</div></foreignObject></g><g opacity=\"1\" transform=\"translate(288.227 139.75)\"><rect width=\"65.578\" height=\"39\" x=\"-32.789\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"45.578\" height=\"19\" transform=\"translate(-22.79 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">loader</div></foreignObject></g><g opacity=\"1\" transform=\"translate(144.219 139.75)\"><rect width=\"122.438\" height=\"39\" x=\"-61.219\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"102.438\" height=\"19\" transform=\"translate(-51.219 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">context_uload</div></foreignObject></g></svg></p><ol><li><p><strong><code>static uintptr_t loader(PCB *pcb, const char *filename)</code></strong></p><p>åœ¨åŠ è½½ç¨‹åºçš„æ—¶å€™æ ¹æ®elfå°†æ¯ä¸ªå—åˆ†é¡µï¼Œè¯»å…¥åˆ†é…ç‰©ç†åœ°å€ï¼Œå¹¶è°ƒç”¨<code>_map</code>æ¥è¿›è¡Œæ˜ å°„</p></li><li><p><strong><code>int _map(_AddressSpace *as, void *va, void *pa, int prot)</code></strong></p><p>æ ¹æ®é¡µç›®å½•åŸºåœ°å€<code>as->ptr</code>ï¼Œå»ºç«‹<code>va</code>åˆ°<code>pa</code>çš„æ˜ å°„ï¼Œè¿™é‡Œæˆ‘è§„å®š<code>va</code>å’Œ<code>pa</code>éƒ½æ˜¯é¡µèµ·å§‹åœ°å€ï¼Œä¹Ÿå°±æ„å‘³ç€ä»–ä»¬çš„ä½12ä½ä¸º0</p></li></ol><h4>4.2.2.ç¨‹åºè¿è¡Œ</h4><p>åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œåƒ<code>malloc</code>ä¹‹ç±»çš„å‡½æ•°ä¼šåŠ¨æ€çš„ç”³è¯·æ–°çš„è™šæ‹Ÿåœ°å€ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦å¯¹è¿™éƒ¨åˆ†åŠ¨æ€ç”³è¯·çš„è™šæ‹Ÿåœ°å€å»ºç«‹æ˜ å°„ã€‚ç”³è¯·ç©ºé—´ä¼šè°ƒç”¨<code>SYS_brk</code>å› æ­¤åœ¨è°ƒç”¨<code>SYS_brk</code>çš„æ—¶å€™æˆ‘ä»¬åˆ†é…ç‰©ç†åœ°å€å¹¶è¿›è¡Œæ˜ å°„å°±å¥½äº†</p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"424\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:1707.734375px\" viewBox=\"0 0 1707.734 424\"><defs><path id=\"b\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(1312.852 316.5)\"><rect width=\"773.766\" height=\"199\" x=\"-386.883\" y=\"-99.5\" fill=\"coral\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.188\" height=\"19\" transform=\"translate(0 -85.5) translate(-35.594 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nanos-lite</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1312.852 316.5)\"><rect width=\"723.766\" height=\"159\" x=\"-361.883\" y=\"-79.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"20.625\" height=\"19\" transform=\"translate(0 -65.5) translate(-10.313 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1044.102 311.5)\"><rect width=\"136.266\" height=\"109\" x=\"-68.133\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"33.5\" height=\"19\" transform=\"translate(0 -40.5) translate(-16.75 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">irq.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1233.484 311.5)\"><rect width=\"142.5\" height=\"109\" x=\"-71.25\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"60.406\" height=\"19\" transform=\"translate(0 -40.5) translate(-30.203 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">syscall.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1502.234 316.5)\"><rect width=\"295\" height=\"119\" x=\"-147.5\" y=\"-59.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"40.359\" height=\"19\" transform=\"translate(0 -45.5) translate(-20.18 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">mm.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1049.602 102.5)\"><rect width=\"1300.266\" height=\"189\" x=\"-650.133\" y=\"-94.5\" fill=\"#6495ed\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"68.266\" height=\"19\" transform=\"translate(0 -80.5) translate(-34.133 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nexus-am</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1049.602 102.5)\"><rect width=\"1250.266\" height=\"149\" x=\"-625.133\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"156.766\" height=\"19\" transform=\"translate(0 -60.5) translate(-78.383 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">am/src/riscv32/nemu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(541.117 102.5)\"><rect width=\"183.297\" height=\"109\" x=\"-91.648\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"43.453\" height=\"19\" transform=\"translate(0 -40.5) translate(-21.727 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">trap.S</div></foreignObject></g><g opacity=\"1\" transform=\"translate(779.367 102.5)\"><rect width=\"193.203\" height=\"109\" x=\"-96.602\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"36.797\" height=\"19\" transform=\"translate(0 -40.5) translate(-18.398 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cte.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1578.813 102.5)\"><rect width=\"141.844\" height=\"109\" x=\"-70.922\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"43.641\" height=\"19\" transform=\"translate(0 -40.5) translate(-21.82 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">vme.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(178.734 102.5)\"><rect width=\"341.469\" height=\"189\" x=\"-170.734\" y=\"-94.5\" fill=\"#7fffd4\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.469\" height=\"19\" transform=\"translate(0 -80.5) translate(-35.734 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">navy-apps</div></foreignObject></g><g opacity=\"1\" transform=\"translate(178.734 102.5)\"><rect width=\"291.469\" height=\"149\" x=\"-145.734\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"95.328\" height=\"19\" transform=\"translate(0 -60.5) translate(-47.664 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">libs/libos/src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(178.734 102.5)\"><rect width=\"241.469\" height=\"109\" x=\"-120.734\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"54.75\" height=\"19\" transform=\"translate(0 -40.5) translate(-27.375 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nanos.c</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M141.078 102.5h50\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"M274.469 102.5h200\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#d)\" d=\"M607.766 102.5h100\"/><defs><marker id=\"d\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#e)\" d=\"M850.969 102.5h100c8.333 0 16.666 0 31.13 31.583 14.462 31.584 35.054 94.75 45.35 126.334L1037.745 292\"/><defs><marker id=\"e\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#f)\" d=\"M1087.234 311.5h100\"/><defs><marker id=\"f\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#g)\" d=\"M1279.734 311.5h100\"/><defs><marker id=\"g\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#h)\" d=\"m1457.89 317.599 4.167.65c4.167.65 12.5 1.95 20.834 2.6 8.333.651 16.666.651 25 .651h25\"/><defs><marker id=\"h\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#i)\" d=\"m1457.89 300.98 4.167-1.122c4.167-1.121 12.5-3.365 20.834-4.486 8.333-1.122 16.666-1.122 31.451-29.83 14.785-28.709 36.022-86.125 46.64-114.834L1571.6 122\"/><defs><marker id=\"i\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(1418.813 311.5)\"><rect width=\"78.156\" height=\"39\" x=\"-39.078\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"58.156\" height=\"19\" transform=\"translate(-29.078 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">mm_brk</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1578.813 321.5)\"><rect width=\"91.844\" height=\"39\" x=\"-45.922\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"71.844\" height=\"19\" transform=\"translate(-35.922 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">new_page</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1233.484 311.5)\"><rect width=\"92.5\" height=\"39\" x=\"-46.25\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"72.5\" height=\"19\" transform=\"translate(-36.25 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">do_syscall</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1044.102 311.5)\"><rect width=\"86.266\" height=\"39\" x=\"-43.133\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"66.266\" height=\"19\" transform=\"translate(-33.133 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">do_event</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1578.813 102.5)\"><rect width=\"59\" height=\"39\" x=\"-29.5\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"39\" height=\"19\" transform=\"translate(-19.5 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_map</div></foreignObject></g><g opacity=\"1\" transform=\"translate(779.367 102.5)\"><rect width=\"143.203\" height=\"39\" x=\"-71.602\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"123.203\" height=\"19\" transform=\"translate(-61.602 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_irq_handle</div></foreignObject></g><g opacity=\"1\" transform=\"translate(541.117 102.5)\"><rect width=\"133.297\" height=\"39\" x=\"-66.648\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"113.297\" height=\"19\" transform=\"translate(-56.648 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_asm_trap</div></foreignObject></g><g opacity=\"1\" transform=\"translate(232.773 102.5)\"><rect width=\"83.391\" height=\"39\" x=\"-41.695\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"63.391\" height=\"19\" transform=\"translate(-31.695 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_syscall_</div></foreignObject></g><g opacity=\"1\" transform=\"translate(112.04 102.5)\"><rect width=\"58.078\" height=\"39\" x=\"-29.039\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"38.078\" height=\"19\" transform=\"translate(-19.04 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_sbrk</div></foreignObject></g></svg></p><ol><li><p><strong><code>mm_brk(uintptr_t brk, intptr_t increment)</code></strong></p><p>ä¸º<code>[brk,brk+increment]</code>çš„è™šæ‹Ÿç©ºé—´åˆ†é…ç‰©ç†ç©ºé—´å¹¶å»ºç«‹æ˜ å°„ï¼Œå¦‚æœæœ‰çš„è™šæ‹Ÿé¡µå·²ç»å»ºç«‹æ˜ å°„åˆ™ç›´æ¥è·³è¿‡ã€‚</p></li></ol><h4>4.2.3.è¿è¡Œæ—¶è®¿å­˜</h4><p>é™¤äº†å»ºç«‹æ˜ å°„ï¼Œ åœ¨è®¿é—®æ—¶è¿˜éœ€è¦æ ¹æ®æ˜ å°„æ¥è¿›è¡Œè™šåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢ã€‚å› æ­¤è¿˜éœ€è¦åœ¨åœ°å€è®¿é—®æ—¶è¿›è¡Œè½¬åŒ–ã€‚è½¬æ¢çš„ä¾æ®æ˜¯<code>satp</code>å¯„å­˜å™¨ï¼Œæœ€é«˜ä½ä¸ºæ¨¡å¼ä¸ºï¼Œ<code>1</code>æ—¶ä¸ºå¼€å¯åˆ†é¡µï¼Œ<code>0</code>ä¸ºå…³é—­åˆ†é¡µã€‚<code>PPN</code>ä¸ºé¡µç›®å½•åŸºåœ°å€å³ç§»12ä½ï¼Œå¯ä»¥å°†<code>satp&#x3C;&#x3C;12</code>å¾—åˆ°<code>pdir</code>é¡µç›®å½•åŸºåœ°å€ã€‚</p><p><img src=\"https://s2.loli.net/2022/01/14/G7yqcMgC3nLmKOR.jpg\" alt=\"\" width=\"595\" height=\"86\" type=\"jpg\" blurdataurl=\"data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAf/xAAbEAEAAAcAAAAAAAAAAAAAAAAAAwQFBzZ1tP/EABQBAQAAAAAAAAAAAAAAAAAAAAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwC1WSxCe3VS64oAP//Z\"></p><p>åœ¨æ‰§è¡Œ<code>isa_vaddr_read</code>/<code>isa_vaddr_write</code>æ—¶ï¼Œéœ€è¦åˆ¤æ–­æ˜¯å¦å¼€å¯åˆ†é¡µ ï¼Œå¦‚æœå¼€å¯åˆ†é¡µåˆ™è°ƒç”¨<code>page_translate</code>æ¥æ˜ å°„åœ°å€å†è¿›è¡Œè¯»å–ï¼Œéœ€è¦æ³¨æ„è·¨é¡µæƒ…å†µã€‚</p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"604.75\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:577.140625px\" viewBox=\"0 0 577.141 604.75\"><defs><path id=\"b\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(288.57 302.375)\"><rect width=\"561.141\" height=\"588.75\" x=\"-280.57\" y=\"-294.375\" fill=\"#a9a9a9\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"39.5\" height=\"19\" transform=\"translate(0 -280.375) translate(-19.75 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nemu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(288.57 302.375)\"><rect width=\"511.141\" height=\"548.75\" x=\"-255.57\" y=\"-274.375\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"20.625\" height=\"19\" transform=\"translate(0 -260.375) translate(-10.313 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">src</div></foreignObject></g><g opacity=\"1\" transform=\"translate(288.57 173.375)\"><rect width=\"461.141\" height=\"250.75\" x=\"-230.57\" y=\"-125.375\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"77.641\" height=\"19\" transform=\"translate(0 -111.375) translate(-38.82 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">isa/riscv32</div></foreignObject></g><g opacity=\"1\" transform=\"translate(405.71 437.75)\"><rect width=\"226.859\" height=\"238\" x=\"-113.43\" y=\"-119\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"57.984\" height=\"19\" transform=\"translate(0 -105) translate(-28.992 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">memory</div></foreignObject></g><g opacity=\"1\" transform=\"translate(405.71 437.75)\"><rect width=\"176.859\" height=\"198\" x=\"-88.43\" y=\"-99\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"69.828\" height=\"19\" transform=\"translate(0 -85) translate(-34.914 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">memory.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(288.57 173.375)\"><rect width=\"411.141\" height=\"210.75\" x=\"-205.57\" y=\"-105.375\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"49.109\" height=\"19\" transform=\"translate(0 -91.375) translate(-24.555 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">mmu.c</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"m239.531 113.457 4.625-1.368c4.625-1.368 13.875-4.103 22.667-5.471 8.792-1.368 17.125-1.368 25.458-1.368 8.334 0 16.667 0 25 .813 8.334.813 16.667 2.438 20.834 3.251l4.166.813\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"m208.108 202 9.863-5.833c9.862-5.834 29.586-17.5 43.615-23.334C275.615 167 283.948 167 292.28 167c8.334 0 16.667 0 29.114-4.167 12.446-4.166 29.006-12.5 37.286-16.666l8.28-4.167\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#d)\" d=\"m208.108 152 9.863 5.833c9.862 5.834 29.586 17.5 43.615 23.334C275.615 187 283.948 187 292.28 187c8.334 0 16.667 0 34.178 31.125 17.512 31.125 44.202 93.375 57.546 124.5l13.345 31.125\"/><defs><marker id=\"d\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#e)\" d=\"m242.281 236.074 4.167.904c4.167.904 12.5 2.713 20.833 3.618 8.334.904 16.667.904 25 .904 8.334 0 16.667 0 34.378 36.875s44.8 110.625 58.345 147.5l13.544 36.875\"/><defs><marker id=\"e\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(405.71 393.25)\"><rect width=\"102.031\" height=\"39\" x=\"-51.016\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"82.031\" height=\"19\" transform=\"translate(-41.016 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">paddr_read</div></foreignObject></g><g opacity=\"1\" transform=\"translate(405.71 482.25)\"><rect width=\"107.516\" height=\"39\" x=\"-53.758\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"87.516\" height=\"19\" transform=\"translate(-43.758 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">paddr_write</div></foreignObject></g><g opacity=\"1\" transform=\"translate(405.71 122.5)\"><rect width=\"126.859\" height=\"39\" x=\"-63.43\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"106.859\" height=\"19\" transform=\"translate(-53.43 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">page_translate</div></foreignObject></g><g opacity=\"1\" transform=\"translate(175.14 132.5)\"><rect width=\"128.781\" height=\"39\" x=\"-64.391\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"108.781\" height=\"19\" transform=\"translate(-54.39 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">isa_vaddr_read</div></foreignObject></g><g opacity=\"1\" transform=\"translate(175.14 221.5)\"><rect width=\"134.281\" height=\"39\" x=\"-67.141\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"114.281\" height=\"19\" transform=\"translate(-57.14 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">isa_vaddr_write</div></foreignObject></g></svg></p><ol><li><strong><code>paddr_t page_translate(vaddr_t vaddr)</code></strong></li></ol><p><code>page_translate</code>å‡½æ•°å¯ä»¥æ ¹æ®ä¸‹å›¾æ¥å®ç°</p><p><img src=\"https://s2.loli.net/2022/01/14/WEHG64AdF8vrQc2.jpg\" alt=\"\" width=\"510\" height=\"425\" type=\"jpg\" blurdataurl=\"data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAEAAQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAX/xAAeEAABBAMAAwAAAAAAAAAAAAABAAIDEQQFIRIxQf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwC/Pkv0uz2UGFZilypJ/GZ7pS0uPQC4k1YuiT7PziIiD//Z\"></p><p>ä¸ºäº†å±•ç¤ºæ›´è¯¦ç»†ä¸€ç‚¹ï¼Œè¿™é‡Œæä¾›ä¸€ä¸ªç®€å•çš„å®ç°ä»£ç </p><pre><code class=\"language-c\"> uint32_t page_translate(uint32_t* pdir,uint32_t vaddr){\n     /*\n         simple version of page_translate\n         @pdir :page directory\n         @vaddr:virtual address\n     */\n     uint32_t pdx = (vaddr>>22)&#x26;0x3ff;\n     uint32_t ptx = (vaddr>>12)&#x26;0x3ff;\n     uint32_t off = vaddr&#x26;0xfff;\n     uint32_t pde = pdir[pdx];\n     assert(pde&#x26;0x1);//assert the pde is valid\n     uint32_t* ptab = (pde&#x26;~0x3ff)&#x3C;&#x3C;2;\n     uint32_t pte = ptab[ptx];\n     assert(pte&#x26;0x1);//assert the pte is valid\n     uint32_t paddr = ((pte&#x26;~0x3ff)&#x3C;&#x3C;2)|off;\n     return  paddr;\n }\n</code></pre><ol start=\"2\"><li><p><strong><code>uint32_t isa_vaddr_read(vaddr_t addr, int len)</code></strong></p><p>å¦‚æœ<code>satp.MODE</code>ä¸º1ï¼Œåˆ™ä¸ºå¼€å¯åˆ†é¡µï¼Œæ­¤æ—¶è¦åˆ¤æ–­æ˜¯å¦è·¨é¡µï¼Œå¦‚æœè·¨é¡µåˆ™åˆ†åˆ«è¯»å–å¹¶å‡­å€Ÿï¼Œå¦åˆ™ç›´æ¥é€šè¿‡<code>page_tranlsate</code>è½¬æ¢ä¸ºç‰©ç†åœ°å€è¿›è¡Œè¯»å–ã€‚å¦‚æœ<code>stap.MODE</code>ä¸º0ï¼Œåˆ™ç›´æ¥å½“åšç‰©ç†åœ°å€è¿›è¡Œè¯»å–ã€‚</p></li><li><p><strong><code>void isa_vaddr_write(vaddr_t addr, uint32_t data, int len)</code></strong></p><p>åŒç†</p></li></ol><h4>4.2.4.è¿›ç¨‹åˆ‡æ¢</h4><p>å¯¹äºä¸åŒè¿›ç¨‹åˆ‡æ¢çš„æƒ…å†µï¼Œé¡µç›®å½•åŸºåœ°å€ä¹Ÿä¼šéšä¹‹æ”¹å˜ï¼Œå› æ­¤éœ€è¦è·Ÿéšè¿›ç¨‹åˆ‡æ¢ä¸€åŒåˆ‡æ¢<code>satp</code>,åœ¨é™·å…¥åï¼Œç«‹å³å°†å½“å‰é¡µç›®å½•åŸºåœ°å€æ”¾å…¥ä¸Šä¸‹æ–‡è¿›è¡Œä¿å­˜ã€‚åœ¨æ“ä½œæ‰§è¡Œå®Œä¹‹åï¼Œç«‹å³æ›´æ–°å½“å‰çš„<code>satp</code>ï¼Œå› ä¸ºè¿›ç¨‹åˆ‡æ¢äº†ï¼Œæ‰€ä»¥<code>satp</code>è¦è·Ÿç€åˆ‡æ¢</p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"415.75\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:870.140625px\" viewBox=\"0 0 870.141 415.75\"><defs><path id=\"b\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(435.07 207.875)\"><rect width=\"854.141\" height=\"399.75\" x=\"-427.07\" y=\"-199.875\" fill=\"#6495ed\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"68.266\" height=\"19\" transform=\"translate(0 -185.875) translate(-34.133 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nexus-am</div></foreignObject></g><g opacity=\"1\" transform=\"translate(435.07 207.875)\"><rect width=\"804.141\" height=\"359.75\" x=\"-402.07\" y=\"-179.875\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"156.766\" height=\"19\" transform=\"translate(0 -165.875) translate(-78.383 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">am/src/riscv32/nemu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(287.852 102.5)\"><rect width=\"183.297\" height=\"109\" x=\"-91.648\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"43.453\" height=\"19\" transform=\"translate(0 -40.5) translate(-21.727 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">trap.S</div></foreignObject></g><g opacity=\"1\" transform=\"translate(327.852 263.75)\"><rect width=\"539.703\" height=\"173.5\" x=\"-269.852\" y=\"-86.75\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"36.797\" height=\"19\" transform=\"translate(0 -72.75) translate(-18.398 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cte.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(729.922 268.75)\"><rect width=\"164.438\" height=\"198\" x=\"-82.219\" y=\"-99\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"43.641\" height=\"19\" transform=\"translate(0 -85) translate(-21.82 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">vme.c</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M146.203 258.75h25c8.333 0 16.667 0 34.202-22.792 17.535-22.791 44.272-68.375 57.64-91.166L276.414 122\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"M354.5 102.5h4.167c4.166 0 12.5 0 20.833 27.708 8.333 27.709 16.667 83.125 25 110.834 8.333 27.708 16.667 27.708 20.833 27.708h4.167\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#d)\" d=\"m543.433 249.25 9.045-4.167c9.045-4.166 27.135-12.5 40.347-16.666 13.211-4.167 21.545-4.167 29.878-4.167h50\"/><defs><marker id=\"d\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#e)\" d=\"m543.433 288.25 9.045 4.167c9.045 4.166 27.135 12.5 40.347 16.666 13.211 4.167 21.545 4.167 29.878 4.167H673.516\"/><defs><marker id=\"e\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(729.922 224.25)\"><rect width=\"114.438\" height=\"39\" x=\"-57.219\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"94.438\" height=\"19\" transform=\"translate(-47.219 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__get_cur_as</div></foreignObject></g><g opacity=\"1\" transform=\"translate(729.922 313.25)\"><rect width=\"112.813\" height=\"39\" x=\"-56.406\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"92.813\" height=\"19\" transform=\"translate(-46.406 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_switch</div></foreignObject></g><g opacity=\"1\" transform=\"translate(114.602 258.75)\"><rect width=\"63.203\" height=\"39\" x=\"-31.602\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"43.203\" height=\"19\" transform=\"translate(-21.602 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_yield</div></foreignObject></g><g opacity=\"1\" transform=\"translate(501.102 268.75)\"><rect width=\"143.203\" height=\"39\" x=\"-71.602\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"123.203\" height=\"19\" transform=\"translate(-61.602 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_irq_handle</div></foreignObject></g><g opacity=\"1\" transform=\"translate(287.852 102.5)\"><rect width=\"133.297\" height=\"39\" x=\"-66.648\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"113.297\" height=\"19\" transform=\"translate(-56.648 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_asm_trap</div></foreignObject></g></svg></p><ol><li><p><strong><code>_Context* __am_irq_handle(_Context *c)</code></strong></p><p>åœ¨å¼€å¤´è°ƒç”¨<code>__get_cur_as</code>å°†å½“å‰çš„é¡µç›®å½•åŸºåœ°å€å­˜å‚¨å…¥å½“å‰çš„ä¸Šä¸‹æ–‡ã€‚åœ¨ç»“æŸæ—¶è°ƒç”¨<code>__am_switch</code>å°†æ–°çš„é¡µç›®å½•åŸºåœ°å€æ›´æ–°åˆ°<code>satp</code>ä¸­ã€‚</p></li></ol><h3>4.3.ä¸­æ–­</h3><p>ç»ˆç«¯ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªæµç¨‹ã€‚å…¶ä¸€æ˜¯æ—¶é’Ÿï¼Œæ—¶é’Ÿæ¯æ¬¡è¢«å”¤èµ·éƒ½ä¼šå°†<code>cpu.INTR</code>ç½®1ã€‚å…¶äºŒï¼Œ<code>cpu</code>æ¯æ¬¡æ‰§è¡Œä¸€æ¬¡<code>exec_once</code>ä¾¿ä¼šè°ƒç”¨<code>isa_query_intr</code>åˆ¤æ–­æ˜¯å¦éœ€è¦ä¸­æ–­ï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨<code>raise_intr</code>è¿›è¡Œè‡ªé™·ï¼Œæ¥è¿›è¡Œä¸­æ–­å¤„ç†ã€‚å› ä¸ºæˆ‘ä»¬ä¸æƒ³åœ¨å¤„ç†ä¸­æ–­æ—¶è¢«ä¸­æ–­ï¼Œå› æ­¤åœ¨è¿›å…¥è‡ªé™·å‰å…³æ‰ä¸­æ–­å¹¶ä¿å­˜ä¸­æ–­çŠ¶æ€<code>sstatus.PIE</code>åˆ°<code>sstatus.SIE</code>ï¼Œåœ¨å‡º<code>sret</code>æœ€åä¸€æ­¥å†è¿›è¡Œæ¢å¤ã€‚å…¶ä¸‰ï¼Œåœ¨è¿›å…¥è‡ªé™·å¤„ç†å‡½æ•°<code>__am_irq_handle</code>æ—¶éœ€è¦åˆ¤æ–­è‡ªé™·è¯±å‘åŸå› æ˜¯å¦æ˜¯æ—¶é’Ÿä¸­æ–­ï¼Œå¦‚æœæ˜¯åˆ™éœ€è¦ä¼ é€’ä¿¡æ¯ç»™äº‹ä»¶å¤„ç†å‡½æ•°<code>do_event</code></p><p><img src=\"https://s2.loli.net/2022/01/14/kw1d9YTRxKv7JZt.jpg\" alt=\"\" width=\"791\" height=\"195\" type=\"jpg\" blurdataurl=\"data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAb/xAAaEAEAAQUAAAAAAAAAAAAAAAAAAwYHN3XD/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/EABQRAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhEDEQA/AJu4+UKx2PGIAH//2Q==\"></p><p><svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"634.75\" fill=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\" font-size=\"16px\" style=\"max-width:1802.796875px\" viewBox=\"0 0 1802.797 634.75\"><defs><path id=\"b\" d=\"M0 0z\"/><path id=\"d\" stroke-dasharray=\"1 0\" d=\"m0 0 10 5-10 5z\"/></defs><g opacity=\"1\" transform=\"translate(1320.281 437.75)\"><rect width=\"476.5\" height=\"149\" x=\"-238.25\" y=\"-74.5\" fill=\"coral\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"71.188\" height=\"19\" transform=\"translate(0 -60.5) translate(-35.594 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nanos-lite</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1198.68 437.75)\"><rect width=\"183.297\" height=\"109\" x=\"-91.648\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"43.453\" height=\"19\" transform=\"translate(0 -40.5) translate(-21.727 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">trap.S</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1436.93 437.75)\"><rect width=\"193.203\" height=\"109\" x=\"-96.602\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"36.797\" height=\"19\" transform=\"translate(0 -40.5) translate(-18.398 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cte.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1701.664 437.75)\"><rect width=\"186.266\" height=\"149\" x=\"-93.133\" y=\"-74.5\" fill=\"#6495ed\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"68.266\" height=\"19\" transform=\"translate(0 -60.5) translate(-34.133 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nexus-am</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1701.664 437.75)\"><rect width=\"136.266\" height=\"109\" x=\"-68.133\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"33.5\" height=\"19\" transform=\"translate(0 -40.5) translate(-16.75 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">irq.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(520.016 317.375)\"><rect width=\"1024.031\" height=\"618.75\" x=\"-512.016\" y=\"-309.375\" fill=\"#a9a9a9\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"39.5\" height=\"19\" transform=\"translate(0 -295.375) translate(-19.75 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">nemu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(362.648 532.25)\"><rect width=\"222.516\" height=\"149\" x=\"-111.258\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"25.578\" height=\"19\" transform=\"translate(0 -60.5) translate(-12.79 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cpu</div></foreignObject></g><g opacity=\"1\" transform=\"translate(253.453 363.25)\"><rect width=\"440.906\" height=\"149\" x=\"-220.453\" y=\"-74.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"46.688\" height=\"19\" transform=\"translate(0 -60.5) translate(-23.344 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">device</div></foreignObject></g><g opacity=\"1\" transform=\"translate(765.469 308.75)\"><rect width=\"483.125\" height=\"561.5\" x=\"-241.563\" y=\"-280.75\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"77.641\" height=\"19\" transform=\"translate(0 -266.75) translate(-38.82 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">isa/riscv32</div></foreignObject></g><g opacity=\"1\" transform=\"translate(683.64 167)\"><rect width=\"269.469\" height=\"238\" x=\"-134.734\" y=\"-119\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"33.391\" height=\"19\" transform=\"translate(0 -105) translate(-16.695 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">exec</div></foreignObject></g><g opacity=\"1\" transform=\"translate(765.469 437.75)\"><rect width=\"433.125\" height=\"263.5\" x=\"-216.563\" y=\"-131.75\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"37.531\" height=\"19\" transform=\"translate(0 -117.75) translate(-18.766 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">intr.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(683.64 167)\"><rect width=\"219.469\" height=\"198\" x=\"-109.734\" y=\"-99\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"63\" height=\"19\" transform=\"translate(0 -85) translate(-31.5 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">system.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(129.695 363.25)\"><rect width=\"143.391\" height=\"109\" x=\"-71.695\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"50.797\" height=\"19\" transform=\"translate(0 -40.5) translate(-25.398 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">timer.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(362.648 363.25)\"><rect width=\"172.516\" height=\"109\" x=\"-86.258\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"45.922\" height=\"19\" transform=\"translate(0 -40.5) translate(-22.96 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">_intr.c</div></foreignObject></g><g opacity=\"1\" transform=\"translate(362.648 532.25)\"><rect width=\"172.516\" height=\"109\" x=\"-86.258\" y=\"-54.5\" fill=\"#ffffde\" stroke=\"#aa3\" stroke-width=\"1px\"/><foreignObject width=\"39.375\" height=\"19\" transform=\"translate(0 -40.5) translate(-19.688 -9.5)\" color=\"#333\" font-family=\"&#x22;trebuchet ms&#x22;,verdana,arial,sans-serif\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">cpu.c</div></foreignObject></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"3\" stroke-width=\"2px\" marker-end=\"url(#a)\" d=\"M423.906 363.25h125c8.334 0 16.667 0 34.902 10.833 18.235 10.834 46.372 32.5 60.44 43.334l14.07 10.833\"/><defs><marker id=\"a\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#c)\" d=\"M176.39 363.25h125.001\"/><defs><marker id=\"c\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#d\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#e)\" d=\"M768.375 122.5h25c8.333 0 16.667 0 25 36.792 8.333 36.791 16.667 110.375 30.004 159.666 13.337 49.292 31.678 74.292 40.848 86.792l9.17 12.5\"/><defs><marker id=\"e\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#d\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#f)\" d=\"M410.531 532.25h138.376c8.333 0 16.666 0 34.901-10.833 18.235-10.834 46.372-32.5 60.44-43.334l14.07-10.833\"/><defs><marker id=\"f\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#d\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#g)\" d=\"M744.938 447.75H818.375c8.333 0 16.667 0 25-.601 8.333-.601 16.667-1.803 20.833-2.404l4.167-.601\"/><defs><marker id=\"g\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#d\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-dasharray=\"3\" stroke-width=\"2px\" marker-end=\"url(#h)\" d=\"M957.031 437.75h175\"/><defs><marker id=\"h\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#b\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#i)\" d=\"M1265.328 437.75h100\"/><defs><marker id=\"i\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#d\" stroke-dasharray=\"1 0\"/></marker></defs></g><g opacity=\"1\"><path fill=\"none\" stroke=\"#333\" stroke-width=\"2px\" marker-end=\"url(#j)\" d=\"M1508.531 437.75h150\"/><defs><marker id=\"j\" markerHeight=\"6\" markerUnits=\"strokeWidth\" markerWidth=\"8\" orient=\"auto\" refX=\"9\" refY=\"5\" viewBox=\"0 0 10 10\"><use xlink:href=\"#d\" stroke-dasharray=\"1 0\"/></marker></defs></g><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><foreignObject width=\"0\" height=\"0\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\"><span fill=\"#333\" color=\"#333\" style=\"background-color:#e8e8e8;text-align:center\"></span></div></foreignObject><g opacity=\"1\" transform=\"translate(1436.93 437.75)\"><rect width=\"143.203\" height=\"39\" x=\"-71.602\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"123.203\" height=\"19\" transform=\"translate(-61.602 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_irq_handle</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1198.68 437.75)\"><rect width=\"133.297\" height=\"39\" x=\"-66.648\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"113.297\" height=\"19\" transform=\"translate(-56.648 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">__am_asm_trap</div></foreignObject></g><g opacity=\"1\" transform=\"translate(1701.664 437.75)\"><rect width=\"86.266\" height=\"39\" x=\"-43.133\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"66.266\" height=\"19\" transform=\"translate(-33.133 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">do_event</div></foreignObject></g><g opacity=\"1\" transform=\"translate(912.703 437.75)\"><rect width=\"88.656\" height=\"39\" x=\"-44.328\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"68.656\" height=\"19\" transform=\"translate(-34.328 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">raise_intr</div></foreignObject></g><g opacity=\"1\" transform=\"translate(683.64 447.75)\"><rect width=\"122.594\" height=\"39\" x=\"-61.297\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"102.594\" height=\"19\" transform=\"translate(-51.297 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">isa_query_intr</div></foreignObject></g><g opacity=\"1\" transform=\"translate(683.64 122.5)\"><rect width=\"169.469\" height=\"39\" x=\"-84.734\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"149.469\" height=\"19\" transform=\"translate(-74.734 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">make_EHelper(ecall)</div></foreignObject></g><g opacity=\"1\" transform=\"translate(683.64 211.5)\"><rect width=\"162.734\" height=\"39\" x=\"-81.367\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"142.734\" height=\"19\" transform=\"translate(-71.367 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">make_EHelper(sret)</div></foreignObject></g><g opacity=\"1\" transform=\"translate(362.648 363.25)\"><rect width=\"122.516\" height=\"39\" x=\"-61.258\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"102.516\" height=\"19\" transform=\"translate(-51.258 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">dev_raise_intr</div></foreignObject></g><g opacity=\"1\" transform=\"translate(129.695 363.25)\"><rect width=\"93.391\" height=\"39\" x=\"-46.695\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"73.391\" height=\"19\" transform=\"translate(-36.695 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">timer_intr</div></foreignObject></g><g opacity=\"1\" transform=\"translate(362.648 532.25)\"><rect width=\"95.766\" height=\"39\" x=\"-47.883\" y=\"-19.5\" fill=\"#ececff\" stroke=\"#9370db\" stroke-width=\"1px\" rx=\"0\" ry=\"0\"/><foreignObject width=\"75.766\" height=\"19\" transform=\"translate(-37.883 -9.5)\" color=\"#333\" style=\"text-align:center\"><div xmlns=\"http://www.w3.org/1999/xhtml\" display=\"inline-block\" style=\"white-space:nowrap\">exec_once</div></foreignObject></g></svg></p><p>ç”±äºæ—¶é—´åŸå› ï¼Œè¿™ä¸ªé˜¶æ®µè™½ç„¶ä»£ç å·²ç»å®ç°ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰bugã€‚</p><hr><h2>5.PA5 PAL pro</h2><h3>5.1.æµ®ç‚¹æ•°</h3><p>å®ç°<code>navy-app/apps/pal/include/FLOAT.h</code>å’Œ<code>navy-apps/apps/src/FLOAT/FLOAT.c</code>å°±å¯ä»¥äº†</p><pre><code class=\"language-c\">//navy-app/apps/pal/include/FLOAT.h\nstatic inline int F2int(FLOAT a) {return (a &#x26;= 0xffff0000)>>16;}\nstatic inline FLOAT int2F(int a) {return a &#x3C;&#x3C; 16;}\nstatic inline FLOAT F_mul_int(FLOAT a, int b) {return a * b;}\nstatic inline FLOAT F_div_int(FLOAT a, int b) {return a / b;}\n</code></pre><pre><code class=\"language-c\">//navy-apps/apps/src/FLOAT/FLOAT.c\nFLOAT F_mul_F(FLOAT a, FLOAT b) {\n\tlong long c = (long long)a * (long long)b;\n\treturn (FLOAT)(c >> 16);\n}\n\nFLOAT F_div_F(FLOAT a, FLOAT b) {\n\tFLOAT p, q;\n\tasm volatile(\"idiv %2\" : \"=a\"(p), \"=d\"(q) : \"r\"(b), \"a\"(a &#x3C;&#x3C; 16), \"d\"(a >> 16));\n\treturn p;\n}\n\nFLOAT f2F(float a) {\n\tint b = *(int *)&#x26;a;\n\tint sign = b >> 31;\n\tint exp = (b >> 23) &#x26; 0xff;\n\tFLOAT c = b &#x26; 0x7fffff;\n\tif (exp != 0) {\n\t\tc += 1 &#x3C;&#x3C; 23;\n\t}\n\texp -= 150;\n\tif (exp &#x3C; -16) {\n\t\tc >>= -16 - exp;\n\t}\n\tif (exp > -16) {\n\t\tc &#x3C;&#x3C;= exp + 16;\n\t}\n\treturn sign == 0 ? c : -c;\n}\n\nFLOAT Fabs(FLOAT a) {\n\tFLOAT b;\n\tif (a > 0){\n\t\tb = a;\n\t} else {\n\t\tb = -a;\n\t}\n\treturn b;\n}\n</code></pre><h3>5.2.JIT</h3><p>è¿™è®©ğŸ‘´æ€ä¹ˆå®ç°å•ŠğŸ˜…ï¼Œçœ‹çœ‹å¾—äº†ï¼Œæ„Ÿè§‰é¾™èŠ¯è¯´ç”¨LoongArchè·‘x86ä¹Ÿæ˜¯è·Ÿè¿™ä¸ªä¸€æ ·ï¼Œåšæ±‡ç¼–çº§åˆ«çš„ç¿»è¯‘ã€‚</p><hr>","renderType":"md","imageProps":{"src":"https://s2.loli.net/2022/05/21/irBOsuSDxvUzG6X.png","width":841,"height":1196,"type":"png","blurDataURL":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAAECAIAAADETxJQAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAMUlEQVQImWOYuO1/66SNdjZODP///b9+ZM/ZZd0MWbUzxWT0VDVsGHyjCzn5FRkYZAGWiQ/0yjg/IQAAAABJRU5ErkJggg=="},"language":"en"},"__N_SSG":true}